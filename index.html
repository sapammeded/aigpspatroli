<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8">
  <title>CYBER PATROL V2 — HYBRID</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">

  <!--
    ==========================================================
    CYBER PATROL V2 — HYBRID SINGLE HTML (STEP: 1–4 AKTIF)
    ==========================================================
    FEATURE MAP:
    0. Config & Global State
    1. Utils (helper umum)
    2. Firebase (auth anon + realtime db)
    3. GPS V2 (auto start + mode normal/aggressive/battery)
    4. Panic V2 (local status + /alerts/{uid})
    5. Area Manager V2 (tambah area, data dasar)
    6. Chat V2 (dummy lokal)
    7. UI Module (tabs, mode badge)

    BARU DI STEP INI:
    8. Photo Module V2 (foto per area + gallery + Cloudinary siap)
    9. AI Module V2 (deskripsi area via endpoint AI)
    10. QR Module V2 (generate QR + scan kamera)
    11. PDF Module V2 (export PDF cover + area + 1 foto/area + watermark)
    12. App Init (auto tanggal, auto GPS, binding semua fitur)
  -->

  <!-- ICON FONT -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <!-- FIREBASE (CDN) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <!-- QR LIBS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jsqr/1.4.0/jsQR.min.js"></script>

  <!-- jsPDF for PDF export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    :root{
      --bg:#020617;
      --bg-elev:#020818;
      --card:#020617;
      --panel:#020617;
      --border:#1f2937;
      --accent:#00e6ff;
      --accent-soft:rgba(0,230,255,0.12);
      --accent-strong:rgba(0,230,255,0.35);
      --text:#e5e7eb;
      --muted:#9ca3af;
      --danger:#ef4444;
      --success:#10b981;
      --panic:#ff0055;
      --panic-soft:rgba(255,0,85,0.15);
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
      background:radial-gradient(circle at top,#020617 0,#020617 40%,#000 100%);
      color:var(--text);
      min-height:100vh;
      display:flex;
      flex-direction:column;
    }

    /* HEADER */
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:10px 14px;
      border-bottom:1px solid var(--border);
      background:linear-gradient(90deg,#020617,#020617 30%,#020617 60%,#020617);
      position:relative;
      overflow:hidden;
    }
    .topbar::before{
      content:'';
      position:absolute;
      inset:-40%;
      background:conic-gradient(from 180deg,rgba(0,230,255,0.16),transparent,rgba(0,255,136,0.08),transparent);
      mix-blend-mode:screen;
      opacity:.6;
      animation:spinGlow 18s linear infinite;
      pointer-events:none;
    }
    @keyframes spinGlow{
      to{transform:rotate(360deg);}
    }
    .brand{
      position:relative;
      z-index:1;
      font-weight:800;
      letter-spacing:.08em;
      font-size:13px;
      text-transform:uppercase;
      color:var(--accent);
      display:flex;
      align-items:center;
      gap:8px;
    }
    .brand span.logo-dot{
      width:9px;
      height:9px;
      border-radius:50%;
      background:var(--accent);
      box-shadow:0 0 12px var(--accent);
    }
    .brand small{
      font-weight:500;
      color:var(--muted);
      letter-spacing:.06em;
    }
    .top-right{
      position:relative;
      z-index:1;
      display:flex;
      align-items:center;
      gap:10px;
      font-size:11px;
    }
    .badge-mode{
      padding:4px 8px;
      border-radius:999px;
      border:1px solid var(--accent-strong);
      background:rgba(0,0,0,0.6);
      display:flex;
      align-items:center;
      gap:6px;
      font-weight:600;
    }
    .badge-dot{
      width:8px;height:8px;border-radius:50%;
      background:var(--success);
      box-shadow:0 0 8px rgba(16,185,129,.9);
    }
    .btn-ghost{
      border-radius:999px;
      border:1px solid var(--border);
      background:rgba(15,23,42,0.85);
      padding:6px 10px;
      color:var(--muted);
      font-size:11px;
      display:flex;
      align-items:center;
      gap:6px;
      cursor:pointer;
    }
    .btn-ghost i{font-size:11px;}
    .btn-ghost:hover{
      border-color:var(--accent-strong);
      color:var(--accent);
    }

    /* LAYOUT */
    .shell{
      flex:1;
      display:flex;
      min-height:0;
      padding:10px;
      gap:10px;
    }
    .sidebar{
      width:280px;
      max-width:100%;
      background:radial-gradient(circle at top,#020617,#020617 55%,#020617);
      border-radius:14px;
      border:1px solid var(--border);
      padding:10px;
      display:flex;
      flex-direction:column;
      gap:10px;
      box-shadow:0 0 40px rgba(0,0,0,0.75);
    }
    .main{
      flex:1;
      min-width:0;
      background:radial-gradient(circle at top,#020617,#020617 55%,#020617);
      border-radius:14px;
      border:1px solid var(--border);
      padding:10px;
      display:flex;
      flex-direction:column;
      gap:10px;
      box-shadow:0 0 40px rgba(0,0,0,0.75);
    }

    /* TABS (SIDEBAR) */
    .side-tabs{
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:6px;
    }
    .side-tab{
      border-radius:10px;
      border:1px solid var(--border);
      padding:7px 8px;
      font-size:11px;
      display:flex;
      align-items:center;
      gap:6px;
      cursor:pointer;
      background:rgba(15,23,42,0.9);
      color:var(--muted);
    }
    .side-tab i{font-size:12px;}
    .side-tab.active{
      border-color:var(--accent-strong);
      background:linear-gradient(135deg,rgba(0,230,255,0.16),rgba(15,23,42,0.98));
      color:var(--accent);
      box-shadow:0 0 15px rgba(0,230,255,0.25);
    }

    .panel-block{
      border-radius:12px;
      border:1px solid var(--border);
      padding:9px;
      background:rgba(15,23,42,0.92);
    }
    .panel-title{
      font-size:11px;
      font-weight:600;
      letter-spacing:.08em;
      text-transform:uppercase;
      color:var(--muted);
      display:flex;
      align-items:center;
      gap:6px;
      margin-bottom:6px;
    }
    .panel-title i{font-size:11px;color:var(--accent);}
    .field-label{
      font-size:11px;
      margin-bottom:2px;
      color:var(--muted);
    }
    .field-input, .field-select{
      width:100%;
      border-radius:8px;
      border:1px solid var(--border);
      padding:7px 8px;
      background:#020617;
      color:var(--text);
      font-size:12px;
    }
    .field-input:focus, .field-select:focus{
      outline:none;
      border-color:var(--accent-strong);
      box-shadow:0 0 0 1px var(--accent-soft);
    }
    .muted{
      font-size:11px;
      color:var(--muted);
    }

    .btn-solid{
      border-radius:9px;
      border:none;
      padding:7px 10px;
      font-size:12px;
      font-weight:600;
      display:inline-flex;
      align-items:center;
      gap:6px;
      cursor:pointer;
      background:linear-gradient(135deg,#00e6ff,#00b7ff);
      color:#020617;
      box-shadow:0 8px 22px rgba(0,230,255,0.3);
    }
    .btn-solid.panic{
      background:linear-gradient(135deg,#ff0055,#ff3366);
      color:#fff;
      box-shadow:0 0 22px rgba(255,0,85,0.7);
    }
    .btn-solid.secondary{
      background:linear-gradient(135deg,#6b7280,#4b5563);
      color:#e5e7eb;
      box-shadow:none;
    }
    .btn-row{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-top:6px;
    }

    .btn-mini{
      border-radius:999px;
      border:1px solid var(--border);
      background:rgba(15,23,42,0.95);
      color:var(--muted);
      font-size:10px;
      padding:4px 8px;
      display:inline-flex;
      align-items:center;
      gap:4px;
      cursor:pointer;
    }
    .btn-mini i{font-size:10px;}
    .btn-mini:hover{
      border-color:var(--accent-strong);
      color:var(--accent);
    }

    /* MAIN TABS */
    .main-tabs{
      display:flex;
      gap:6px;
      flex-wrap:wrap;
    }
    .main-tab{
      border-radius:999px;
      padding:6px 12px;
      font-size:11px;
      border:1px solid var(--border);
      background:rgba(15,23,42,0.9);
      color:var(--muted);
      cursor:pointer;
      display:flex;
      align-items:center;
      gap:6px;
    }
    .main-tab i{font-size:11px;}
    .main-tab.active{
      border-color:var(--accent-strong);
      color:var(--accent);
      box-shadow:0 0 15px rgba(0,230,255,0.25);
      background:linear-gradient(135deg,rgba(0,230,255,0.16),rgba(15,23,42,0.98));
    }

    .main-section{
      display:none;
      flex:1;
      min-height:0;
      border-radius:11px;
      border:1px solid var(--border);
      background:rgba(15,23,42,0.95);
      padding:10px;
      overflow:auto;
    }
    .main-section.active{display:flex;flex-direction:column;}

    /* PANIC CARD */
    .panic-card{
      border-radius:12px;
      border:1px solid var(--panic-soft);
      background:radial-gradient(circle at top,var(--panic-soft),rgba(15,23,42,0.96));
      padding:10px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .panic-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:6px;
    }
    .panic-title{
      font-size:11px;
      letter-spacing:.18em;
      text-transform:uppercase;
      color:var(--panic);
      display:flex;
      align-items:center;
      gap:6px;
      font-weight:700;
    }
    .panic-indicator{
      width:9px;height:9px;border-radius:50%;
      background:var(--panic);
      box-shadow:0 0 11px rgba(255,0,85,0.9);
    }
    .panic-status{
      font-size:11px;
      color:var(--muted);
    }
    .panic-status span{
      font-weight:600;
    }
    .panic-blink{
      animation:panicPulse .8s linear infinite;
    }
    @keyframes panicPulse{
      0%,100%{
        box-shadow:0 0 0 0 rgba(255,0,85,0.7);
        transform:translateY(0);
      }
      50%{
        box-shadow:0 0 15px 0 rgba(255,0,85,1);
        transform:translateY(-1px);
      }
    }

    /* AREA LIST */
    .area-list{
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .area-item{
      border-radius:10px;
      border:1px solid var(--border);
      background:rgba(15,23,42,0.92);
      padding:8px;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .area-top{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
    }
    .area-chip{
      padding:3px 7px;
      border-radius:999px;
      font-size:10px;
      border:1px solid var(--accent-strong);
      color:var(--accent);
      display:inline-flex;
      align-items:center;
      gap:5px;
    }
    .area-name{font-size:13px;font-weight:600;}
    .area-meta{font-size:11px;color:var(--muted);}
    .area-actions{
      display:flex;
      gap:6px;
      flex-wrap:wrap;
    }
    .area-photos{
      display:flex;
      gap:6px;
      flex-wrap:wrap;
      margin-top:4px;
    }
    .area-photo-thumb{
      width:60px;
      height:60px;
      border-radius:8px;
      overflow:hidden;
      border:1px solid var(--border);
      position:relative;
      background:#020617;
    }
    .area-photo-thumb img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }
    .area-photo-thumb span{
      position:absolute;
      bottom:2px;
      right:4px;
      font-size:9px;
      background:rgba(0,0,0,0.7);
      padding:1px 4px;
      border-radius:999px;
      color:var(--muted);
    }
    .area-ai{
      font-size:11px;
      color:var(--muted);
      margin-top:2px;
    }

    /* CHAT SECTION SIMPLE */
    .chat-window{
      flex:1;
      display:flex;
      flex-direction:column;
      border-radius:10px;
      border:1px solid var(--border);
      background:rgba(2,6,23,0.85);
      overflow:hidden;
    }
    .chat-messages{
      flex:1;
      padding:8px;
      overflow:auto;
      font-size:12px;
    }
    .chat-row{
      margin-bottom:6px;
      max-width:80%;
      padding:6px 8px;
      border-radius:8px;
      position:relative;
    }
    .chat-row.me{
      margin-left:auto;
      background:rgba(0,230,255,0.11);
      border:1px solid rgba(0,230,255,0.4);
    }
    .chat-row.other{
      margin-right:auto;
      background:rgba(15,23,42,0.9);
      border:1px solid var(--border);
    }
    .chat-meta{
      font-size:9px;
      color:var(--muted);
      margin-top:2px;
    }
    .chat-input-row{
      display:flex;
      gap:6px;
      padding:6px;
      border-top:1px solid var(--border);
      background:rgba(15,23,42,0.96);
    }
    .chat-input{
      flex:1;
      border-radius:999px;
      border:1px solid var(--border);
      padding:6px 10px;
      background:#020617;
      color:var(--text);
      font-size:12px;
    }

    /* GPS MINI STATUS */
    .gps-pill{
      display:inline-flex;
      align-items:center;
      gap:5px;
      font-size:11px;
      padding:3px 7px;
      border-radius:999px;
      border:1px solid var(--border);
      background:rgba(15,23,42,0.9);
      color:var(--muted);
    }
    .gps-pill span.dot{
      width:7px;height:7px;border-radius:999px;
      background:#6b7280;
    }
    .gps-pill.active span.dot{
      background:#22c55e;
      box-shadow:0 0 8px rgba(34,197,94,0.9);
    }

    /* QR */
    #qrScannerCanvas{
      border-radius:10px;
      width:100%;
      max-width:320px;
      background:#000;
    }
    #qrVideo{
      width:100%;
      max-width:320px;
      border-radius:10px;
      background:#000;
    }

    /* RESPONSIVE */
    @media(max-width:900px){
      .shell{flex-direction:column;}
      .sidebar{width:100%;}
    }
  </style>
</head>
<body>
  <!-- HIDDEN FILE INPUT UNTUK FOTO -->
  <input type="file" id="hiddenPhotoInput" accept="image/*" style="display:none;">

  <!-- HEADER -->
  <header class="topbar">
    <div class="brand">
      <span class="logo-dot"></span>
      CYBER PATROL V2
      <small>SECURE HYBRID CLIENT</small>
    </div>
    <div class="top-right">
      <div class="gps-pill" id="gpsStatusPill">
        <span class="dot"></span>
        <span id="gpsStatusText">GPS: Idle</span>
      </div>
      <div class="badge-mode" id="modeBadge">
        <span class="badge-dot"></span>
        <span id="modeText">MODE: USER</span>
      </div>
      <button class="btn-ghost" id="btnToggleMode">
        <i class="fas fa-user-shield"></i>
        <span id="btnToggleModeText">Masuk Admin</span>
      </button>
    </div>
  </header>

  <main class="shell">
    <!-- SIDEBAR -->
    <aside class="sidebar">
      <div class="side-tabs">
        <div class="side-tab active" data-side="info">
          <i class="fas fa-id-card"></i>
          <span>Identitas</span>
        </div>
        <div class="side-tab" data-side="checkpoint">
          <i class="fas fa-qrcode"></i>
          <span>Checkpoint</span>
        </div>
        <div class="side-tab" data-side="settings">
          <i class="fas fa-sliders"></i>
          <span>Settings</span>
        </div>
        <div class="side-tab" data-side="deep">
          <i class="fas fa-bomb"></i>
          <span>Deep Clean</span>
        </div>
      </div>

      <!-- PANEL: IDENTITAS / DASAR -->
      <section class="panel-block" data-side-panel="info">
        <div class="panel-title">
          <i class="fas fa-user-tie"></i> DATA PETUGAS
        </div>
        <label class="field-label">Nama Petugas</label>
        <input id="fieldName" class="field-input" placeholder="Nama lengkap...">

        <label class="field-label" style="margin-top:6px;">Shift</label>
        <select id="fieldShift" class="field-select">
          <option value="">Pilih shift...</option>
          <option value="Pagi">Pagi</option>
          <option value="Siang">Siang</option>
          <option value="Malam">Malam</option>
        </select>

        <!-- TANGGAL PATROLI -->
        <label class="field-label" style="margin-top:6px;">Tanggal Patroli</label>
        <div style="display:flex;gap:6px;flex-wrap:wrap;">
          <select id="fieldTanggal" class="field-select" style="flex:1;min-width:70px;">
            <option value="">Tgl</option>
            <option value="1">1</option><option value="2">2</option><option value="3">3</option>
            <option value="4">4</option><option value="5">5</option><option value="6">6</option>
            <option value="7">7</option><option value="8">8</option><option value="9">9</option>
            <option value="10">10</option><option value="11">11</option><option value="12">12</option>
            <option value="13">13</option><option value="14">14</option><option value="15">15</option>
            <option value="16">16</option><option value="17">17</option><option value="18">18</option>
            <option value="19">19</option><option value="20">20</option><option value="21">21</option>
            <option value="22">22</option><option value="23">23</option><option value="24">24</option>
            <option value="25">25</option><option value="26">26</option><option value="27">27</option>
            <option value="28">28</option><option value="29">29</option><option value="30">30</option>
            <option value="31">31</option>
          </select>

          <select id="fieldBulan" class="field-select" style="flex:1;min-width:100px;">
            <option value="">Bulan</option>
            <option value="01">Januari</option>
            <option value="02">Februari</option>
            <option value="03">Maret</option>
            <option value="04">April</option>
            <option value="05">Mei</option>
            <option value="06">Juni</option>
            <option value="07">Juli</option>
            <option value="08">Agustus</option>
            <option value="09">September</option>
            <option value="10">Oktober</option>
            <option value="11">November</option>
            <option value="12">Desember</option>
          </select>

          <select id="fieldTahun" class="field-select" style="flex:1;min-width:90px;">
            <option value="">Tahun</option>
            <option value="2024">2024</option>
            <option value="2025">2025</option>
            <option value="2026">2026</option>
            <option value="2027">2027</option>
            <option value="2028">2028</option>
            <option value="2029">2029</option>
            <option value="2030">2030</option>
          </select>
        </div>

        <div style="margin-top:6px;">
          <div class="field-label">Lokasi (cover PDF)</div>
          <input id="fieldLokasi" class="field-input" placeholder="Contoh: SEI JKT11">
          <p class="muted" style="margin-top:4px;">
            Kosongkan jika mau pakai GPS otomatis.
          </p>
        </div>

        <hr style="border:none;border-top:1px solid var(--border);margin:8px 0;">

        <div class="panel-title">
          <i class="fas fa-map-marker-alt"></i> GPS & TRACKING
        </div>
        <p class="muted">Status koordinat: <span id="coordsText">-</span></p>
        <div class="btn-row">
          <button class="btn-solid secondary" id="btnGpsStart">
            <i class="fas fa-location-arrow"></i> Mulai GPS
          </button>
          <button class="btn-solid secondary" id="btnGpsStop">
            <i class="fas fa-stop-circle"></i> Stop
          </button>
        </div>
        <p class="muted" style="margin-top:4px;font-size:10px;">
          Modul GPS V2 menggunakan interval dinamis sesuai mode.
        </p>

        <hr style="border:none;border-top:1px solid var(--border);margin:8px 0;">

        <div class="panel-title">
          <i class="fas fa-user-shield"></i> ADMIN LOGIN
        </div>
        <input id="adminPass" type="password" class="field-input" placeholder="Password admin...">
        <div class="btn-row">
          <button class="btn-solid secondary" id="btnAdminLogin">
            <i class="fas fa-door-open"></i> Login
          </button>
          <button class="btn-solid secondary" id="btnAdminLogout" style="display:none;">
            <i class="fas fa-sign-out-alt"></i> Logout
          </button>
        </div>
        <p class="muted" style="margin-top:4px;font-size:10px;">
          Versi final: password admin akan dicek via Firebase (hash), tidak disimpan di HTML.
        </p>
      </section>

      <!-- PANEL: CHECKPOINT / QR -->
      <section class="panel-block" data-side-panel="checkpoint" style="display:none;">
        <div class="panel-title">
          <i class="fas fa-qrcode"></i> CHECKPOINT / QR
        </div>
        <label class="field-label">Teks / ID untuk QR</label>
        <input id="qrText" class="field-input" placeholder="Bisa ID area, kode pos, dsb...">
        <div class="btn-row">
          <button class="btn-solid secondary" id="btnGenerateQr">
            <i class="fas fa-qrcode"></i> Generate QR
          </button>
          <button class="btn-solid secondary" id="btnQrFromArea">
            <i class="fas fa-layer-group"></i> QR dari Area aktif
          </button>
        </div>
        <div id="qrPreview" style="margin-top:8px;"></div>

        <hr style="border:none;border-top:1px solid var(--border);margin:8px 0;">

        <div class="panel-title">
          <i class="fas fa-camera"></i> SCAN QR (KAMERA)
        </div>
        <p class="muted">Tekan mulai scan, arahkan kamera ke QR, hasil akan muncul di bawah.</p>
        <div class="btn-row">
          <button class="btn-solid secondary" id="btnStartScan">
            <i class="fas fa-play"></i> Mulai Scan
          </button>
          <button class="btn-solid secondary" id="btnStopScan">
            <i class="fas fa-stop"></i> Stop Scan
          </button>
        </div>
        <video id="qrVideo" autoplay playsinline style="display:none;margin-top:6px;"></video>
        <canvas id="qrScannerCanvas" style="display:none;margin-top:6px;"></canvas>
        <p class="muted" style="margin-top:4px;">Hasil scan: <span id="qrResult">-</span></p>
      </section>

      <!-- PANEL: SETTINGS -->
      <section class="panel-block" data-side-panel="settings" style="display:none;">
        <div class="panel-title">
          <i class="fas fa-sliders-h"></i> SETTINGS
        </div>
        <label class="field-label">Mode hemat baterai GPS</label>
        <select id="fieldGpsMode" class="field-select">
          <option value="normal">Normal</option>
          <option value="aggressive">Akurat (lebih boros)</option>
          <option value="battery">Hemat baterai</option>
        </select>
        <p class="muted" style="margin-top:4px;font-size:10px;">
          Mengatur interval kirim lokasi. Logika detail di modul GPS.
        </p>
      </section>

      <!-- PANEL: DEEP CLEAN -->
      <section class="panel-block" data-side-panel="deep" style="display:none;">
        <div class="panel-title">
          <i class="fas fa-bomb"></i> DEEP CLEAN V2
        </div>
        <p class="muted">
          Menghapus data lokal (cache, setting) di perangkat. Data di server tidak tersentuh. Versi final akan menambah proteksi admin sebelum menghapus data server.
        </p>
        <div class="btn-row" style="margin-top:6px;">
          <button class="btn-solid secondary" id="btnDeepClean">
            <i class="fas fa-skull-crossbones"></i> Deep Clean Lokal
          </button>
        </div>
      </section>
    </aside>

    <!-- MAIN -->
    <section class="main">
      <div class="main-tabs">
        <div class="main-tab active" data-main="areas">
          <i class="fas fa-layer-group"></i> Area & Foto
        </div>
        <div class="main-tab" data-main="panic">
          <i class="fas fa-bell"></i> Panic
        </div>
        <div class="main-tab" data-main="gps">
          <i class="fas fa-route"></i> GPS & Jejak
        </div>
        <div class="main-tab" data-main="chat">
          <i class="fas fa-comments"></i> Chat
        </div>
        <div class="main-tab" data-main="signature">
          <i class="fas fa-pen-nib"></i> Tanda Tangan
        </div>
        <div class="main-tab" data-main="export">
          <i class="fas fa-file-pdf"></i> Export PDF
        </div>
        <div class="main-tab" data-main="admin">
          <i class="fas fa-cogs"></i> Admin Tools
        </div>
      </div>

      <!-- MAIN SECTION: AREAS -->
      <section class="main-section active" data-main-panel="areas">
        <div style="display:flex;flex-direction:column;gap:8px;">
          <div style="display:flex;flex-wrap:wrap;gap:6px;align-items:flex-end;">
            <div style="flex:1;min-width:140px;">
              <div class="field-label">Nama Area</div>
              <input id="fieldNewAreaName" class="field-input" placeholder="Contoh: AREA LOBBY UTAMA">
            </div>
            <div style="flex:1;min-width:140px;">
              <div class="field-label">Detail Lokasi</div>
              <input id="fieldNewAreaDetail" class="field-input" placeholder="Contoh: Pintu masuk utama, dekat resepsionis">
            </div>
            <button class="btn-solid" id="btnAddArea">
              <i class="fas fa-plus-circle"></i> Tambah Area
            </button>
          </div>
          <p class="muted" style="font-size:11px;">
            Di setiap kartu area: foto, AI deskripsi, dan QR akan terhubung ke fitur-fitur di panel lain.
          </p>

          <div class="area-list" id="areaList"></div>
        </div>
      </section>

      <!-- MAIN SECTION: PANIC -->
      <section class="main-section" data-main-panel="panic">
        <div class="panic-card" id="panicCard">
          <div class="panic-header">
            <div class="panic-title">
              <span class="panic-indicator" id="panicIndicator"></span>
              PANIC CHANNEL
            </div>
            <div class="panic-status" id="panicStatusText">
              Status: <span>Normal</span>
            </div>
          </div>

          <p class="muted" style="font-size:11px;">
            Tekan PANIC bila terjadi kondisi darurat. Event PANIC berisi UID, GPS, dan info perangkat, dikirim ke <code>/alerts/{uid}</code>.
          </p>

          <div class="btn-row">
            <button class="btn-solid panic" id="btnPanic">
              <i class="fas fa-bell"></i> PANIC
            </button>
            <button class="btn-solid secondary" id="btnPanicStop">
              <i class="fas fa-stop"></i> Stop Panic
            </button>
          </div>

          <p class="muted" style="font-size:10px;margin-top:4px;">
            Blink merah <b>unlimited</b> selama status PANIC aktif. Versi final bisa di-reset dari Command Center.
          </p>
        </div>
      </section>

      <!-- MAIN SECTION: GPS -->
      <section class="main-section" data-main-panel="gps">
        <p class="muted">
          Ringkasan jejak GPS (jumlah titik, jarak, dll) akan ditempatkan di sini di versi berikutnya. Sekarang modul GPS V2 sudah auto jalan dan kirim lokasi ke server.
        </p>
      </section>

      <!-- MAIN SECTION: CHAT -->
      <section class="main-section" data-main-panel="chat">
        <div class="chat-window">
          <div class="chat-messages" id="chatMessages"></div>
          <div class="chat-input-row">
            <input id="chatInput" class="chat-input" placeholder="Ketik pesan ke Command Center...">
            <button class="btn-solid secondary" id="chatSend">
              <i class="fas fa-paper-plane"></i>
            </button>
          </div>
        </div>
        <p class="muted" style="margin-top:6px;font-size:10px;">
          Saat ini chat masih lokal (dummy). Versi final akan tersambung ke Firebase (/chat/...).
        </p>
      </section>

      <!-- MAIN SECTION: SIGNATURE (BELUM DIISI) -->
      <section class="main-section" data-main-panel="signature">
        <p class="muted">
          Panel tanda tangan digital akan ditempatkan di sini (canvas + simpan). Akan dipakai di cover PDF.
        </p>
      </section>

      <!-- MAIN SECTION: EXPORT PDF -->
      <section class="main-section" data-main-panel="export">
        <p class="muted">
          Tekan tombol di bawah untuk membuat PDF laporan patroli berdasarkan data saat ini (identitas, tanggal, area, dan foto pertama di setiap area).
        </p>
        <div class="btn-row" style="margin-top:6px;">
          <button class="btn-solid" id="btnGeneratePdf">
            <i class="fas fa-file-pdf"></i> Generate PDF V2
          </button>
        </div>
        <p class="muted" style="margin-top:6px;font-size:10px;">
          Versi ini menggunakan <code>jsPDF</code>. 1 foto pertama per area akan disisipkan sebagai bukti visual. Watermark teks otomatis ditambahkan ke setiap halaman.
        </p>
      </section>

      <!-- MAIN SECTION: ADMIN TOOLS -->
      <section class="main-section" data-main-panel="admin">
        <p class="muted">
          Panel admin untuk tools khusus (cek data, simulasi, dll) akan diaktifkan setelah login admin disambungkan ke Firebase.
        </p>
      </section>
    </section>
  </main>

  <!-- ============================= -->
  <!--  SCRIPT HYBRID VERSION 2     -->
  <!-- ============================= -->
  <script>
    // =====================================================
    // [FEATURE] 0. CONFIG & GLOBAL STATE
    // =====================================================
    const AppConfig = {
      firebase: {
        apiKey: "AIzaSyCnooeRNZRzTPDvOWIAH3pXbkIryZgJuic",
        authDomain: "silitpitik7373.firebaseapp.com",
        databaseURL: "https://silitpitik7373-default-rtdb.firebaseio.com",
        projectId: "silitpitik7373",
        storageBucket: "silitpitik7373.appspot.com",
        messagingSenderId: "314430704796",
        appId: "1:314430704796:web:2147f3a3a74bfa7affb159"
      },
      cloudinary: {
        cloudName: "",   // TODO: isi nama Cloudinary lo
        uploadPreset: "" // TODO: isi upload preset unsigned
      },
      ai: {
        endpoint: ""     // TODO: isi endpoint AI / Gemini Worker lo
      },
      pdf: {
        watermarkText: "CYBER PATROL V2"
      },
      client: {
        appVersion: "v2-hybrid-photo-ai-qr-pdf",
        platform: navigator.userAgent || "unknown"
      }
    };

    const AppState = {
      firebaseReady: false,
      uid: null,
      isAdmin: false,
      gpsMode: "normal",
      panicActive: false,
      lastCoords: null,
      areas: [], // {id, name, detail, photos:[{id,dataUrl,cloudUrl,ai}]}
      chatLastSentAt: 0,
      currentAreaForPhoto: null,
      qrStream: null,
      qrScanLoop: null
    };

    // =====================================================
    // [FEATURE] 1. UTILS (HELPER UMUM)
    // =====================================================
    const Utils = {
      $(sel){return document.querySelector(sel);},
      $all(sel){return Array.from(document.querySelectorAll(sel));},
      toast(msg){
        console.log("[TOAST]", msg);
        alert(msg); // nanti bisa diganti toast custom
      },
      now(){return Date.now();},
      randomId(prefix="id"){
        return prefix + "-" + Math.random().toString(36).slice(2,9);
      },
      sanitize(text){
        return String(text || "").replace(/[<>]/g,"").trim();
      },
      formatTime(ts){
        const d = new Date(ts || Date.now());
        return d.toLocaleString("id-ID");
      },
      getDropdownDate(){
        const t = this.$("#fieldTanggal");
        const b = this.$("#fieldBulan");
        const y = this.$("#fieldTahun");
        const day = t?.value || "";
        const month = b?.value || "";
        const year = y?.value || "";
        return { day, month, year };
      }
    };
  </script>

  <script>
    // =====================================================
    // [FEATURE] 2. FIREBASE MODULE (AUTH ANON + DB)
    // =====================================================
    const FirebaseModule = (function(){
      let db = null;
      let auth = null;
      let readyCallbacks = [];

      function init(){
        try{
          if(!window.firebase) throw new Error("Firebase CDN belum termuat");
          if(!firebase.apps.length){
            firebase.initializeApp(AppConfig.firebase);
          }
          db = firebase.database();
          auth = firebase.auth();

          auth.signInAnonymously()
            .then(cred=>{
              AppState.uid = cred.user.uid;
              console.log("Anon auth OK:", AppState.uid);
              AppState.firebaseReady = true;
              readyCallbacks.forEach(cb=>cb());
            })
            .catch(err=>{
              console.error("Auth error:", err);
              Utils.toast("Gagal konek ke server (auth). Coba reload.");
            });
        }catch(e){
          console.error("Firebase init error", e);
          Utils.toast("Firebase gagal diinisialisasi.");
        }
      }

      function onReady(cb){
        if(AppState.firebaseReady) cb();
        else readyCallbacks.push(cb);
      }

      function write(path, data){
        if(!db) return;
        return db.ref(path).set(data).catch(e=>{
          console.error("DB write error", path, e);
        });
      }

      function push(path, data){
        if(!db) return;
        return db.ref(path).push(data).catch(e=>{
          console.error("DB push error", path, e);
        });
      }

      function listen(path, cb){
        if(!db) return;
        db.ref(path).on("value", snap=>{
          cb(snap.val());
        });
      }

      return { init, onReady, write, push, listen };
    })();
  </script>

  <script>
    // =====================================================
    // [FEATURE] 3. GPS V2 (AUTO START + MODE)
    // =====================================================
    const GpsModule = (function(){
      const gpsPill = Utils.$("#gpsStatusPill");
      const gpsText = Utils.$("#gpsStatusText");
      const coordsText = Utils.$("#coordsText");

      let timer = null;
      let currentInterval = 10000; // default 10 detik

      function updatePill(active){
        gpsPill.classList.toggle("active", !!active);
        gpsText.textContent = active ? "GPS: Aktif" : "GPS: Idle";
      }

      function setCoords(pos){
        const { latitude, longitude, accuracy } = pos.coords;
        AppState.lastCoords = { lat:latitude, lng:longitude, acc:accuracy, ts:Date.now() };
        coordsText.textContent = `${latitude.toFixed(5)}, ${longitude.toFixed(5)} (±${Math.round(accuracy)}m)`;
      }

      function sendToServer(){
        if(!AppState.lastCoords || !AppState.uid) return;
        FirebaseModule.write(`/live/${AppState.uid}`, {
          ...AppState.lastCoords,
          ts: AppState.lastCoords.ts,
          client: AppConfig.client.appVersion,
          platform: AppConfig.client.platform
        });
      }

      function poll(){
        if(!navigator.geolocation){
          Utils.toast("Perangkat tidak mendukung GPS.");
          stop();
          return;
        }
        navigator.geolocation.getCurrentPosition(pos=>{
          setCoords(pos);
          sendToServer();
        },err=>{
          console.warn("GPS err:", err);
        },{ enableHighAccuracy: AppState.gpsMode === "aggressive", timeout:8000, maximumAge:5000 });
      }

      function start(){
        if(timer) return;
        const mode = AppState.gpsMode;
        if(mode === "battery") currentInterval = 25000;
        else if(mode === "aggressive") currentInterval = 5000;
        else currentInterval = 10000;

        updatePill(true);
        poll();
        timer = setInterval(poll, currentInterval);
      }

      function stop(){
        updatePill(false);
        if(timer){
          clearInterval(timer);
          timer = null;
        }
      }

      return { start, stop };
    })();
  </script>

  <script>
    // =====================================================
    // [FEATURE] 4. PANIC V2 (LOCAL + /alerts/{uid})
    // =====================================================
    const PanicModule = (function(){
      const btnPanic = Utils.$("#btnPanic");
      const btnPanicStop = Utils.$("#btnPanicStop");
      const indicator = Utils.$("#panicIndicator");
      const card = Utils.$("#panicCard");
      const statusText = Utils.$("#panicStatusText");

      let localBlink = false;
      let lastSent = 0;

      function render(){
        card.classList.toggle("panic-blink", AppState.panicActive && localBlink);
        indicator.style.background = AppState.panicActive ? "var(--panic)" : "#4b5563";
        indicator.style.boxShadow = AppState.panicActive ? "0 0 12px rgba(255,0,85,0.9)" : "none";
        statusText.innerHTML = AppState.panicActive
          ? 'Status: <span style="color:var(--panic);">PANIC AKTIF</span>'
          : 'Status: <span>Normal</span>';
      }

      async function sendPanic(active){
        if(!AppState.uid || !AppState.firebaseReady) return;
        const now = Date.now();
        if(now - lastSent < 1500) return; // anti spam kecil
        lastSent = now;

        const payload = {
          uid: AppState.uid,
          ts: now,
          active: !!active,
          coords: AppState.lastCoords || null,
          client: AppConfig.client.appVersion,
          platform: AppConfig.client.platform
        };
        await FirebaseModule.write(`/alerts/${AppState.uid}`, payload);
      }

      function activate(){
        AppState.panicActive = true;
        localBlink = true;
        render();
        sendPanic(true);
      }

      function deactivate(){
        AppState.panicActive = false;
        localBlink = false;
        render();
        sendPanic(false);
      }

      function init(){
        render();
        btnPanic.addEventListener("click", activate);
        btnPanicStop.addEventListener("click", deactivate);
      }

      return { init, activate, deactivate };
    })();
  </script>

  <script>
    // =====================================================
    // [FEATURE] 5. AREA MANAGER V2
    // =====================================================
    const AreaModule = (function(){
      const areaList = Utils.$("#areaList");
      const fieldName = Utils.$("#fieldNewAreaName");
      const fieldDetail = Utils.$("#fieldNewAreaDetail");
      const btnAdd = Utils.$("#btnAddArea");

      function render(){
        areaList.innerHTML = "";
        AppState.areas.forEach((area, idx)=>{
          const div = document.createElement("div");
          div.className = "area-item";
          div.dataset.areaId = area.id;

          const photosHtml = (area.photos || []).map((p,i)=>`
            <div class="area-photo-thumb">
              <img src="${p.dataUrl || p.cloudUrl || ""}" alt="foto">
              <span>${i+1}</span>
            </div>
          `).join("");

          const aiText = area.aiSummary || "Belum ada deskripsi AI.";

          div.innerHTML = `
            <div class="area-top">
              <div>
                <div class="area-name">${area.name}</div>
                <div class="area-meta">${area.detail || "-"}</div>
              </div>
              <span class="area-chip">
                <i class="fas fa-hashtag"></i>${idx+1}
              </span>
            </div>
            <div class="area-actions">
              <button class="btn-mini" data-action="add-photo" data-area="${area.id}">
                <i class="fas fa-camera"></i> Foto
              </button>
              <button class="btn-mini" data-action="ai-describe" data-area="${area.id}">
                <i class="fas fa-robot"></i> AI Deskripsi
              </button>
              <button class="btn-mini" data-action="qr-area" data-area="${area.id}">
                <i class="fas fa-qrcode"></i> QR
              </button>
            </div>
            <div class="area-photos" id="areaPhotos-${area.id}">
              ${photosHtml || '<span class="muted" style="font-size:10px;">Belum ada foto.</span>'}
            </div>
            <div class="area-ai" id="areaAi-${area.id}">
              ${aiText}
            </div>
          `;
          areaList.appendChild(div);
        });
      }

      function addArea(){
        const name = Utils.sanitize(fieldName.value);
        const detail = Utils.sanitize(fieldDetail.value);
        if(!name){
          Utils.toast("Nama area wajib diisi.");
          return;
        }
        AppState.areas.push({ id: Utils.randomId("area"), name, detail, photos:[], aiSummary:"" });
        fieldName.value = "";
        fieldDetail.value = "";
        render();
      }

      function findAreaById(id){
        return AppState.areas.find(a=>a.id===id);
      }

      function onAreaClick(e){
        const btn = e.target.closest(".btn-mini");
        if(!btn) return;
        const action = btn.dataset.action;
        const areaId = btn.dataset.area;
        const area = findAreaById(areaId);
        if(!area) return;

        if(action === "add-photo"){
          PhotoModule.requestPhotoForArea(areaId);
        }else if(action === "ai-describe"){
          AiModule.describeArea(areaId);
        }else if(action === "qr-area"){
          QrModule.setQrFromArea(areaId);
        }
      }

      function init(){
        btnAdd.addEventListener("click", addArea);
        areaList.addEventListener("click", onAreaClick);
      }

      return { init, render, addArea, findAreaById };
    })();
  </script>

  <script>
    // =====================================================
    // [FEATURE] 6. CHAT V2 (LOCAL DUMMY)
    // =====================================================
    const ChatModule = (function(){
      const box = Utils.$("#chatMessages");
      const input = Utils.$("#chatInput");
      const btnSend = Utils.$("#chatSend");

      function addMessage(text, me=false){
        const row = document.createElement("div");
        row.className = "chat-row " + (me ? "me" : "other");
        row.innerHTML = `
          <div>${text}</div>
          <div class="chat-meta">${me ? "You" : "System"} • ${Utils.formatTime(Date.now())}</div>
        `;
        box.appendChild(row);
        box.scrollTop = box.scrollHeight;
      }

      function send(){
        const raw = Utils.sanitize(input.value);
        if(!raw) return;
        const now = Date.now();
        if(now - AppState.chatLastSentAt < 800){
          Utils.toast("Terlalu cepat, jeda sebentar.");
          return;
        }
        AppState.chatLastSentAt = now;
        addMessage(raw, true);
        input.value = "";
        // versi final: kirim ke Firebase
      }

      function init(){
        btnSend.addEventListener("click", send);
        input.addEventListener("keydown", e=>{
          if(e.key === "Enter") send();
        });
        addMessage("Channel chat V2 siap. Versi final akan terhubung ke Command Center.", false);
      }

      return { init, addMessage };
    })();
  </script>

  <script>
    // =====================================================
    // [FEATURE] 7. UI MODULE (TABS & MODE BADGE)
    // =====================================================
    const UiModule = (function(){
      function initSideTabs(){
        const tabs = Utils.$all(".side-tab");
        tabs.forEach(tab=>{
          tab.addEventListener("click", ()=>{
            const key = tab.getAttribute("data-side");
            tabs.forEach(t=>t.classList.remove("active"));
            tab.classList.add("active");
            Utils.$all("[data-side-panel]").forEach(p=>{
              p.style.display = p.getAttribute("data-side-panel") === key ? "block" : "none";
            });
          });
        });
      }

      function initMainTabs(){
        const tabs = Utils.$all(".main-tab");
        tabs.forEach(tab=>{
          tab.addEventListener("click", ()=>{
            const key = tab.getAttribute("data-main");
            tabs.forEach(t=>t.classList.remove("active"));
            tab.classList.add("active");
            Utils.$all("[data-main-panel]").forEach(p=>{
              p.classList.toggle("active", p.getAttribute("data-main-panel") === key);
            });
          });
        });
      }

      function initModeToggle(){
        const badge = Utils.$("#modeBadge");
        const modeText = Utils.$("#modeText");
        const btn = Utils.$("#btnToggleMode");
        const btnLabel = Utils.$("#btnToggleModeText");

        function render(){
          badge.querySelector(".badge-dot").style.background = AppState.isAdmin ? "#f59e0b" : "#22c55e";
          modeText.textContent = AppState.isAdmin ? "MODE: ADMIN" : "MODE: USER";
          btnLabel.textContent = AppState.isAdmin ? "Keluar Admin" : "Masuk Admin";
        }
        render();

        btn.addEventListener("click", ()=>{
          // sementara hanya switch visual
          AppState.isAdmin = !AppState.isAdmin;
          render();
        });
      }

      return { initSideTabs, initMainTabs, initModeToggle };
    })();
  </script>

  <script>
    // =====================================================
    // [FEATURE] 8. PHOTO MODULE V2 (AREA FOTO + CLOUDINARY)
    // =====================================================
    const PhotoModule = (function(){
      const input = Utils.$("#hiddenPhotoInput");

      function requestPhotoForArea(areaId){
        AppState.currentAreaForPhoto = areaId;
        if(!input) return;
        input.value = "";
        input.click();
      }

      function onFileChange(e){
        const file = e.target.files && e.target.files[0];
        if(!file) return;
        const areaId = AppState.currentAreaForPhoto;
        if(!areaId){
          Utils.toast("Area tidak ditemukan.");
          return;
        }
        const area = AreaModule.findAreaById(areaId);
        if(!area){
          Utils.toast("Area tidak ditemukan.");
          return;
        }

        const reader = new FileReader();
        reader.onload = function(ev){
          const dataUrl = ev.target.result;
          const photoObj = {
            id: Utils.randomId("photo"),
            dataUrl,
            cloudUrl: "",
            ai: ""
          };
          area.photos = area.photos || [];
          area.photos.push(photoObj);
          AreaModule.render();

          // Upload ke Cloudinary jika config diisi
          if(AppConfig.cloudinary.cloudName && AppConfig.cloudinary.uploadPreset){
            uploadToCloudinary(photoObj, areaId);
          }else{
            console.log("Cloudinary belum dikonfigurasi, foto hanya lokal.");
          }
        };
        reader.readAsDataURL(file);
      }

      function uploadToCloudinary(photoObj, areaId){
        try{
          const formData = new FormData();
          formData.append("file", photoObj.dataUrl);
          formData.append("upload_preset", AppConfig.cloudinary.uploadPreset);
          const url = `https://api.cloudinary.com/v1_1/${AppConfig.cloudinary.cloudName}/upload`;
          fetch(url,{method:"POST", body:formData})
            .then(r=>r.json())
            .then(res=>{
              if(res && res.secure_url){
                photoObj.cloudUrl = res.secure_url;
                console.log("Cloudinary OK:", res.secure_url);
                AreaModule.render();
              }else{
                console.warn("Upload Cloudinary gagal:", res);
              }
            })
            .catch(err=>{
              console.error("Cloudinary error:", err);
            });
        }catch(e){
          console.error("Upload Cloudinary exception:", e);
        }
      }

      function init(){
        if(input){
          input.addEventListener("change", onFileChange);
        }
      }

      return { init, requestPhotoForArea };
    })();
  </script>

  <script>
    // =====================================================
    // [FEATURE] 9. AI MODULE V2 (DESKRIPSI AREA)
    // =====================================================
    const AiModule = (function(){
      async function describeArea(areaId){
        const area = AreaModule.findAreaById(areaId);
        if(!area){
          Utils.toast("Area tidak ditemukan.");
          return;
        }
        const container = Utils.$(`#areaAi-${areaId}`);
        if(container){
          container.textContent = "Meminta deskripsi AI...";
        }

        if(!AppConfig.ai.endpoint){
          Utils.toast("Endpoint AI belum diatur di AppConfig.ai.endpoint");
          if(container){
            container.textContent = "Endpoint AI belum dikonfigurasi.";
          }
          return;
        }

        // Ambil foto pertama (kalau ada)
        const firstPhoto = (area.photos || [])[0];
        const imageSrc = firstPhoto?.cloudUrl || firstPhoto?.dataUrl || null;

        const body = {
          areaName: area.name,
          detail: area.detail,
          image: imageSrc,
          meta: {
            uid: AppState.uid,
            appVersion: AppConfig.client.appVersion
          }
        };

        try{
          const res = await fetch(AppConfig.ai.endpoint,{
            method:"POST",
            headers:{"Content-Type":"application/json"},
            body:JSON.stringify(body)
          });
          const data = await res.json();
          const text = data.description || data.text || JSON.stringify(data);
          area.aiSummary = text;
          if(container){
            container.textContent = text;
          }
        }catch(e){
          console.error("AI error:", e);
          if(container){
            container.textContent = "Gagal mendapatkan deskripsi AI.";
          }
          Utils.toast("Gagal menghubungi AI, cek endpoint.");
        }
      }

      return { describeArea };
    })();
  </script>

  <script>
    // =====================================================
    // [FEATURE] 10. QR MODULE V2 (GENERATE + SCAN)
    // =====================================================
    const QrModule = (function(){
      let qrObj = null;
      const qrText = Utils.$("#qrText");
      const qrPreview = Utils.$("#qrPreview");
      const btnGenerate = Utils.$("#btnGenerateQr");
      const btnFromArea = Utils.$("#btnQrFromArea");
      const btnStartScan = Utils.$("#btnStartScan");
      const btnStopScan = Utils.$("#btnStopScan");
      const video = Utils.$("#qrVideo");
      const canvas = Utils.$("#qrScannerCanvas");
      const qrResult = Utils.$("#qrResult");

      function generate(text){
        if(!text){
          Utils.toast("Isi teks / ID dulu untuk QR.");
          return;
        }
        qrPreview.innerHTML = "";
        qrObj = new QRCode(qrPreview,{
          text,
          width:160,
          height:160
        });
      }

      function setQrFromArea(areaId){
        const area = AreaModule.findAreaById(areaId);
        if(!area){
          Utils.toast("Area tidak ditemukan.");
          return;
        }
        const value = `AREA:${area.name}`;
        if(qrText) qrText.value = value;
        generate(value);
      }

      async function startScan(){
        if(!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){
          Utils.toast("Kamera tidak didukung.");
          return;
        }
        try{
          AppState.qrStream = await navigator.mediaDevices.getUserMedia({
            video:{facingMode:"environment"}
          });
          video.srcObject = AppState.qrStream;
          video.style.display = "block";
          canvas.style.display = "block";
          qrResult.textContent = "-";
          scanLoop();
        }catch(e){
          console.error("getUserMedia err:", e);
          Utils.toast("Gagal membuka kamera QR.");
        }
      }

      function stopScan(){
        if(AppState.qrStream){
          AppState.qrStream.getTracks().forEach(t=>t.stop());
          AppState.qrStream = null;
        }
        if(AppState.qrScanLoop){
          cancelAnimationFrame(AppState.qrScanLoop);
          AppState.qrScanLoop = null;
        }
        video.style.display = "none";
        canvas.style.display = "none";
      }

      function scanLoop(){
        if(!video || video.readyState !== video.HAVE_ENOUGH_DATA){
          AppState.qrScanLoop = requestAnimationFrame(scanLoop);
          return;
        }
        const ctx = canvas.getContext("2d");
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.drawImage(video,0,0,canvas.width,canvas.height);
        const imageData = ctx.getImageData(0,0,canvas.width,canvas.height);
        const code = jsQR(imageData.data, canvas.width, canvas.height);
        if(code && code.data){
          qrResult.textContent = code.data;
          // setelah dapat, bisa stop otomatis
          stopScan();
          return;
        }
        AppState.qrScanLoop = requestAnimationFrame(scanLoop);
      }

      function init(){
        if(btnGenerate){
          btnGenerate.addEventListener("click", ()=>{
            generate(Utils.sanitize(qrText.value));
          });
        }
        if(btnFromArea){
          btnFromArea.addEventListener("click", ()=>{
            if(!AppState.areas.length){
              Utils.toast("Belum ada area.");
              return;
            }
            // ambil area pertama untuk contoh
            setQrFromArea(AppState.areas[0].id);
          });
        }
        if(btnStartScan){
          btnStartScan.addEventListener("click", startScan);
        }
        if(btnStopScan){
          btnStopScan.addEventListener("click", stopScan);
        }
      }

      return { init, setQrFromArea };
    })();
  </script>

  <script>
    // =====================================================
    // [FEATURE] 11. PDF MODULE V2 (jsPDF)
    // =====================================================
    const PdfModule = (function(){
      function generate(){
        if(!window.jspdf || !window.jspdf.jsPDF){
          Utils.toast("jsPDF belum termuat.");
          return;
        }
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({orientation:"p", unit:"mm", format:"a4"});

        const nama = Utils.sanitize(Utils.$("#fieldName")?.value || "");
        const shift = Utils.sanitize(Utils.$("#fieldShift")?.value || "");
        const lokasi = Utils.sanitize(Utils.$("#fieldLokasi")?.value || "");
        const {day,month,year} = Utils.getDropdownDate();
        const tglStr = (day && month && year) ? `${day}-${month}-${year}` : "-";

        // Cover
        doc.setFontSize(16);
        doc.setFont("helvetica","bold");
        doc.text("LAPORAN PATROLI V2", 105, 20, {align:"center"});

        doc.setFontSize(11);
        doc.setFont("helvetica","normal");
        doc.text(`Nama Petugas : ${nama || "-"}`, 20, 35);
        doc.text(`Shift        : ${shift || "-"}`, 20, 42);
        doc.text(`Tanggal      : ${tglStr}`, 20, 49);
        doc.text(`Lokasi       : ${lokasi || "-"}`, 20, 56);

        // watermark cover
        addWatermark(doc);

        // Area pages
        AppState.areas.forEach((area, idx)=>{
          if(idx > 0) doc.addPage();

          doc.setFontSize(13);
          doc.setFont("helvetica","bold");
          doc.text(`AREA ${idx+1}: ${area.name}`, 20, 25);

          doc.setFontSize(10);
          doc.setFont("helvetica","normal");
          doc.text("Detail:", 20, 32);
          doc.text(area.detail || "-", 20, 37, {maxWidth:170});

          // AI summary
          if(area.aiSummary){
            doc.text("Deskripsi AI:", 20, 47);
            doc.text(area.aiSummary, 20, 52, {maxWidth:170});
          }

          // Foto pertama (kalau ada)
          const firstPhoto = (area.photos || [])[0];
          if(firstPhoto && firstPhoto.dataUrl && firstPhoto.dataUrl.startsWith("data:image")){
            try{
              doc.addImage(firstPhoto.dataUrl, "JPEG", 20, 90, 80, 60);
            }catch(e){
              console.warn("Gagal addImage:", e);
            }
          }

          addWatermark(doc);
        });

        doc.save("Laporan_Patroli_V2.pdf");
      }

      function addWatermark(doc){
        const txt = AppConfig.pdf.watermarkText || "CYBER PATROL";
        doc.saveGraphicsState();
        doc.setTextColor(255,0,0);
        doc.setFontSize(32);
        doc.setDrawColor(255,0,0);
        doc.setGState(new doc.GState({opacity:0.12}));
        doc.text(txt, 35, 140, {angle:45});
        doc.restoreGraphicsState();
      }

      return { generate };
    })();
  </script>

  <script>
    // =====================================================
    // [FEATURE] 12. APP INIT (AUTO TANGGAL + AUTO GPS)
    // =====================================================
    (function initApp(){
      document.addEventListener("DOMContentLoaded", ()=>{

        // AUTO TANGGAL: isi dropdown tgl / bln / thn dengan hari ini
        const today = new Date();
        const tgl = today.getDate();
        const bln = today.getMonth() + 1;
        const thn = today.getFullYear();

        const selTgl = Utils.$("#fieldTanggal");
        const selBln = Utils.$("#fieldBulan");
        const selThn = Utils.$("#fieldTahun");

        if(selTgl) selTgl.value = String(tgl);
        if(selBln) selBln.value = String(bln).padStart(2,"0");
        if(selThn) selThn.value = String(thn);

        // Init Firebase
        FirebaseModule.init();

        // UI basics
        UiModule.initSideTabs();
        UiModule.initMainTabs();
        UiModule.initModeToggle();

        // Modules
        AreaModule.init();
        PanicModule.init();
        ChatModule.init();
        PhotoModule.init();
        QrModule.init();

        // GPS buttons manual
        Utils.$("#btnGpsStart").addEventListener("click", ()=>{
          GpsModule.start();
        });
        Utils.$("#btnGpsStop").addEventListener("click", ()=>{
          GpsModule.stop();
        });

        // GPS mode select
        Utils.$("#fieldGpsMode").addEventListener("change", e=>{
          AppState.gpsMode = e.target.value || "normal";
          GpsModule.stop();
          GpsModule.start();
        });

        // AUTO GPS ON LOAD
        AppState.gpsMode = "normal";
        GpsModule.start();

        // Deep clean lokal
        Utils.$("#btnDeepClean").addEventListener("click", ()=>{
          if(confirm("Hapus semua cache lokal? (foto offline, setting, dll)")){
            try{ localStorage.clear(); }catch(e){}
            Utils.toast("Cache lokal dibersihkan. Data di server tidak ikut terhapus.");
          }
        });

        // PDF generate
        Utils.$("#btnGeneratePdf").addEventListener("click", ()=>{
          PdfModule.generate();
        });

        Utils.toast("CYBER PATROL V2 HYBRID: GPS auto, foto per area, AI siap, QR & PDF V2 aktif (config AI & Cloudinary isi manual).");
      });
    })();
  </script>
</body>
</html>