<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Patroli â€” Enhanced with Engineering Tools</title>

<!-- FIREBASE HARUS DULUAN SEBELUM APLIKASI -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

<script>
// âœ… FIREBASE CONFIG & INIT HARUS PALING AWAL
const FIREBASE_CONFIG = {
  apiKey: "AIzaSyCnooeRNZRzTPDvOWIAH3pXbkIryZgJuic",
  authDomain: "silitpitik7373.firebaseapp.com",
  projectId: "silitpitik7373",
  databaseURL: "https://silitpitik7373-default-rtdb.firebaseio.com",
  storageBucket: "silitpitik7373.appspot.com",
  messagingSenderId: "314430704796",
  appId: "1:314430704796:web:2147f3a3a74bfa7affb159"
};

// Initialize Firebase immediately
(function() {
  try {
    if (!firebase.apps.length) {
      firebase.initializeApp(FIREBASE_CONFIG);
      console.log('ðŸ”¥ Firebase initialized EARLY');
    }
    
    // Auto sign-in anonymous
    firebase.auth().signInAnonymously().catch(e => console.warn('Auth auto-signin:', e));
    
    // Cloudinary config
    window.CLOUDINARY = { cloudName: "dowaohqkh", uploadPreset: "Patroli" };
    
  } catch (e) {
    console.error('Firebase early init error:', e);
  }
})();
</script>

<!-- CDN deps -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
<!-- âœ… TAMBAHAN: EXIF.js untuk metadata -->
<script src="https://cdn.jsdelivr.net/npm/exif-js@2.3.0/exif.min.js"></script>

<style>
/* âœ… ENHANCED STYLES - TAMBAHAN BARU */
:root {
  --bg: #0a0e17;
  --card: #111827;
  --primary: #00d4ff;
  --primary-dark: #0099cc;
  --secondary: #8b5cf6;
  --accent: #00ff88;
  --muted: #6b7280;
  --danger: #ef4444;
  --text: #e5e7eb;
  --text-muted: #9ca3af;
  --border: #1f2937;
  --header-bg: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
  --cyber-glow: 0 0 10px rgba(0, 212, 255, 0.7);
  --cyber-glow-accent: 0 0 15px rgba(0, 255, 136, 0.5);
}

/* âœ… NEW: Device Info Badge */
.device-badge {
  position: fixed;
  top: 60px;
  right: 10px;
  background: rgba(0, 0, 0, 0.7);
  padding: 6px 10px;
  border-radius: 12px;
  font-size: 11px;
  z-index: 999;
  border: 1px solid var(--border);
  max-width: 180px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

/* âœ… NEW: EXIF Badge untuk foto */
.exif-badge {
  position: absolute;
  top: 5px;
  right: 5px;
  background: linear-gradient(135deg, #fbbf24, #f59e0b);
  color: #000;
  padding: 2px 6px;
  border-radius: 10px;
  font-size: 10px;
  font-weight: bold;
  z-index: 10;
  box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

/* âœ… NEW: GPS Quality Indicator */
.gps-indicator {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 3px 8px;
  border-radius: 12px;
  font-size: 11px;
  font-weight: 600;
  margin-left: 8px;
}
.gps-excellent { background: #10b981; color: white; }
.gps-good { background: #3b82f6; color: white; }
.gps-fair { background: #f59e0b; color: black; }
.gps-poor { background: #ef4444; color: white; }

/* âœ… NEW: Admin Access Button (HIDDEN) */
#adminAccessArea {
  position: fixed;
  bottom: 15px;
  left: 15px;
  width: 40px;
  height: 40px;
  opacity: 0.1;
  background: transparent;
  border: none;
  z-index: 9998;
  cursor: pointer;
}

/* âœ… NEW: Admin Tools Modal */
.admin-modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.85);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 10002;
}

.admin-modal {
  background: var(--card);
  border-radius: 12px;
  padding: 20px;
  width: 95%;
  max-width: 500px;
  max-height: 90vh;
  overflow-y: auto;
  border: 2px solid var(--primary);
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
}

.admin-modal h3 {
  margin-top: 0;
  color: var(--primary);
  border-bottom: 1px solid var(--border);
  padding-bottom: 10px;
}

.admin-section {
  margin: 15px 0;
  padding: 15px;
  background: rgba(255, 255, 255, 0.03);
  border-radius: 8px;
  border: 1px solid var(--border);
}

.admin-input {
  width: 100%;
  padding: 8px 12px;
  margin: 6px 0;
  border-radius: 6px;
  border: 1px solid var(--border);
  background: rgba(255, 255, 255, 0.05);
  color: var(--text);
}

.admin-btn {
  background: linear-gradient(135deg, var(--primary), var(--primary-dark));
  color: #0a0e17;
  padding: 8px 16px;
  border-radius: 6px;
  border: none;
  cursor: pointer;
  font-weight: 600;
  margin: 5px;
}

.admin-btn.danger {
  background: linear-gradient(135deg, var(--danger), #dc2626);
  color: white;
}

/* âœ… Hidden elements */
.hidden {
  display: none !important;
}

/* âœ… EXISTING STYLES (TIDAK DIUBAH) */
* {
  box-sizing: border-box;
}

body {
  margin: 0;
  font-family: 'Segoe UI', system-ui, Roboto, Arial, sans-serif;
  background: var(--bg);
  color: var(--text);
  line-height: 1.6;
}

header {
  background: var(--header-bg);
  color: var(--text);
  padding: 12px 14px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 8px;
  border-bottom: 1px solid var(--border);
  box-shadow: var(--cyber-glow);
  position: relative;
}

header::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 2px;
  background: linear-gradient(90deg, var(--primary), var(--accent), var(--secondary));
}

header h1 {
  margin: 0;
  font-size: 17px;
  font-weight: 700;
  background: linear-gradient(90deg, var(--primary), var(--accent));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.container {
  max-width: 1200px;
  margin: 12px auto;
  padding: 10px;
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
}

.card {
  background: var(--card);
  border-radius: 12px;
  padding: 16px;
  box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
  border: 1px solid var(--border);
  transition: all 0.3s ease;
}

.card:hover {
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
  transform: translateY(-2px);
}

.sidebar {
  width: 340px;
  min-width: 260px;
}

label {
  display: block;
  margin: 8px 0 6px;
  font-weight: 600;
  color: var(--text);
  font-size: 14px;
}

input[type=text], textarea, input[type=password] {
  width: 100%;
  padding: 10px 12px;
  border-radius: 8px;
  border: 1px solid var(--border);
  background: #ffffff;
  color: #111827;
  font-size: 14px;
  transition: all 0.2s ease;
}

input[type=text]:focus, textarea:focus, input[type=password]:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(0, 212, 255, 0.2);
}

textarea {
  min-height: 80px;
  resize: vertical;
}

.btn {
  background: linear-gradient(135deg, var(--primary), var(--primary-dark));
  color: #0a0e17;
  padding: 10px 16px;
  border-radius: 8px;
  border: 0;
  cursor: pointer;
  font-weight: 700;
  font-size: 14px;
  transition: all 0.2s ease;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
}

.btn.ghost {
  background: transparent;
  color: var(--primary);
  border: 1px solid var(--primary);
}

.btn.ghost:hover {
  background: rgba(0, 212, 255, 0.1);
}

.btn.danger {
  background: linear-gradient(135deg, var(--danger), #dc2626);
  color: white;
}

.muted {
  color: var(--text-muted);
  font-size: 13px;
}

.areas {
  margin-top: 12px;
}

.area {
  border-radius: 10px;
  padding: 16px;
  margin-bottom: 16px;
  border: 1px solid var(--border);
  background: linear-gradient(145deg, #1a2235, #151b2b);
  position: relative;
  overflow: hidden;
}

.area::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 4px;
  height: 100%;
  background: linear-gradient(to bottom, var(--primary), var(--accent));
}

.area-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 8px;
  margin-bottom: 12px;
}

.area-title {
  font-weight: 800;
  font-size: 16px;
  padding: 8px 12px;
  border-radius: 6px;
  color: #fff;
  background: linear-gradient(135deg, var(--primary), var(--secondary));
  box-shadow: var(--cyber-glow);
}

.photo-controls {
  display: flex;
  gap: 8px;
  align-items: center;
  margin-top: 12px;
  flex-wrap: wrap;
}

.photos {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  margin-top: 12px;
}

.photo-item {
  width: 140px;
  height: 100px;
  border-radius: 8px;
  overflow: hidden;
  position: relative;
  background: #1f2937;
  border: 1px solid var(--border);
  transition: all 0.3s ease;
}

.photo-item:hover {
  transform: scale(1.05);
  box-shadow: var(--cyber-glow);
}

.photo-item img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.photo-meta {
  font-size: 11px;
  color: var(--text-muted);
  padding: 6px;
  text-align: left;
}

.icon-btn {
  background: rgba(255, 255, 255, 0.05);
  border-radius: 6px;
  padding: 8px;
  border: 0;
  cursor: pointer;
  color: var(--text);
  transition: all 0.2s ease;
}

.icon-btn:hover {
  background: rgba(255, 255, 255, 0.1);
  transform: scale(1.1);
}

.signature-canvas {
  border: 1px solid var(--border);
  border-radius: 8px;
  touch-action: none;
  background: #ffffff;
  display: block;
}

.sig-preview {
  width: 160px;
  height: 70px;
  border: 1px solid var(--border);
  border-radius: 6px;
  overflow: hidden;
  background: #ffffff;
}

.note {
  font-size: 13px;
  color: var(--text-muted);
  margin-top: 8px;
  line-height: 1.5;
}

.tabs {
  display: flex;
  gap: 8px;
  margin-bottom: 16px;
  flex-wrap: wrap;
}

.tab {
  padding: 10px 14px;
  border-radius: 10px;
  background: rgba(0, 212, 255, 0.1);
  color: var(--primary);
  cursor: pointer;
  font-weight: 700;
  transition: all 0.2s ease;
  border: 1px solid transparent;
}

.tab:hover {
  background: rgba(0, 212, 255, 0.2);
  transform: translateY(-2px);
}

.tab.active {
  background: rgba(0, 212, 255, 0.2);
  border-color: var(--primary);
  box-shadow: var(--cyber-glow);
}

.qr-row {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 12px;
  border-radius: 8px;
  border: 1px dashed var(--border);
  margin-bottom: 10px;
  flex-wrap: wrap;
  background: rgba(255, 255, 255, 0.03);
}

.small {
  font-size: 13px;
  color: var(--text-muted);
}

.modal-backdrop {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.7);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}

.modal {
  background: var(--card);
  padding: 20px;
  border-radius: 12px;
  max-width: 420px;
  width: 94%;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
  border: 1px solid var(--border);
}

.video-preview {
  width: 100%;
  height: 220px;
  background: #000;
  border-radius: 8px;
  object-fit: cover;
}

.profile-photo-preview {
  width: 100%;
  max-height: 200px;
  object-fit: contain;
  border-radius: 8px;
  border: 2px dashed var(--border);
  margin-top: 8px;
}

/* âœ… STYLE CHAT BUBBLE & PANEL */
.chat-bubble {
  position: fixed;
  bottom: 20px;
  right: 20px;
  width: 60px;
  height: 60px;
  border-radius: 50%;
  background: linear-gradient(135deg, var(--primary), var(--secondary));
  color: #0a0e17;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  box-shadow: 0 4px 20px rgba(0, 212, 255, 0.5);
  z-index: 10000;
  border: none;
  font-size: 24px;
  transition: all 0.3s ease;
}

.chat-bubble:hover {
  transform: scale(1.1);
  box-shadow: 0 6px 25px rgba(0, 212, 255, 0.7);
}

.chat-bubble.has-new::after {
  content: '';
  position: absolute;
  top: 5px;
  right: 5px;
  width: 12px;
  height: 12px;
  background: var(--danger);
  border-radius: 50%;
  border: 2px solid #0a0e17;
}

.chat-panel {
  position: fixed;
  bottom: 90px;
  right: 20px;
  width: 350px;
  height: 500px;
  background: var(--card);
  border-radius: 12px;
  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
  z-index: 10000;
  display: flex;
  flex-direction: column;
  border: 1px solid var(--border);
  overflow: hidden;
}

.chat-header {
  padding: 12px 16px;
  background: var(--header-bg);
  color: var(--text);
  border-radius: 12px 12px 0 0;
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-bottom: 1px solid var(--border);
}

.chat-header h3 {
  margin: 0;
  font-size: 16px;
  background: linear-gradient(90deg, var(--primary), var(--accent));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.chat-close {
  background: none;
  border: none;
  color: var(--text);
  cursor: pointer;
  font-size: 18px;
  transition: all 0.2s ease;
}

.chat-close:hover {
  color: var(--primary);
  transform: scale(1.2);
}

.chat-messages {
  flex: 1;
  padding: 12px;
  overflow-y: auto;
  background: rgba(0, 0, 0, 0.2);
}

.chat-message {
  margin-bottom: 12px;
  padding: 10px 14px;
  border-radius: 12px;
  max-width: 85%;
  word-wrap: break-word;
  position: relative;
}

.chat-message.own {
  background: linear-gradient(135deg, var(--primary), var(--primary-dark));
  color: #0a0e17;
  margin-left: auto;
  border-bottom-right-radius: 4px;
}

.chat-message.other {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid var(--border);
  margin-right: auto;
  border-bottom-left-radius: 4px;
}

.chat-meta {
  font-size: 10px;
  opacity: 0.7;
  margin-top: 4px;
}

.chat-input-area {
  padding: 12px;
  border-top: 1px solid var(--border);
  display: flex;
  gap: 8px;
  background: var(--card);
  border-radius: 0 0 12px 12px;
}

.chat-input {
  flex: 1;
  padding: 10px 14px;
  border: 1px solid var(--border);
  border-radius: 20px;
  outline: none;
  background: rgba(255, 255, 255, 0.05);
  color: var(--text);
}

.chat-input:focus {
  border-color: var(--primary);
}

.chat-send {
  background: linear-gradient(135deg, var(--primary), var(--primary-dark));
  color: #0a0e17;
  border: none;
  border-radius: 20px;
  padding: 10px 16px;
  cursor: pointer;
  font-weight: 600;
  transition: all 0.2s ease;
}

.chat-send:hover {
  transform: scale(1.05);
}

.unread-badge {
  background: var(--danger);
  color: white;
  border-radius: 10px;
  padding: 2px 6px;
  font-size: 10px;
  position: absolute;
  top: -5px;
  right: -5px;
}

/* âœ… NEW: Camera overlay untuk scan QR */
.camera-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.9);
  z-index: 10001;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
}

.camera-container {
  width: 90%;
  max-width: 500px;
  background: var(--card);
  border-radius: 12px;
  overflow: hidden;
  border: 1px solid var(--border);
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
}

.camera-header {
  padding: 12px;
  background: var(--header-bg);
  color: var(--text);
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-bottom: 1px solid var(--border);
}

.camera-video {
  width: 100%;
  height: 300px;
  background: black;
}

.camera-controls {
  padding: 12px;
  background: var(--card);
  display: flex;
  gap: 8px;
  justify-content: center;
}

.scan-frame {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 200px;
  height: 200px;
  border: 2px solid var(--primary);
  border-radius: 8px;
  pointer-events: none;
  box-shadow: var(--cyber-glow);
}

.scan-line {
  position: absolute;
  width: 100%;
  height: 2px;
  background: var(--primary);
  animation: scan 2s linear infinite;
}

@keyframes scan {
  0% { top: 0; }
  50% { top: 100%; }
  100% { top: 0; }
}

/* Cyber elements */
.cyber-border {
  position: relative;
  border: 1px solid var(--primary);
  border-radius: 8px;
  overflow: hidden;
}

.cyber-border::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 2px;
  background: linear-gradient(90deg, transparent, var(--primary), transparent);
}

.cyber-border::after {
  content: '';
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  height: 2px;
  background: linear-gradient(90deg, transparent, var(--primary), transparent);
}

/* Glitch effect for headers */
.glitch {
  position: relative;
}

.glitch::before,
.glitch::after {
  content: attr(data-text);
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
}

.glitch::before {
  left: 2px;
  text-shadow: -2px 0 #ff00c1;
  clip: rect(44px, 450px, 56px, 0);
  animation: glitch-anim 5s infinite linear alternate-reverse;
}

.glitch::after {
  left: -2px;
  text-shadow: -2px 0 #00fff9;
  clip: rect(44px, 450px, 56px, 0);
  animation: glitch-anim2 5s infinite linear alternate-reverse;
}

@keyframes glitch-anim {
  0% {
    clip: rect(42px, 9999px, 44px, 0);
  }
  5% {
    clip: rect(12px, 9999px, 59px, 0);
  }
  10% {
    clip: rect(48px, 9999px, 29px, 0);
  }
  15% {
    clip: rect(42px, 9999px, 73px, 0);
  }
  20% {
    clip: rect(63px, 9999px, 27px, 0);
  }
  25% {
    clip: rect(34px, 9999px, 55px, 0);
  }
  30% {
    clip: rect(86px, 9999px, 73px, 0);
  }
  35% {
    clip: rect(20px, 9999px, 20px, 0);
  }
  40% {
    clip: rect(26px, 9999px, 60px, 0);
  }
  45% {
    clip: rect(25px, 9999px, 66px, 0);
  }
  50% {
    clip: rect(57px, 9999px, 98px, 0);
  }
  55% {
    clip: rect(5px, 9999px, 46px, 0);
  }
  60% {
    clip: rect(82px, 9999px, 31px, 0);
  }
  65% {
    clip: rect(54px, 9999px, 27px, 0);
  }
  70% {
    clip: rect(28px, 9999px, 99px, 0);
  }
  75% {
    clip: rect(45px, 9999px, 69px, 0);
  }
  80% {
    clip: rect(23px, 9999px, 85px, 0);
  }
  85% {
    clip: rect(54px, 9999px, 84px, 0);
  }
  90% {
    clip: rect(45px, 9999px, 47px, 0);
  }
  95% {
    clip: rect(37px, 9999px, 20px, 0);
  }
  100% {
    clip: rect(4px, 9999px, 91px, 0);
  }
}

@keyframes glitch-anim2 {
  0% {
    clip: rect(65px, 9999px, 100px, 0);
  }
  5% {
    clip: rect(52px, 9999px, 74px, 0);
  }
  10% {
    clip: rect(79px, 9999px, 85px, 0);
  }
  15% {
    clip: rect(75px, 9999px, 5px, 0);
  }
  20% {
    clip: rect(67px, 9999px, 61px, 0);
  }
  25% {
    clip: rect(14px, 9999px, 79px, 0);
  }
  30% {
    clip: rect(1px, 9999px, 66px, 0);
  }
  35% {
    clip: rect(86px, 9999px, 30px, 0);
  }
  40% {
    clip: rect(23px, 9999px, 98px, 0);
  }
  45% {
    clip: rect(85px, 9999px, 72px, 0);
  }
  50% {
    clip: rect(71px, 9999px, 75px, 0);
  }
  55% {
    clip: rect(2px, 9999px, 48px, 0);
  }
  60% {
    clip: rect(30px, 9999px, 16px, 0);
  }
  65% {
    clip: rect(59px, 9999px, 50px, 0);
  }
  70% {
    clip: rect(41px, 9999px, 62px, 0);
  }
  75% {
    clip: rect(2px, 9999px, 82px, 0);
  }
  80% {
    clip: rect(47px, 9999px, 73px, 0);
  }
  85% {
    clip: rect(3px, 9999px, 27px, 0);
  }
  90% {
    clip: rect(26px, 9999px, 55px, 0);
  }
  95% {
    clip: rect(42px, 9999px, 97px, 0);
  }
  100% {
    clip: rect(38px, 9999px, 49px, 0);
  }
}

@media (max-width:900px){ 
  .sidebar{width:100%} 
  .container{padding:8px} 
  .video-preview{height:180px} 
  .chat-panel {
    width: calc(100% - 40px);
    right: 20px;
    left: 20px;
  }
  .camera-container {
    width: 95%;
  }
  .device-badge {
    max-width: 140px;
    font-size: 10px;
  }
}
</style>
</head>
<body>
<header>
  <h1 class="glitch" data-text="Patroli â€” Enhanced">Patroli â€” Enhanced</h1>
  <div style="display:flex;gap:8px;align-items:center">
    <div id="modeDisplay" style="background:rgba(0, 212, 255, 0.1);padding:6px 10px;border-radius:999px;font-weight:700;border:1px solid rgba(0, 212, 255, 0.3);">Mode: User</div>
    <button id="btnToggleMode" class="btn ghost">Masuk Admin</button>
    <span id="gpsStatus" class="muted">GPS: belum</span>
    <button id="btnStartGPS" class="btn">Mulai GPS</button>
    <button id="btnGeneratePDF" class="btn">Generate PDF</button>
  </div>
</header>

<!-- âœ… NEW: Device Info Badge -->
<div id="deviceBadge" class="device-badge hidden">
  <span id="deviceText">Detecting device...</span>
  <span id="gpsQualityBadge" class="gps-indicator gps-good hidden">Good</span>
</div>

<!-- âœ… NEW: Admin Access Button (HIDDEN) -->
<div id="adminAccessArea" title="Tap 5x for Admin Tools"></div>

<!-- âœ… NEW: Admin Tools Modal (HIDDEN) -->
<div id="adminModal" class="admin-modal-overlay hidden">
  <div class="admin-modal">
    <h3><i class="fas fa-tools"></i> Admin Engineering Tools</h3>
    
    <div class="admin-section">
      <h4><i class="fas fa-mobile-alt"></i> Device Spoofing</h4>
      <select id="deviceTemplate" class="admin-input">
        <option value="">-- Pilih Device Template --</option>
        <optgroup label="Apple iPhone">
          <option value="iphone_15">iPhone 15 Pro (iOS 17)</option>
          <option value="iphone_14">iPhone 14 (iOS 17)</option>
          <option value="iphone_13">iPhone 13 (iOS 16)</option>
          <option value="iphone_se">iPhone SE (iOS 16)</option>
        </optgroup>
        <optgroup label="Samsung Galaxy">
          <option value="samsung_s24">Galaxy S24 (Android 14)</option>
          <option value="samsung_s23">Galaxy S23 (Android 14)</option>
          <option value="samsung_s22">Galaxy S22 (Android 13)</option>
          <option value="samsung_a54">Galaxy A54 (Android 13)</option>
          <option value="samsung_tab">Galaxy Tab S9 (Android 13)</option>
        </optgroup>
        <optgroup label="Xiaomi/Realme/OPPO">
          <option value="xiaomi_13">Xiaomi 13 Pro (Android 13)</option>
          <option value="xiaomi_12">Xiaomi 12 (Android 12)</option>
          <option value="realme_gt">Realme GT Neo 3 (Android 13)</option>
          <option value="oppo_find">OPPO Find X6 (Android 13)</option>
          <option value="vivo_x90">Vivo X90 Pro (Android 13)</option>
        </optgroup>
        <optgroup label="Google Pixel">
          <option value="pixel_8">Pixel 8 Pro (Android 14)</option>
          <option value="pixel_7">Pixel 7 (Android 13)</option>
          <option value="pixel_6">Pixel 6 (Android 12)</option>
        </optgroup>
        <optgroup label="Desktop/Laptop">
          <option value="windows_chrome">Windows PC - Chrome</option>
          <option value="windows_edge">Windows PC - Edge</option>
          <option value="windows_firefox">Windows PC - Firefox</option>
          <option value="mac_safari">MacBook - Safari</option>
          <option value="mac_chrome">MacBook - Chrome</option>
          <option value="linux_firefox">Linux PC - Firefox</option>
        </optgroup>
        <optgroup label="Other">
          <option value="gaming_pc">Gaming PC</option>
          <option value="smart_tv">Smart TV</option>
          <option value="custom">Custom Device (Manual Input)</option>
        </optgroup>
      </select>
      
      <div id="customDeviceFields" class="hidden" style="margin-top:10px;">
        <input type="text" id="customDeviceName" class="admin-input" placeholder="Device Name">
        <input type="text" id="customDeviceType" class="admin-input" placeholder="Device Type (mobile/tablet/desktop)">
        <input type="text" id="customDeviceOS" class="admin-input" placeholder="Operating System">
        <input type="text" id="customDeviceBrowser" class="admin-input" placeholder="Browser">
        <textarea id="customUserAgent" class="admin-input" placeholder="User Agent" rows="2"></textarea>
      </div>
      
      <div style="margin-top:10px;">
        <button class="admin-btn" id="btnApplyDevice"><i class="fas fa-check"></i> Apply Device</button>
        <button class="admin-btn danger" id="btnResetDevice"><i class="fas fa-undo"></i> Reset to Real</button>
      </div>
    </div>
    
    <div class="admin-section">
      <h4><i class="fas fa-camera"></i> EXIF Metadata Editor</h4>
      <p class="muted" style="margin-bottom:10px;">Edit metadata untuk foto yang akan diupload</p>
      
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
        <div>
          <label style="font-size:12px;">Latitude</label>
          <input type="text" id="exifLat" class="admin-input" placeholder="-6.123456" value="">
        </div>
        <div>
          <label style="font-size:12px;">Longitude</label>
          <input type="text" id="exifLon" class="admin-input" placeholder="106.789012" value="">
        </div>
      </div>
      
      <div style="margin-top:10px;">
        <label style="font-size:12px;">Camera Make</label>
        <input type="text" id="exifMake" class="admin-input" placeholder="Samsung">
      </div>
      
      <div style="margin-top:10px;">
        <label style="font-size:12px;">Camera Model</label>
        <input type="text" id="exifModel" class="admin-input" placeholder="Galaxy S23">
      </div>
      
      <div style="margin-top:10px;">
        <label style="font-size:12px;">Date & Time</label>
        <input type="datetime-local" id="exifDateTime" class="admin-input">
      </div>
      
      <div style="margin-top:15px;display:flex;gap:8px;">
        <button class="admin-btn" id="btnUseCurrentGPS"><i class="fas fa-crosshairs"></i> Use Current GPS</button>
        <button class="admin-btn" id="btnApplyEXIF"><i class="fas fa-save"></i> Apply EXIF Settings</button>
        <button class="admin-btn" id="btnViewEXIF"><i class="fas fa-eye"></i> View EXIF</button>
      </div>
    </div>
    
    <div class="admin-section">
      <h4><i class="fas fa-satellite"></i> GPS & System Info</h4>
      <div id="systemInfo" style="font-size:12px;color:var(--text-muted);">
        <div>Real Device: <span id="realDeviceInfo">Detecting...</span></div>
        <div>Spoofed Device: <span id="spoofedDeviceInfo">None</span></div>
        <div>GPS Points: <span id="gpsPointsCount">0</span></div>
        <div>Photos with EXIF: <span id="exifPhotosCount">0</span></div>
      </div>
    </div>
    
    <div style="margin-top:20px;text-align:center;border-top:1px solid var(--border);padding-top:15px;">
      <button class="admin-btn danger" id="btnCloseAdmin"><i class="fas fa-times"></i> Close Tools</button>
    </div>
  </div>
</div>

<!-- âœ… NEW: EXIF Viewer Modal -->
<div id="exifViewerModal" class="admin-modal-overlay hidden">
  <div class="admin-modal">
    <h3><i class="fas fa-info-circle"></i> EXIF Metadata Viewer</h3>
    <div id="exifViewerContent" style="max-height:400px;overflow-y:auto;font-family:monospace;font-size:12px;background:rgba(0,0,0,0.3);padding:10px;border-radius:6px;">
      Select a photo to view EXIF metadata
    </div>
    <div style="margin-top:15px;text-align:center;">
      <button class="admin-btn" id="btnCloseEXIFViewer"><i class="fas fa-times"></i> Close</button>
    </div>
  </div>
</div>

<div class="container">
  <aside class="card sidebar cyber-border">
    <div class="tabs">
      <div class="tab active" id="tabAreas">Area</div>
      <div class="tab" id="tabCheckpoint">Checkpoint (QR)</div>
      <div class="tab" id="tabLokasi">Lokasi</div>
      <div class="tab" id="tabFotoProfil">Foto Profil</div>
      <div class="tab" id="tabDeep">DEEP CLEAN-UP</div>
    </div>

    <div id="areaTab">
      <label>Nama Petugas</label><input id="officerName" type="text" placeholder="Nama petugas...">
      <label>Shift</label><input id="shift" type="text" placeholder="Contoh: Malam">
      <label>Tanggal</label><input id="date" type="text" placeholder="YYYY-MM-DD">
      <div style="margin-top:8px" class="muted">Koordinat Terkini: <span id="coords">â€”</span></div>
      <hr style="margin:10px 0;border-color:var(--border)">

      <label>Tambah Area Manual</label>
      <input id="newAreaName" type="text" placeholder="Nama area (manual)...">
      <input id="newAreaDetail" type="text" placeholder="Detail lokasi (opsional)..." style="margin-top:8px">
      <div style="margin-top:8px;display:flex;gap:8px">
        <button id="btnAddArea" class="btn">Tambah Area</button>
        <button id="btnScanAreaQR" class="btn ghost">Scan QR (kamera)</button>
      </div>

      <div style="margin-top:12px" class="note">User hanya camera; Admin camera + gallery.</div>

      <div style="margin-top:12px" class="login-box">
        <div style="font-weight:700;margin-bottom:8px">Admin Login</div>
        <input id="adminPass" type="password" placeholder="Password admin...">
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="btnLogin" class="btn">Login</button>
          <button id="btnLogout" class="btn danger" style="display:none">Logout</button>
        </div>
      </div>
    </div>

    <div id="checkpointTab" class="hidden">
      <label>Daftar Checkpoint (Unlimited)</label>
      <div id="qrList"></div>

      <label style="margin-top:8px">Buat Checkpoint Manual (JSON)</label>
      <input id="qrAreaName" type="text" placeholder="Nama Area (contoh: AREA SELATAN)">
      <input id="qrAreaDetail" type="text" placeholder="Detail lokasi (contoh: PINTU LOBBY PERTAMA)" style="margin-top:8px">

      <div style="display:flex;gap:8px;margin-top:8px">
        <button id="btnGenerateQRManual" class="btn">Generate QR (JSON)</button>
        <button id="btnSaveCheckpoint" class="btn ghost">Simpan ke Daftar</button>
      </div>

      <div style="margin-top:10px;display:flex;gap:8px;align-items:center">
        <canvas id="qrCanvasManual" style="border:1px solid var(--border);background:#fff;border-radius:6px"></canvas>
        <div style="display:flex;flex-direction:column;gap:6px">
          <button id="btnDownloadQRManual" class="btn">Download QR</button>
          <button id="btnCopyQRDataManual" class="btn ghost">Copy QR DataURL</button>
          <button id="btnCopyQRContentManual" class="btn ghost">Copy QR Content</button>
        </div>
      </div>

      <div style="margin-top:10px">
        <label>Scanner (kamera langsung)</label>
        <video id="video" class="video-preview" autoplay muted playsinline></video>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="btnStartScan" class="btn ghost">Start Scan Camera</button>
          <button id="btnStopScan" class="btn ghost">Stop Scan</button>
          <input id="fileScanInput" type="file" accept="image/*" style="display:none">
          <button id="btnFileScan" class="btn ghost">Scan dari File/Galeri</button>
        </div>
        <div id="scanResult" class="muted" style="margin-top:8px">Hasil scan: â€”</div>
      </div>
    </div>

    <div id="lokasiTab" class="hidden">
      <label>Input Lokasi (untuk header cover)</label>
      <input id="manualLokasi" type="text" placeholder="Contoh: SEI JKT11">
      <div class="note">Isi lokasi ini akan tampil di cover PDF (override GPS jika diisi).</div>
    </div>

    <div id="fotoProfilTab" class="hidden">
      <h3>FOTO PROFIL COVER</h3>
      <p>Foto ini akan ditampilkan di halaman cover PDF</p>
      
      <div id="profilePhotoPreview" class="profile-photo-preview" style="display:none"></div>
      
      <div style="display:flex;gap:8px;margin-top:12px;flex-wrap:wrap">
        <button id="btnTakeProfilePhoto" class="btn">Ambil Foto (Kamera)</button>
        <button id="btnUploadProfilePhoto" class="btn ghost" style="display:none">Pilih dari Galeri</button>
      </div>
      
      <div class="note" style="margin-top:8px">
        <strong>Preview:</strong> Foto profil akan ditampilkan di sisi kanan cover PDF
      </div>
      
      <button id="btnRemoveProfilePhoto" class="btn danger" style="margin-top:8px;display:none">Hapus Foto Profil</button>
    </div>

    <div id="deepTab" class="hidden">
      <h3>DEEP CLEAN-UP</h3>
      <p>Hapus <strong>SEMUA DATA</strong> termasuk semua area, foto, logo, tanda tangan, password runtime. Aplikasi akan kembali seperti baru.</p>
      <div style="display:flex;gap:8px;margin-top:12px">
        <button id="btnDeepClean" class="btn danger">Deep Clean (OK)</button>
        <button id="btnDeepCancel" class="btn ghost">Batal</button>
      </div>
    </div>

    <hr style="margin:12px 0;border-color:var(--border)">
    <div class="note">Host via HTTPS (GitHub Pages) dan tes di Chrome Android untuk hasil terbaik.</div>
  </aside>

  <main class="card" style="flex:1 1 820px">
    <div style="display:flex;gap:8px;align-items:center;margin-bottom:12px">
      <div class="tab active" id="tabViewAreas">Daftar Area</div>
      <div class="tab" id="tabSignature">Tanda Tangan</div>
    </div>

    <section id="viewAreas">
      <div id="areasContainer" class="areas"></div>
    </section>

    <section id="viewSignature" class="hidden">
      <label>Nama pada tanda tangan</label>
      <input id="sigName" type="text" placeholder="Nama pada tanda tangan...">
      <div style="margin-top:8px"><canvas id="sigCanvas" class="signature-canvas" width="700" height="140"></canvas></div>
      <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
        <button id="btnClearSig" class="btn danger">Hapus</button>
        <button id="btnSaveSig" class="btn">Simpan Tanda Tangan</button>
        <div style="margin-left:12px"><div class="muted">Preview:</div><div id="sigPreview" class="sig-preview"></div></div>
      </div>
    </section>
  </main>
</div>

<!-- âœ… CHAT BUBBLE & PANEL -->
<button id="chatBubble" class="chat-bubble">
  <i class="fas fa-comments"></i>
</button>

<div id="chatPanel" class="chat-panel hidden">
  <div class="chat-header">
    <h3>Chat Patroli</h3>
    <button class="chat-close">&times;</button>
  </div>
  <div id="chatMessages" class="chat-messages"></div>
  <div class="chat-input-area">
    <input id="chatInput" type="text" class="chat-input" placeholder="Ketik pesan...">
    <button id="chatSend" class="chat-send">Kirim</button>
  </div>
</div>

<!-- âœ… CAMERA OVERLAY UNTUK SCAN QR -->
<div id="cameraOverlay" class="camera-overlay hidden">
  <div class="camera-container">
    <div class="camera-header">
      <h3 style="margin:0">Scan QR Code</h3>
      <button id="closeCamera" class="chat-close">&times;</button>
    </div>
    <video id="cameraVideo" class="camera-video" autoplay muted playsinline></video>
    <div class="scan-frame">
      <div class="scan-line"></div>
    </div>
    <div class="camera-controls">
      <button id="captureScan" class="btn">Capture & Scan</button>
      <button id="cancelScan" class="btn danger">Batal</button>
    </div>
  </div>
</div>

<div id="modalBackdrop" class="modal-backdrop">
  <div class="modal">
    <h3>DEEP CLEAN-UP</h3>
    <p>Hapus <strong>SEMUA DATA</strong> termasuk: semua area patroli, semua foto, logo, tanda tangan, password akses. Aplikasi akan kembali seperti baru! Yakin ingin melanjutkan?</p>
    <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
      <button id="modalCancel" class="btn ghost">Batal</button>
      <button id="modalOk" class="btn danger">OK</button>
    </div>
  </div>
</div>

<script>
/* âœ… ENHANCED PATROLI APP - WITH ENGINEERING TOOLS */
(function(){
  // âœ… FIREBASE READY CHECK
  function waitForFirebase() {
    return new Promise((resolve) => {
      const check = () => {
        if (window.firebase && firebase.database) {
          resolve();
        } else {
          setTimeout(check, 100);
        }
      };
      check();
    });
  }

  const $ = s => document.querySelector(s);
  const uid = (p='id')=> p+'-'+Math.random().toString(36).slice(2,9);
  const revoke = url => { try{ if(url) URL.revokeObjectURL(url);}catch(e){} };

  // âœ… MASTER PASSWORD
  const MASTER_PASSWORD = "raja7373";
  
  // âœ… DEVICE TEMPLATES (20+ templates)
  const DEVICE_TEMPLATES = {
    // Apple iPhone
    iphone_15: {
      name: "iPhone 15 Pro",
      type: "mobile",
      os: "iOS 17.1",
      browser: "Safari",
      userAgent: "Mozilla/5.0 (iPhone15,3; U; CPU iPhone OS 17_0 like Mac OS X) AppleWebKit/602.1.50 (KHTML, like Gecko) Version/17.0 Mobile/15E148 Safari/602.1"
    },
    iphone_14: {
      name: "iPhone 14",
      type: "mobile",
      os: "iOS 17.0",
      browser: "Safari",
      userAgent: "Mozilla/5.0 (iPhone14,2; U; CPU iPhone OS 17_0 like Mac OS X) AppleWebKit/602.1.50 (KHTML, like Gecko) Version/17.0 Mobile/15E148 Safari/602.1"
    },
    iphone_13: {
      name: "iPhone 13",
      type: "mobile",
      os: "iOS 16.0",
      browser: "Safari",
      userAgent: "Mozilla/5.0 (iPhone13,2; U; CPU iPhone OS 16_0 like Mac OS X) AppleWebKit/602.1.50 (KHTML, like Gecko) Version/16.0 Mobile/15E148 Safari/602.1"
    },
    iphone_se: {
      name: "iPhone SE",
      type: "mobile",
      os: "iOS 16.0",
      browser: "Safari",
      userAgent: "Mozilla/5.0 (iPhone12,1; U; CPU iPhone OS 16_0 like Mac OS X) AppleWebKit/602.1.50 (KHTML, like Gecko) Version/16.0 Mobile/15E148 Safari/602.1"
    },
    
    // Samsung Galaxy
    samsung_s24: {
      name: "Samsung Galaxy S24",
      type: "mobile",
      os: "Android 14",
      browser: "Chrome Mobile",
      userAgent: "Mozilla/5.0 (Linux; Android 14; SM-S921B) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.6099.210 Mobile Safari/537.36"
    },
    samsung_s23: {
      name: "Samsung Galaxy S23",
      type: "mobile",
      os: "Android 14",
      browser: "Chrome Mobile",
      userAgent: "Mozilla/5.0 (Linux; Android 14; SM-S911B) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.6099.210 Mobile Safari/537.36"
    },
    samsung_s22: {
      name: "Samsung Galaxy S22",
      type: "mobile",
      os: "Android 13",
      browser: "Chrome Mobile",
      userAgent: "Mozilla/5.0 (Linux; Android 13; SM-S901B) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/112.0.0.0 Mobile Safari/537.36"
    },
    samsung_a54: {
      name: "Samsung Galaxy A54",
      type: "mobile",
      os: "Android 13",
      browser: "Samsung Internet",
      userAgent: "Mozilla/5.0 (Linux; Android 13; SM-A546B) AppleWebKit/537.36 (KHTML, like Gecko) SamsungBrowser/21.0 Chrome/110.0.5481.154 Mobile Safari/537.36"
    },
    samsung_tab: {
      name: "Samsung Galaxy Tab S9",
      type: "tablet",
      os: "Android 13",
      browser: "Chrome",
      userAgent: "Mozilla/5.0 (Linux; Android 13; SM-X716B) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/112.0.0.0 Safari/537.36"
    },
    
    // Xiaomi/Realme/OPPO/Vivo
    xiaomi_13: {
      name: "Xiaomi 13 Pro",
      type: "mobile",
      os: "Android 13",
      browser: "Chrome Mobile",
      userAgent: "Mozilla/5.0 (Linux; Android 13; 2211133G) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/112.0.0.0 Mobile Safari/537.36"
    },
    xiaomi_12: {
      name: "Xiaomi 12",
      type: "mobile",
      os: "Android 12",
      browser: "Chrome Mobile",
      userAgent: "Mozilla/5.0 (Linux; Android 12; 2201123G) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/110.0.0.0 Mobile Safari/537.36"
    },
    realme_gt: {
      name: "Realme GT Neo 3",
      type: "mobile",
      os: "Android 13",
      browser: "Chrome Mobile",
      userAgent: "Mozilla/5.0 (Linux; Android 13; RMX3561) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/112.0.0.0 Mobile Safari/537.36"
    },
    oppo_find: {
      name: "OPPO Find X6",
      type: "mobile",
      os: "Android 13",
      browser: "Chrome Mobile",
      userAgent: "Mozilla/5.0 (Linux; Android 13; CPH2437) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/112.0.0.0 Mobile Safari/537.36"
    },
    vivo_x90: {
      name: "Vivo X90 Pro",
      type: "mobile",
      os: "Android 13",
      browser: "Chrome Mobile",
      userAgent: "Mozilla/5.0 (Linux; Android 13; V2218) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/112.0.0.0 Mobile Safari/537.36"
    },
    
    // Google Pixel
    pixel_8: {
      name: "Google Pixel 8 Pro",
      type: "mobile",
      os: "Android 14",
      browser: "Chrome Mobile",
      userAgent: "Mozilla/5.0 (Linux; Android 14; Pixel 8 Pro) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.6099.210 Mobile Safari/537.36"
    },
    pixel_7: {
      name: "Google Pixel 7",
      type: "mobile",
      os: "Android 13",
      browser: "Chrome Mobile",
      userAgent: "Mozilla/5.0 (Linux; Android 13; Pixel 7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/112.0.0.0 Mobile Safari/537.36"
    },
    pixel_6: {
      name: "Google Pixel 6",
      type: "mobile",
      os: "Android 12",
      browser: "Chrome Mobile",
      userAgent: "Mozilla/5.0 (Linux; Android 12; Pixel 6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/110.0.0.0 Mobile Safari/537.36"
    },
    
    // Desktop/Laptop
    windows_chrome: {
      name: "Windows PC - Chrome",
      type: "desktop",
      os: "Windows 11",
      browser: "Chrome",
      userAgent: "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36"
    },
    windows_edge: {
      name: "Windows PC - Edge",
      type: "desktop",
      os: "Windows 11",
      browser: "Edge",
      userAgent: "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36 Edg/120.0.0.0"
    },
    windows_firefox: {
      name: "Windows PC - Firefox",
      type: "desktop",
      os: "Windows 10",
      browser: "Firefox",
      userAgent: "Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:109.0) Gecko/20100101 Firefox/121.0"
    },
    mac_safari: {
      name: "MacBook - Safari",
      type: "desktop",
      os: "macOS 14",
      browser: "Safari",
      userAgent: "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.0 Safari/605.1.15"
    },
    mac_chrome: {
      name: "MacBook - Chrome",
      type: "desktop",
      os: "macOS 14",
      browser: "Chrome",
      userAgent: "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36"
    },
    linux_firefox: {
      name: "Linux PC - Firefox",
      type: "desktop",
      os: "Ubuntu 22.04",
      browser: "Firefox",
      userAgent: "Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:109.0) Gecko/20100101 Firefox/121.0"
    },
    
    // Other
    gaming_pc: {
      name: "Gaming PC",
      type: "desktop",
      os: "Windows 11",
      browser: "Chrome",
      userAgent: "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36"
    },
    smart_tv: {
      name: "Smart TV",
      type: "tv",
      os: "Android TV",
      browser: "TV Browser",
      userAgent: "Mozilla/5.0 (Linux; Android 11; Mi TV) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/100.0.4896.127 Safari/537.36"
    },
    
    // Custom Template
    custom: {
      name: "Custom Device",
      type: "custom",
      os: "",
      browser: "",
      userAgent: ""
    }
  };

  const state = {
    isAdmin: false,
    adminPassword: window.__patrol_admin_password ?? 'raja7373',
    areas: [],
    checkpoints: [],
    gpsPath: [], // âœ… REKAM SEMUA TITIK (no filter)
    signature: null,
    profilePhoto: null,
    
    // âœ… NEW: Enhanced state
    deviceInfo: null,
    spoofedDevice: null,
    exifData: new Map(),
    modifiedEXIF: new Map(), // Untuk EXIF yang diedit
    currentEXIFSettings: {
      gps: null,
      make: "",
      model: "",
      dateTime: ""
    },
    
    // Chat state
    chatOpen: false,
    unreadCount: 0,
    lastDelivered: 0
  };

  const refs = {
    // Existing refs
    modeDisplay: $('#modeDisplay'), btnToggleMode: $('#btnToggleMode'),
    btnStartGPS: $('#btnStartGPS'), gpsStatus: $('#gpsStatus'), coords: $('#coords'),
    btnAddArea: $('#btnAddArea'), newAreaName: $('#newAreaName'), newAreaDetail: $('#newAreaDetail'), areasContainer: $('#areasContainer'),
    tabAreas: $('#tabAreas'), tabCheckpoint: $('#tabCheckpoint'), tabLokasi: $('#tabLokasi'), tabFotoProfil: $('#tabFotoProfil'), tabDeep: $('#tabDeep'),
    areaTab: $('#areaTab'), checkpointTab: $('#checkpointTab'), lokasiTab: $('#lokasiTab'), fotoProfilTab: $('#fotoProfilTab'), deepTab: $('#deepTab'),
    btnScanAreaQR: $('#btnScanAreaQR'),
    btnGenerateQRManual: $('#btnGenerateQRManual'), qrCanvasManual: $('#qrCanvasManual'), btnDownloadQRManual: $('#btnDownloadQRManual'),
    btnCopyQRDataManual: $('#btnCopyQRDataManual'), btnCopyQRContentManual: $('#btnCopyQRContentManual'), btnSaveCheckpoint: $('#btnSaveCheckpoint'),
    qrAreaName: $('#qrAreaName'), qrAreaDetail: $('#qrAreaDetail'),
    btnLogin: $('#btnLogin'), btnLogout: $('#btnLogout'), adminPass: $('#adminPass'),
    btnGeneratePDF: $('#btnGeneratePDF'),
    tabViewAreas: $('#tabViewAreas'), tabSignature: $('#tabSignature'), viewAreas: $('#viewAreas'), viewSignature: $('#viewSignature'),
    sigCanvas: $('#sigCanvas'), btnClearSig: $('#btnClearSig'), btnSaveSig: $('#btnSaveSig'), sigPreview: $('#sigPreview'), sigName: $('#sigName'),
    btnDeepClean: $('#btnDeepClean'), btnDeepCancel: $('#btnDeepCancel'),
    modalBackdrop: $('#modalBackdrop'), modalOk: $('#modalOk'), modalCancel: $('#modalCancel'),
    manualLokasi: $('#manualLokasi'), officerName: $('#officerName'), shift: $('#shift'), date: $('#date'),
    video: $('#video'), btnStartScan: $('#btnStartScan'), btnStopScan: $('#btnStopScan'), scanResult: $('#scanResult'),
    fileScanInput: $('#fileScanInput'), btnFileScan: $('#btnFileScan'), qrList: $('#qrList'),
    btnTakeProfilePhoto: $('#btnTakeProfilePhoto'), btnUploadProfilePhoto: $('#btnUploadProfilePhoto'),
    btnRemoveProfilePhoto: $('#btnRemoveProfilePhoto'), profilePhotoPreview: $('#profilePhotoPreview'),
    chatBubble: $('#chatBubble'), chatPanel: $('#chatPanel'), chatMessages: $('#chatMessages'),
    chatInput: $('#chatInput'), chatSend: $('#chatSend'), chatClose: $('.chat-close'),
    cameraOverlay: $('#cameraOverlay'), cameraVideo: $('#cameraVideo'),
    closeCamera: $('#closeCamera'), captureScan: $('#captureScan'), cancelScan: $('#cancelScan'),
    
    // âœ… NEW: Enhanced UI refs
    deviceBadge: $('#deviceBadge'),
    deviceText: $('#deviceText'),
    gpsQualityBadge: $('#gpsQualityBadge'),
    adminAccessArea: $('#adminAccessArea'),
    adminModal: $('#adminModal'),
    exifViewerModal: $('#exifViewerModal'),
    exifViewerContent: $('#exifViewerContent'),
    
    // Admin modal elements
    deviceTemplate: $('#deviceTemplate'),
    customDeviceFields: $('#customDeviceFields'),
    customDeviceName: $('#customDeviceName'),
    customDeviceType: $('#customDeviceType'),
    customDeviceOS: $('#customDeviceOS'),
    customDeviceBrowser: $('#customDeviceBrowser'),
    customUserAgent: $('#customUserAgent'),
    btnApplyDevice: $('#btnApplyDevice'),
    btnResetDevice: $('#btnResetDevice'),
    exifLat: $('#exifLat'),
    exifLon: $('#exifLon'),
    exifMake: $('#exifMake'),
    exifModel: $('#exifModel'),
    exifDateTime: $('#exifDateTime'),
    btnUseCurrentGPS: $('#btnUseCurrentGPS'),
    btnApplyEXIF: $('#btnApplyEXIF'),
    btnViewEXIF: $('#btnViewEXIF'),
    btnCloseAdmin: $('#btnCloseAdmin'),
    btnCloseEXIFViewer: $('#btnCloseEXIFViewer'),
    systemInfo: $('#systemInfo'),
    realDeviceInfo: $('#realDeviceInfo'),
    spoofedDeviceInfo: $('#spoofedDeviceInfo'),
    gpsPointsCount: $('#gpsPointsCount'),
    exifPhotosCount: $('#exifPhotosCount')
  };

  // âœ… NEW: Device Detection Function
  function detectRealDevice() {
    try {
      const ua = navigator.userAgent;
      let browserName = 'Unknown';
      let browserVersion = '';
      
      // Detect browser
      if (ua.includes('Chrome') && !ua.includes('Edg')) browserName = 'Chrome';
      else if (ua.includes('Firefox')) browserName = 'Firefox';
      else if (ua.includes('Safari') && !ua.includes('Chrome')) browserName = 'Safari';
      else if (ua.includes('Edg')) browserName = 'Edge';
      else if (ua.includes('Opera') || ua.includes('OPR')) browserName = 'Opera';
      
      // Detect OS and device type
      let os = 'Unknown';
      let deviceType = 'desktop';
      
      if (ua.includes('Android')) {
        os = 'Android';
        deviceType = 'mobile';
      } else if (ua.includes('iPhone') || ua.includes('iPad')) {
        os = 'iOS';
        deviceType = /iPad/.test(ua) ? 'tablet' : 'mobile';
      } else if (ua.includes('Windows')) {
        os = 'Windows';
      } else if (ua.includes('Mac OS')) {
        os = 'macOS';
      } else if (ua.includes('Linux')) {
        os = 'Linux';
      }
      
      state.deviceInfo = {
        name: `${browserName} on ${os}`,
        type: deviceType,
        os: os,
        browser: browserName,
        userAgent: ua.substring(0, 100) + (ua.length > 100 ? '...' : ''),
        isReal: true,
        timestamp: Date.now()
      };
      
      updateDeviceBadge();
      return state.deviceInfo;
      
    } catch (e) {
      console.warn('Device detection failed:', e);
      return null;
    }
  }

  // âœ… NEW: Update Device Badge
  function updateDeviceBadge() {
    const device = state.spoofedDevice || state.deviceInfo;
    if (!device) return;
    
    const deviceTypeIcon = device.type === 'mobile' ? 'ðŸ“±' : 
                          device.type === 'tablet' ? 'ðŸ“±' : 'ðŸ’»';
    
    refs.deviceText.textContent = `${deviceTypeIcon} ${device.browser} on ${device.os}`;
    refs.deviceBadge.classList.remove('hidden');
    
    // Update system info
    if (refs.realDeviceInfo) {
      refs.realDeviceInfo.textContent = `${state.deviceInfo?.browser || 'Unknown'} on ${state.deviceInfo?.os || 'Unknown'}`;
    }
    if (refs.spoofedDeviceInfo) {
      refs.spoofedDeviceInfo.textContent = state.spoofedDevice ? 
        `${state.spoofedDevice.browser} on ${state.spoofedDevice.os}` : 'None';
    }
  }

  // âœ… NEW: Update GPS Quality Indicator
  function updateGPSQualityIndicator(accuracy) {
    if (!accuracy || !refs.gpsQualityBadge) return;
    
    let qualityClass = 'gps-poor';
    let qualityText = 'Poor';
    
    if (accuracy <= 10) {
      qualityClass = 'gps-excellent';
      qualityText = 'Excellent';
    } else if (accuracy <= 25) {
      qualityClass = 'gps-good';
      qualityText = 'Good';
    } else if (accuracy <= 50) {
      qualityClass = 'gps-fair';
      qualityText = 'Fair';
    }
    
    refs.gpsQualityBadge.className = `gps-indicator ${qualityClass}`;
    refs.gpsQualityBadge.textContent = qualityText;
    refs.gpsQualityBadge.classList.remove('hidden');
  }

  // âœ… NEW: EXIF Metadata Extraction
  function extractEXIFMetadata(file) {
    return new Promise((resolve) => {
      try {
        EXIF.getData(file, function() {
          const allTags = EXIF.getAllTags(this);
          const exifData = {};
          
          if (allTags) {
            // Camera info
            if (allTags.Make) exifData.make = allTags.Make;
            if (allTags.Model) exifData.model = allTags.Model;
            if (allTags.Software) exifData.software = allTags.Software;
            
            // Date and time
            if (allTags.DateTimeOriginal) exifData.dateTimeOriginal = allTags.DateTimeOriginal;
            if (allTags.DateTime) exifData.dateTime = allTags.DateTime;
            
            // Camera settings
            if (allTags.ExposureTime) exifData.exposureTime = allTags.ExposureTime;
            if (allTags.FNumber) exifData.fNumber = allTags.FNumber;
            if (allTags.ISOSpeedRatings) exifData.iso = allTags.ISOSpeedRatings;
            if (allTags.FocalLength) exifData.focalLength = allTags.FocalLength;
            
            // GPS data
            if (allTags.GPSLatitude && allTags.GPSLongitude) {
              const lat = EXIF.getTag(this, "GPSLatitude");
              const lon = EXIF.getTag(this, "GPSLongitude");
              const latRef = EXIF.getTag(this, "GPSLatitudeRef") || 'N';
              const lonRef = EXIF.getTag(this, "GPSLongitudeRef") || 'E';
              
              const latDecimal = convertGPSToDecimal(lat, latRef);
              const lonDecimal = convertGPSToDecimal(lon, lonRef);
              
              if (latDecimal && lonDecimal) {
                exifData.gps = {
                  latitude: latDecimal,
                  longitude: lonDecimal,
                  latitudeRef: latRef,
                  longitudeRef: lonRef
                };
              }
            }
          }
          
          resolve(exifData);
        });
      } catch (e) {
        console.warn('EXIF extraction failed:', e);
        resolve({});
      }
    });
  }

  // âœ… NEW: Convert GPS to decimal
  function convertGPSToDecimal(gpsArray, ref) {
    if (!gpsArray || !Array.isArray(gpsArray) || gpsArray.length < 3) return null;
    
    try {
      const degrees = Number(gpsArray[0]) || 0;
      const minutes = Number(gpsArray[1]) || 0;
      const seconds = Number(gpsArray[2]) || 0;
      
      let decimal = degrees + minutes / 60 + seconds / 3600;
      
      if (ref === 'S' || ref === 'W') {
        decimal = -decimal;
      }
      
      return decimal;
    } catch (e) {
      return null;
    }
  }

  // âœ… NEW: Apply EXIF settings to photos
  function applyEXIFSettingsToPhoto(file, originalEXIF) {
    const modified = state.modifiedEXIF.get('current_settings') || state.currentEXIFSettings;
    
    if (!modified || Object.keys(modified).length === 0) {
      return originalEXIF;
    }
    
    const result = { ...originalEXIF };
    
    // Apply GPS if set
    if (modified.gps && modified.gps.latitude && modified.gps.longitude) {
      result.gps = modified.gps;
    }
    
    // Apply camera make/model
    if (modified.make) result.make = modified.make;
    if (modified.model) result.model = modified.model;
    
    // Apply date/time
    if (modified.dateTime) {
      result.dateTime = modified.dateTime;
      result.dateTimeOriginal = modified.dateTime;
    }
    
    return result;
  }

  // âœ… NEW: Show EXIF Viewer
  function showEXIFViewer(exifData) {
    if (!exifData || Object.keys(exifData).length === 0) {
      refs.exifViewerContent.textContent = 'No EXIF metadata available';
    } else {
      const formatted = JSON.stringify(exifData, null, 2);
      refs.exifViewerContent.textContent = formatted;
    }
    refs.exifViewerModal.classList.remove('hidden');
  }

  // âœ… NEW: Admin Access System
  let adminTapCount = 0;
  let adminTapTimer = null;
  
  refs.adminAccessArea.addEventListener('click', () => {
    adminTapCount++;
    
    if (adminTapTimer) {
      clearTimeout(adminTapTimer);
    }
    
    adminTapTimer = setTimeout(() => {
      adminTapCount = 0;
    }, 2000);
    
    if (adminTapCount >= 5) {
      adminTapCount = 0;
      showPasswordPrompt();
    }
  });

  function showPasswordPrompt() {
    const password = prompt("ðŸ”§ Enter Admin Password:");
    if (password === MASTER_PASSWORD) {
      showAdminTools();
    } else if (password) {
      alert("Wrong password!");
    }
  }

  function showAdminTools() {
    // Update system info
    refs.gpsPointsCount.textContent = state.gpsPath.length;
    refs.exifPhotosCount.textContent = state.exifData.size;
    
    // Show modal
    refs.adminModal.classList.remove('hidden');
  }

  // âœ… NEW: Initialize Admin Tools
  function initAdminTools() {
    // Device template change handler
    refs.deviceTemplate.addEventListener('change', function() {
      const templateId = this.value;
      
      if (templateId === 'custom') {
        refs.customDeviceFields.classList.remove('hidden');
        
        // Set default values for custom
        refs.customDeviceName.value = '';
        refs.customDeviceType.value = 'mobile';
        refs.customDeviceOS.value = '';
        refs.customDeviceBrowser.value = '';
        refs.customUserAgent.value = '';
      } else if (templateId && DEVICE_TEMPLATES[templateId]) {
        refs.customDeviceFields.classList.add('hidden');
        const template = DEVICE_TEMPLATES[templateId];
        
        // Auto-fill custom fields if needed
        refs.customDeviceName.value = template.name;
        refs.customDeviceType.value = template.type;
        refs.customDeviceOS.value = template.os;
        refs.customDeviceBrowser.value = template.browser;
        refs.customUserAgent.value = template.userAgent;
      } else {
        refs.customDeviceFields.classList.add('hidden');
      }
    });
    
    // Apply device spoofing
    refs.btnApplyDevice.addEventListener('click', () => {
      const templateId = refs.deviceTemplate.value;
      
      if (!templateId) {
        alert('Pilih template device terlebih dahulu!');
        return;
      }
      
      let deviceData;
      
      if (templateId === 'custom') {
        // Use custom input
        deviceData = {
          name: refs.customDeviceName.value || 'Custom Device',
          type: refs.customDeviceType.value || 'mobile',
          os: refs.customDeviceOS.value || 'Custom OS',
          browser: refs.customDeviceBrowser.value || 'Custom Browser',
          userAgent: refs.customUserAgent.value || navigator.userAgent,
          isSpoofed: true,
          timestamp: Date.now()
        };
      } else {
        // Use template
        deviceData = {
          ...DEVICE_TEMPLATES[templateId],
          isSpoofed: true,
          timestamp: Date.now()
        };
      }
      
      state.spoofedDevice = deviceData;
      updateDeviceBadge();
      alert(`Device spoofed to: ${deviceData.name}`);
    });
    
    // Reset device spoofing
    refs.btnResetDevice.addEventListener('click', () => {
      state.spoofedDevice = null;
      refs.deviceTemplate.value = '';
      refs.customDeviceFields.classList.add('hidden');
      updateDeviceBadge();
      alert('Device reset to real values');
    });
    
    // Use current GPS for EXIF
    refs.btnUseCurrentGPS.addEventListener('click', () => {
      if (state.gpsPath.length === 0) {
        alert('Tidak ada data GPS yang tersedia!');
        return;
      }
      
      const lastPoint = state.gpsPath[state.gpsPath.length - 1];
      refs.exifLat.value = lastPoint.lat;
      refs.exifLon.value = lastPoint.lon;
      
      alert('GPS current location applied!');
    });
    
    // Apply EXIF settings
    refs.btnApplyEXIF.addEventListener('click', () => {
      const lat = parseFloat(refs.exifLat.value);
      const lon = parseFloat(refs.exifLon.value);
      
      state.currentEXIFSettings = {
        gps: !isNaN(lat) && !isNaN(lon) ? { latitude: lat, longitude: lon } : null,
        make: refs.exifMake.value.trim(),
        model: refs.exifModel.value.trim(),
        dateTime: refs.exifDateTime.value
      };
      
      // Store for future photos
      state.modifiedEXIF.set('current_settings', state.currentEXIFSettings);
      
      alert('EXIF settings applied! Settings will be used for next photos.');
    });
    
    // View EXIF
    refs.btnViewEXIF.addEventListener('click', () => {
      if (state.exifData.size === 0) {
        alert('Belum ada foto dengan EXIF metadata!');
        return;
      }
      
      // Get last EXIF data
      const lastEntry = Array.from(state.exifData.entries()).pop();
      showEXIFViewer(lastEntry[1]);
    });
    
    // Close admin tools
    refs.btnCloseAdmin.addEventListener('click', () => {
      refs.adminModal.classList.add('hidden');
    });
    
    // Close EXIF viewer
    refs.btnCloseEXIFViewer.addEventListener('click', () => {
      refs.exifViewerModal.classList.add('hidden');
    });
    
    // Set current datetime in EXIF editor
    refs.exifDateTime.value = new Date().toISOString().slice(0, 16);
  }

  // âœ… MODIFIED: Enhanced GPS Tracking - REKAM SEMUA TITIK
  let watchId = null;
  refs.btnStartGPS.addEventListener('click', () => { 
    if(!navigator.geolocation){ 
      alert('Geolocation tidak didukung browser ini'); 
      return; 
    } 
    
    refs.btnStartGPS.style.display='none'; 
    refs.gpsStatus.textContent='GPS: aktif'; 
    
    watchId = navigator.geolocation.watchPosition(
      pos => { 
        const lat = pos.coords.latitude, 
              lon = pos.coords.longitude,
              accuracy = pos.coords.accuracy,
              ts = pos.timestamp || Date.now(); 
              
        refs.coords.textContent = lat.toFixed(6) + ', ' + lon.toFixed(6) + ' (Acc: ' + Math.round(accuracy) + 'm)'; 
        
        // âœ… REKAM SEMUA TITIK (NO FILTER)
        state.gpsPath.push({
          lat, 
          lon, 
          accuracy,
          timestamp: ts
        });
        
        // Update GPS quality indicator
        updateGPSQualityIndicator(accuracy);
        
        // Update system info
        if (!refs.adminModal.classList.contains('hidden')) {
          refs.gpsPointsCount.textContent = state.gpsPath.length;
        }
      }, 
      err => { 
        console.warn(err); 
        refs.gpsStatus.textContent='GPS: error - ' + (err.message || 'unknown error');
      }, 
      {
        enableHighAccuracy: true,
        maximumAge: 10000,
        timeout: 15000
      }
    ); 
  });

  // âœ… MODIFIED: Auto start GPS
  window.addEventListener('load', function() {
    setTimeout(function() {
      if (refs.btnStartGPS && !watchId) {
        console.log('Auto-starting GPS...');
        refs.btnStartGPS.click();
      }
    }, 1500);
  });

  // âœ… EXISTING FUNCTIONS (TIDAK DIUBAH)
  function colorForId(id){ let h=0; for(let i=0;i<id.length;i++) h=(h<<5)-h+id.charCodeAt(i); return 'hsl('+ (Math.abs(h)%360) +',68%,36%)'; }
  
  function updateModeUI(){ 
    refs.modeDisplay.textContent = 'Mode: ' + (state.isAdmin ? 'Admin' : 'User'); 
    refs.btnToggleMode.textContent = state.isAdmin ? 'Masuk User' : 'Masuk Admin'; 
    refs.btnLogout.style.display = state.isAdmin ? 'inline-block' : 'none'; 
    refs.btnLogin.style.display = state.isAdmin ? 'none' : 'inline-block'; 
    refs.btnUploadProfilePhoto.style.display = state.isAdmin ? 'inline-block' : 'none';
    renderAreas(); 
    renderCheckpointList(); 
    renderProfilePhoto(); 
  }

  // Admin login/logout (existing)
  refs.btnToggleMode.addEventListener('click', ()=>{ 
    if(!state.isAdmin){ 
      const p = prompt('Password Admin:'); 
      if(p===null) return; 
      if(p === state.adminPassword){ 
        state.isAdmin = true; 
        updateModeUI(); 
        alert('Admin login berhasil'); 
      } else alert('Password salah'); 
    } else { 
      state.isAdmin = false; 
      refs.adminPass.value = '';
      updateModeUI(); 
      alert('Mode User aktif'); 
    } 
  });

  refs.btnLogin.addEventListener('click', ()=>{ 
    const p = refs.adminPass.value||''; 
    if(p === state.adminPassword){ 
      state.isAdmin = true; 
      refs.adminPass.value=''; 
      updateModeUI(); 
      alert('Admin login berhasil'); 
    } else alert('Password salah'); 
  });

  refs.btnLogout.addEventListener('click', ()=>{ 
    state.isAdmin = false; 
    refs.adminPass.value = '';
    updateModeUI(); 
    alert('Logout berhasil'); 
  });

  // Tab switching (existing)
  refs.tabAreas.addEventListener('click', ()=>{ 
    refs.areaTab.classList.remove('hidden'); 
    refs.checkpointTab.classList.add('hidden'); 
    refs.lokasiTab.classList.add('hidden'); 
    refs.fotoProfilTab.classList.add('hidden'); 
    refs.deepTab.classList.add('hidden'); 
    updateActiveTab(refs.tabAreas);
  });
  
  refs.tabCheckpoint.addEventListener('click', ()=>{ 
    refs.areaTab.classList.add('hidden'); 
    refs.checkpointTab.classList.remove('hidden'); 
    refs.lokasiTab.classList.add('hidden'); 
    refs.fotoProfilTab.classList.add('hidden'); 
    refs.deepTab.classList.add('hidden'); 
    updateActiveTab(refs.tabCheckpoint);
  });
  
  refs.tabLokasi.addEventListener('click', ()=>{ 
    refs.areaTab.classList.add('hidden'); 
    refs.checkpointTab.classList.add('hidden'); 
    refs.lokasiTab.classList.remove('hidden'); 
    refs.fotoProfilTab.classList.add('hidden'); 
    refs.deepTab.classList.add('hidden'); 
    updateActiveTab(refs.tabLokasi);
  });
  
  refs.tabFotoProfil.addEventListener('click', ()=>{ 
    refs.areaTab.classList.add('hidden'); 
    refs.checkpointTab.classList.add('hidden'); 
    refs.lokasiTab.classList.add('hidden'); 
    refs.fotoProfilTab.classList.remove('hidden'); 
    refs.deepTab.classList.add('hidden'); 
    updateActiveTab(refs.tabFotoProfil);
  });
  
  refs.tabDeep.addEventListener('click', ()=>{ 
    refs.areaTab.classList.add('hidden'); 
    refs.checkpointTab.classList.add('hidden'); 
    refs.lokasiTab.classList.add('hidden'); 
    refs.fotoProfilTab.classList.add('hidden'); 
    refs.deepTab.classList.remove('hidden'); 
    updateActiveTab(refs.tabDeep);
  });
  
  refs.tabViewAreas.addEventListener('click', ()=>{ 
    refs.viewAreas.classList.remove('hidden'); 
    refs.viewSignature.classList.add('hidden'); 
    updateActiveTab(refs.tabViewAreas, 'view');
  });
  
  refs.tabSignature.addEventListener('click', ()=>{ 
    refs.viewAreas.classList.add('hidden'); 
    refs.viewSignature.classList.remove('hidden'); 
    updateActiveTab(refs.tabSignature, 'view');
  });

  function updateActiveTab(activeTab, type = 'main') {
    const tabs = type === 'view' 
      ? [refs.tabViewAreas, refs.tabSignature]
      : [refs.tabAreas, refs.tabCheckpoint, refs.tabLokasi, refs.tabFotoProfil, refs.tabDeep];
    
    tabs.forEach(tab => {
      if (tab === activeTab) {
        tab.classList.add('active');
      } else {
        tab.classList.remove('active');
      }
    });
  }

  // Area management (existing)
  refs.btnAddArea.addEventListener('click', ()=>{ addArea(refs.newAreaName.value.trim()||undefined, refs.newAreaDetail.value.trim()||undefined); refs.newAreaName.value=''; refs.newAreaDetail.value=''; });
  
  function addArea(name, detail){
    const id = uid('area'); 
    state.areas.push({
      id,
      name: name || ('Area '+(state.areas.length+1)), 
      detail: detail||'', 
      description:'', 
      photos:[]
    }); 
    renderAreas();
  }

  // âœ… MODIFIED: Enhanced renderAreas dengan EXIF badge
  function renderAreas(){
    refs.areasContainer.innerHTML = '';
    state.areas.forEach(area=>{
      const wrapper = document.createElement('div'); wrapper.className='area';
      const h = document.createElement('div'); h.className='area-header';
      const title = document.createElement('div'); title.className='area-title'; title.textContent = area.name + (area.detail ? ' â€” ' + area.detail : ''); title.style.background = colorForId(area.id);
      h.appendChild(title);
      const actions = document.createElement('div');
      const editBtn = document.createElement('button'); editBtn.className='icon-btn'; editBtn.innerHTML='<i class="fa fa-pen"></i>'; editBtn.title='Edit nama area';
      editBtn.onclick = ()=>{ const nv = prompt('Edit nama area:', area.name); if(nv!==null){ area.name = nv; renderAreas(); } };
      const qrBtn = document.createElement('button'); qrBtn.className='icon-btn'; qrBtn.innerHTML='<i class="fa fa-qrcode"></i>'; qrBtn.title='Scan QR to fill area';
      qrBtn.onclick = async ()=>{ 
        try{ 
          const content = await startScanOne(false); 
          if(!content) return; 
          try{ 
            const p = JSON.parse(content); 
            if(p && p.area){ 
              area.name = p.area; 
              area.detail = p.detail||area.detail; 
              renderAreas(); 
              alert('Area terisi dari QR'); 
              return; 
            } 
          }catch(e){ 
            area.name = content; 
            renderAreas(); 
            alert('Area terisi: '+content); 
          } 
        } catch(e){ 
          alert('Scan QR gagal: '+(e.message||e)); 
        } 
      };
      const delBtn = document.createElement('button'); delBtn.className='icon-btn'; delBtn.innerHTML='<i class="fa fa-trash" style="color:#b91c1c"></i>'; delBtn.title='Hapus area';
      delBtn.onclick = ()=>{ if(confirm('Hapus area & semua fotonya?')){ area.photos.forEach(p=>revoke(p.url)); state.areas = state.areas.filter(x=>x.id!==area.id); renderAreas(); } };
      actions.appendChild(editBtn); actions.appendChild(qrBtn); actions.appendChild(delBtn);
      h.appendChild(actions); wrapper.appendChild(h);

      const pc = document.createElement('div'); pc.className='photo-controls';
      if(state.isAdmin){
        const galBtn = document.createElement('button'); galBtn.className='btn ghost'; galBtn.textContent='Pilih dari Galeri (multiple)';
        galBtn.onclick = async ()=>{ const r = await createFileInput({allowGallery:true,multiple:true}); await handleFiles(area.id,r.files,r.pos); };
        const camBtn = document.createElement('button'); camBtn.className='btn ghost'; camBtn.textContent='Ambil Foto (kamera)';
        camBtn.onclick = async ()=>{ const r = await createFileInput({allowGallery:false,multiple:false}); await handleFiles(area.id,r.files,r.pos); };
        pc.appendChild(galBtn); pc.appendChild(camBtn);
      } else {
        const camBtn = document.createElement('button'); camBtn.className='btn ghost'; camBtn.textContent='Ambil Foto (kamera)';
        camBtn.onclick = async ()=>{ const r = await createFileInput({allowGallery:false,multiple:false}); await handleFiles(area.id,r.files,r.pos); };
        pc.appendChild(camBtn);
      }
      wrapper.appendChild(pc);

      const photosWrap = document.createElement('div'); photosWrap.className='photos';
      area.photos.forEach(p=>{
        const col = document.createElement('div'); col.style.width='170px';
        const photoItem = document.createElement('div'); photoItem.className='photo-item';
        const img = document.createElement('img'); img.src = p.url; photoItem.appendChild(img);
        
        // âœ… NEW: Add EXIF badge jika foto punya GPS dari EXIF
        if (p.exif && p.exif.gps) {
          const exifBadge = document.createElement('div');
          exifBadge.className = 'exif-badge';
          exifBadge.textContent = 'ðŸ“ EXIF';
          exifBadge.title = 'GPS dari metadata EXIF';
          exifBadge.onclick = (e) => {
            e.stopPropagation();
            showEXIFViewer(p.exif);
          };
          photoItem.appendChild(exifBadge);
        }
        
        const actionWrap = document.createElement('div'); actionWrap.style.position='absolute'; actionWrap.style.left='6px'; actionWrap.style.bottom='6px'; actionWrap.style.display='flex'; actionWrap.style.gap='6px';
        const del = document.createElement('button'); del.className='icon-btn'; del.innerHTML='<i class="fa fa-trash" style="color:#b91c1c"></i>';
        del.onclick = ()=>{ if(confirm('Hapus foto?')){ area.photos = area.photos.filter(pp=>pp.id!==p.id); revoke(p.url); renderAreas(); } };
        const edit = document.createElement('button'); edit.className='icon-btn'; edit.innerHTML='<i class="fa fa-pen" style="color:#0b1228"></i>';
        edit.onclick = ()=>{ 
          const modal = document.createElement('div');
          modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 10000;';
          
          const modalContent = document.createElement('div');
          modalContent.style.cssText = 'background: var(--card); padding: 20px; border-radius: 12px; width: 90%; max-width: 600px; max-height: 80vh; overflow: auto; border: 2px solid var(--primary);';
          
          modalContent.innerHTML = `
            <h3 style="margin: 0 0 15px 0; color: var(--text);">Edit Deskripsi Foto</h3>
            <textarea id="descEditTextarea" style="width: 100%; height: 200px; padding: 12px; border-radius: 8px; border: 1px solid var(--border); background: #fff; color: #000; font-size: 14px; resize: vertical;" placeholder="Masukkan deskripsi foto...">${p.desc || ''}</textarea>
            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 15px;">
              <button id="descEditCancel" class="btn danger" style="padding: 10px 20px;">Batal</button>
              <button id="descEditSave" class="btn" style="padding: 10px 20px;">Simpan</button>
            </div>
          `;
          
          modal.appendChild(modalContent);
          document.body.appendChild(modal);
          
          const textarea = modal.querySelector('#descEditTextarea');
          textarea.focus();
          textarea.select();
          
          modal.querySelector('#descEditCancel').onclick = () => {
            document.body.removeChild(modal);
          };
          
          modal.querySelector('#descEditSave').onclick = () => {
            const newDesc = textarea.value.trim();
            p.desc = newDesc;
            renderAreas();
            document.body.removeChild(modal);
          };
          
          modal.onclick = (e) => {
            if (e.target === modal) {
              document.body.removeChild(modal);
            }
          };
          
          textarea.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && e.ctrlKey) {
              e.preventDefault();
              modal.querySelector('#descEditSave').click();
            }
            if (e.key === 'Escape') {
              e.preventDefault();
              modal.querySelector('#descEditCancel').click();
            }
          });
        };
        
        // âœ… NEW: EXIF View button
        const exifBtn = document.createElement('button');
        exifBtn.className='icon-btn';
        exifBtn.innerHTML='<i class="fa fa-info-circle" style="color:#00d4ff"></i>';
        exifBtn.title = "View EXIF Metadata";
        exifBtn.onclick = (e) => {
          e.stopPropagation();
          if (p.exif) {
            showEXIFViewer(p.exif);
          } else {
            alert('Foto ini tidak memiliki metadata EXIF');
          }
        };
        
        actionWrap.appendChild(del); 
        actionWrap.appendChild(edit);
        actionWrap.appendChild(exifBtn); // âœ… Added EXIF button
        photoItem.appendChild(actionWrap);
        
        const meta = document.createElement('div'); meta.className='photo-meta';
        meta.innerHTML = `<div style="font-weight:700">${p.desc || '(klik pensil untuk deskripsi)'}</div>
          <div style="font-size:11px;color:#555">${p.lat? p.lat.toFixed(6): '-'}, ${p.lon? p.lon.toFixed(6): '-'}<br>${p.ts? new Date(p.ts).toLocaleString(): ''}</div>`;
        col.appendChild(photoItem); col.appendChild(meta); photosWrap.appendChild(col);
      });
      wrapper.appendChild(photosWrap);

      const ta = document.createElement('textarea'); ta.placeholder='Deskripsi area...'; ta.value = area.description || ''; ta.oninput = ()=> area.description = ta.value;
      const saveBtn = document.createElement('button'); saveBtn.className='btn'; saveBtn.textContent='Simpan Deskripsi Area'; saveBtn.style.marginTop='8px'; saveBtn.onclick = ()=> alert('Deskripsi area disimpan');
      wrapper.appendChild(ta); wrapper.appendChild(saveBtn);

      refs.areasContainer.appendChild(wrapper);
    });
  }

  function createFileInput(opts){
    return new Promise(resolve=>{
      function getPos(cb){ 
        if(navigator.geolocation){ 
          navigator.geolocation.getCurrentPosition(
            p=>cb({lat:p.coords.latitude,lon:p.coords.longitude,ts:p.timestamp}), 
            ()=>cb(null), 
            {enableHighAccuracy:true,timeout:4000}
          ); 
        } else cb(null); 
      }
      getPos(function(pos){
        const inp = document.createElement('input'); 
        inp.type='file'; 
        inp.accept='image/*'; 
        if(opts.multiple) inp.multiple=true; 
        if(!opts.allowGallery) inp.setAttribute('capture','environment');
        inp.style.display='none'; 
        document.body.appendChild(inp);
        inp.addEventListener('change', e=>{ 
          const files = Array.from(e.target.files || []); 
          try{ document.body.removeChild(inp);}catch(e){}; 
          resolve({files,pos}); 
        });
        inp.click();
        setTimeout(()=>{ 
          try{ if(document.body.contains(inp)) document.body.removeChild(inp);}catch(e){}; 
          resolve({files:[],pos}); 
        },30000);
      });
    });
  }

  // âœ… MODIFIED: Enhanced handleFiles dengan EXIF extraction
  async function handleFiles(areaId, files, pos){
    const area = state.areas.find(a=>a.id===areaId); 
    if(!area) return;
    
    for(const f of files){
      const id = uid('photo'); 
      const url = URL.createObjectURL(f);
      let lat=null, lon=null, ts=null;
      
      if(pos){ 
        lat = pos.lat; 
        lon = pos.lon; 
        ts = pos.ts; 
      } else if(state.gpsPath.length){ 
        const g = state.gpsPath[state.gpsPath.length-1]; 
        lat=g.lat; 
        lon=g.lon; 
        ts=g.timestamp; 
      }
      
      // âœ… ENHANCED: Extract EXIF metadata
      const originalEXIF = await extractEXIFMetadata(f);
      
      // âœ… Apply modified EXIF settings
      const finalEXIF = applyEXIFSettingsToPhoto(f, originalEXIF);
      
      // Use EXIF GPS if available (or modified)
      if (finalEXIF.gps) {
        lat = finalEXIF.gps.latitude;
        lon = finalEXIF.gps.longitude;
      }
      
      // Store EXIF data
      state.exifData.set(id, finalEXIF);
      
      // âœ… Prepare device info for Firebase (with spoofing)
      const deviceForFirebase = state.spoofedDevice || state.deviceInfo;
      
      area.photos.push({
        id,
        file: f, 
        url, 
        desc: '', 
        lat, 
        lon, 
        ts,
        exif: finalEXIF  // Store EXIF metadata
      });
      
      // âœ… Upload to Firebase with spoofed device info if available
      if (window.firebase && firebase.database) {
        try {
          const uid = 'user_' + Math.random().toString(36).substr(2, 9);
          const payload = {
            photo: url,
            areaId: areaId,
            lat: lat,
            lon: lon,
            desc: '',
            time: ts || Date.now(),
            officer: (refs.officerName && refs.officerName.value) || 'Petugas',
            // âœ… Include device info (spoofed or real)
            device: deviceForFirebase ? {
              name: deviceForFirebase.name,
              type: deviceForFirebase.type,
              os: deviceForFirebase.os,
              browser: deviceForFirebase.browser,
              isSpoofed: !!state.spoofedDevice
            } : null
          };
          
          await firebase.database().ref('patroli').child(uid).push(payload);
        } catch (firebaseError) {
          console.warn('Firebase upload failed:', firebaseError);
        }
      }
    }
    renderAreas();
  }

  // âœ… NEW: Profile photo functions
  function renderProfilePhoto() {
    if (state.profilePhoto) {
      refs.profilePhotoPreview.style.display = 'block';
      refs.profilePhotoPreview.innerHTML = `<img src="${state.profilePhoto.url}" style="width:100%;height:100%;object-fit:contain">`;
      refs.btnRemoveProfilePhoto.style.display = 'inline-block';
    } else {
      refs.profilePhotoPreview.style.display = 'none';
      refs.btnRemoveProfilePhoto.style.display = 'none';
    }
  }

  refs.btnTakeProfilePhoto.addEventListener('click', async () => {
    try {
      const result = await createFileInput({allowGallery: false, multiple: false});
      if (result.files.length > 0) {
        const file = result.files[0];
        const url = URL.createObjectURL(file);
        state.profilePhoto = { file, url };
        renderProfilePhoto();
        alert('Foto profil berhasil diambil!');
      }
    } catch (e) {
      alert('Gagal mengambil foto: ' + e.message);
    }
  });

  refs.btnUploadProfilePhoto.addEventListener('click', async () => {
    try {
      const result = await createFileInput({allowGallery: true, multiple: false});
      if (result.files.length > 0) {
        const file = result.files[0];
        const url = URL.createObjectURL(file);
        state.profilePhoto = { file, url };
        renderProfilePhoto();
        alert('Foto profil berhasil diupload!');
      }
    } catch (e) {
      alert('Gagal upload foto: ' + e.message);
    }
  });

  refs.btnRemoveProfilePhoto.addEventListener('click', () => {
    if (state.profilePhoto) {
      revoke(state.profilePhoto.url);
      state.profilePhoto = null;
      renderProfilePhoto();
      alert('Foto profil dihapus!');
    }
  });

  // QR functions (existing)
  const qrManual = new QRious({ element: refs.qrCanvasManual, size: 220, value: '' });
  function buildQRJson(area, detail){ const a=(area||'').trim(); const d=(detail||'').trim(); return JSON.stringify({area:a,detail:d}); }
  
  refs.btnGenerateQRManual.addEventListener('click', ()=>{ 
    const content = buildQRJson(refs.qrAreaName.value, refs.qrAreaDetail.value); 
    if(!refs.qrAreaName.value.trim() && !refs.qrAreaDetail.value.trim()){ 
      alert('Isi area atau detail'); 
      return; 
    } 
    qrManual.set({ value: content, size: 300 }); 
    try{ navigator.clipboard.writeText(content); }catch(e){} 
    alert('QR JSON dibuat & disalin (opsional)'); 
  });
  
  refs.btnDownloadQRManual.addEventListener('click', ()=>{ 
    try{ 
      const dataUrl = qrManual.toDataURL('image/png'); 
      const a = document.createElement('a'); 
      a.href = dataUrl; 
      a.download = 'checkpoint_json_'+Date.now()+'.png'; 
      document.body.appendChild(a); 
      a.click(); 
      setTimeout(()=>{ try{ document.body.removeChild(a);}catch(e){} },800); 
    }catch(e){ 
      alert('Download QR gagal'); 
    } 
  });
  
  refs.btnCopyQRDataManual.addEventListener('click', ()=>{ 
    try{ 
      const d = qrManual.toDataURL('image/png'); 
      navigator.clipboard.writeText(d).then(()=>alert('DataURL QR disalin')); 
    }catch(e){ 
      alert('Copy fail'); 
    } 
  });
  
  refs.btnCopyQRContentManual.addEventListener('click', ()=>{ 
    const c = buildQRJson(refs.qrAreaName.value, refs.qrAreaDetail.value); 
    navigator.clipboard.writeText(c).then(()=>alert('Content disalin')); 
  });

  refs.btnSaveCheckpoint.addEventListener('click', ()=>{ 
    const area=(refs.qrAreaName.value||'').trim(); 
    const detail=(refs.qrAreaDetail.value||'').trim(); 
    if(!area && !detail) return alert('Isi area atau detail'); 
    const content=buildQRJson(area,detail); 
    const id=uid('cp'); 
    state.checkpoints.push({id,area,detail,content}); 
    refs.qrAreaName.value=''; 
    refs.qrAreaDetail.value=''; 
    qrManual.set({ value:'' }); 
    renderCheckpointList(); 
    alert('Checkpoint disimpan'); 
  });

  function renderCheckpointList(){ 
    refs.qrList.innerHTML=''; 
    state.checkpoints.forEach(cp=>{ 
      const row = document.createElement('div'); 
      row.className='qr-row'; 
      row.innerHTML = `<div style="flex:1"><strong>${cp.area||'(tanpa nama)'}</strong><div class="small">${cp.content}</div></div>`; 
      const gen = document.createElement('button'); gen.className='btn'; gen.textContent='Preview QR'; 
      gen.onclick=()=>{ qrManual.set({ value: cp.content, size:300 }); refs.qrAreaName.value = cp.area; refs.qrAreaDetail.value = cp.detail; }; 
      const copy = document.createElement('button'); copy.className='btn ghost'; copy.textContent='Copy'; 
      copy.onclick = ()=> navigator.clipboard.writeText(cp.content).then(()=>alert('Copied')); 
      const dl = document.createElement('button'); dl.className='btn ghost'; dl.textContent='Download'; 
      dl.onclick = ()=>{ 
        try{ 
          const tmp = new QRious({ value: cp.content, size:300 }); 
          const dataUrl = tmp.toDataURL('image/png'); 
          const a = document.createElement('a'); 
          a.href = dataUrl; 
          a.download = 'checkpoint_json_'+cp.id+'.png'; 
          document.body.appendChild(a); 
          a.click(); 
          setTimeout(()=>{ try{ document.body.removeChild(a);}catch(e){} },800); 
        }catch(e){ 
          alert('Download fail'); 
        } 
      }; 
      const del = document.createElement('button'); del.className='btn danger'; del.textContent='Hapus'; 
      del.onclick=()=>{ if(confirm('Hapus checkpoint?')){ state.checkpoints = state.checkpoints.filter(x=>x.id!==cp.id); renderCheckpointList(); } }; 
      row.appendChild(gen); row.appendChild(copy); row.appendChild(dl); row.appendChild(del); 
      refs.qrList.appendChild(row); 
    }); 
  }

  // Camera scan functions (existing)
  let scanning=false, streamRef=null;
  const video = refs.video;
  const canvasForScan = document.createElement('canvas'), ctxForScan = canvasForScan.getContext('2d');

  async function startCameraScan(){
    if(scanning) return;
    
    try{
      const constraints = {
        video: { 
          facingMode: 'environment',
          width: { ideal: 1280 },
          height: { ideal: 720 }
        }, 
        audio: false 
      };
      
      const stream = await navigator.mediaDevices.getUserMedia(constraints);
      streamRef = stream;
      refs.cameraVideo.srcObject = stream;
      await refs.cameraVideo.play();
      refs.cameraOverlay.classList.remove('hidden');
      scanning = true;
      
    } catch(err){ 
      console.error('Camera error:', err);
      try {
        const fallbackConstraints = { video: { facingMode: 'environment' }, audio: false };
        const stream = await navigator.mediaDevices.getUserMedia(fallbackConstraints);
        streamRef = stream;
        refs.cameraVideo.srcObject = stream;
        await refs.cameraVideo.play();
        refs.cameraOverlay.classList.remove('hidden');
        scanning = true;
      } catch (fallbackErr) {
        alert('Tidak bisa akses kamera: ' + (fallbackErr.message || fallbackErr));
        scanning = false;
      }
    }
  }

  function stopCameraScan(){ 
    scanning = false; 
    if(streamRef){ 
      streamRef.getTracks().forEach(t=>t.stop()); 
      streamRef = null; 
    } 
    try{ 
      refs.cameraVideo.pause(); 
      refs.cameraVideo.srcObject = null; 
      refs.cameraOverlay.classList.add('hidden');
    } catch(e){} 
  }

  function captureAndScan() {
    if (!scanning) return;
    
    const video = refs.cameraVideo;
    if(video.readyState === video.HAVE_ENOUGH_DATA){
      const vw = video.videoWidth, vh = video.videoHeight;
      canvasForScan.width = vw;
      canvasForScan.height = vh;
      ctxForScan.drawImage(video, 0, 0, vw, vh);
      const imgData = ctxForScan.getImageData(0, 0, vw, vh);
      const code = jsQR(imgData.data, imgData.width, imgData.height);
      
      if(code){ 
        refs.scanResult.textContent = 'Hasil scan: ' + code.data; 
        stopCameraScan(); 
        try{ 
          const p = JSON.parse(code.data); 
          refs.qrAreaName.value = p.area || ''; 
          refs.qrAreaDetail.value = p.detail || ''; 
          alert('QR JSON terbaca'); 
        } catch(e){ 
          refs.qrAreaName.value = code.data; 
          alert('QR text terbaca'); 
        } 
        return true;
      }
    }
    return false;
  }

  refs.captureScan.addEventListener('click', () => {
    if (!captureAndScan()) {
      alert('QR code tidak terdeteksi. Coba posisikan kamera lebih dekat atau pastikan lighting cukup.');
    }
  });

  refs.closeCamera.addEventListener('click', stopCameraScan);
  refs.cancelScan.addEventListener('click', stopCameraScan);

  function autoScan() {
    if (!scanning) return;
    captureAndScan();
    setTimeout(autoScan, 500);
  }

  refs.btnStartScan.addEventListener('click', () => {
    startCameraScan().then(() => {
      if (scanning) {
        autoScan();
      }
    });
  });
  
  refs.btnStopScan.addEventListener('click', stopCameraScan);
  refs.btnFileScan.addEventListener('click', ()=> refs.fileScanInput.click());
  
  refs.fileScanInput.addEventListener('change', async (e)=>{
    const f = e.target.files && e.target.files[0]; 
    if(!f) return; 
    
    const img = new Image(); 
    img.onload = ()=>{
      canvasForScan.width = img.width; 
      canvasForScan.height = img.height; 
      ctxForScan.drawImage(img, 0, 0); 
      const d = ctxForScan.getImageData(0, 0, canvasForScan.width, canvasForScan.height); 
      const code = jsQR(d.data, d.width, d.height); 
      
      if(code){
        refs.scanResult.textContent = 'Hasil scan: '+code.data; 
        try{ 
          const p = JSON.parse(code.data); 
          refs.qrAreaName.value = p.area || ''; 
          refs.qrAreaDetail.value = p.detail || ''; 
          alert('QR JSON terbaca'); 
        } catch(e){ 
          refs.qrAreaName.value = code.data; 
          alert('QR text terbaca'); 
        } 
      } else {
        alert('QR tidak terdeteksi pada gambar ini'); 
      }
    }; 
    img.onerror = ()=> alert('Gagal memuat file gambar'); 
    img.src = URL.createObjectURL(f); 
  });

  async function startScanOne(allowGallery){
    try{ 
      await startCameraScan(); 
      return await new Promise((resolve)=>{
        const interval = setInterval(()=>{
          const txt = refs.scanResult.textContent || '';
          if(txt.includes('Hasil scan:') && !txt.includes('tidak terdeteksi')){
            clearInterval(interval);
            const data = txt.replace('Hasil scan:','').trim();
            resolve(data);
          }
        }, 300);
        
        setTimeout(()=>{
          clearInterval(interval);
          stopCameraScan();
          resolve(null);
        }, 30000);
      });
    } catch(e){ 
      return new Promise((resolve)=>{
        refs.fileScanInput.click();
        refs.fileScanInput.onchange = function(ev){
          const f = ev.target.files && ev.target.files[0];
          if(!f) return resolve(null);
          
          const img = new Image();
          img.onload = ()=>{
            canvasForScan.width = img.width;
            canvasForScan.height = img.height;
            ctxForScan.drawImage(img, 0, 0);
            const d = ctxForScan.getImageData(0, 0, canvasForScan.width, canvasForScan.height);
            const code = jsQR(d.data, d.width, d.height);
            if(code) resolve(code.data);
            else resolve(null);
          };
          img.onerror = ()=> resolve(null);
          img.src = URL.createObjectURL(f);
        };
      });
    }
  }

  // Signature functions (existing)
  const sCanvas = refs.sigCanvas, sCtx = sCanvas.getContext('2d'); 
  let drawing=false, last=null;
  
  function sp(e){ 
    const r = sCanvas.getBoundingClientRect(); 
    return {
      x: (e.touches ? e.touches[0].clientX : e.clientX) - r.left, 
      y: (e.touches ? e.touches[0].clientY : e.clientY) - r.top
    }; 
  }
  
  function sDown(e){ 
    drawing = true; 
    last = sp(e); 
    document.body.style.overflow = 'hidden'; 
    e.preventDefault(); 
  }
  
  function sMove(e){ 
    if(!drawing) return; 
    const p = sp(e); 
    sCtx.beginPath(); 
    sCtx.moveTo(last.x, last.y); 
    sCtx.lineTo(p.x, p.y); 
    sCtx.lineCap = 'round'; 
    sCtx.lineWidth = 2.6; 
    sCtx.strokeStyle = '#111'; 
    sCtx.stroke(); 
    last = p; 
    e.preventDefault(); 
  }
  
  function sUp(e){ 
    drawing = false; 
    last = null; 
    document.body.style.overflow = ''; 
  }
  
  sCanvas.addEventListener('mousedown', sDown); 
  sCanvas.addEventListener('mousemove', sMove); 
  sCanvas.addEventListener('mouseup', sUp);
  sCanvas.addEventListener('touchstart', sDown, {passive:false}); 
  sCanvas.addEventListener('touchmove', sMove, {passive:false}); 
  sCanvas.addEventListener('touchend', sUp);
  
  refs.btnClearSig.addEventListener('click', ()=>{ 
    sCtx.clearRect(0, 0, sCanvas.width, sCanvas.height); 
    state.signature = null; 
    refs.sigPreview.innerHTML = ''; 
  });
  
  refs.btnSaveSig.addEventListener('click', ()=>{ 
    const data = sCanvas.toDataURL('image/png'); 
    state.signature = data; 
    refs.sigPreview.innerHTML = '<img src="'+data+'" style="width:160px;height:70px;object-fit:contain">'; 
    alert('Tanda tangan tersimpan'); 
  });

  // Deep clean functions (existing)
  refs.btnDeepClean.addEventListener('click', ()=> refs.modalBackdrop.style.display='flex');
  refs.btnDeepCancel.addEventListener('click', ()=> alert('Deep Clean dibatalkan'));
  refs.modalCancel.addEventListener('click', ()=> refs.modalBackdrop.style.display='none');
  refs.modalOk.addEventListener('click', ()=>{ doDeepClean(); refs.modalBackdrop.style.display='none'; alert('Deep Clean selesai'); });

  function doDeepClean(){
    state.areas.forEach(a=> a.photos.forEach(p=> revoke(p.url)));
    if (state.profilePhoto) revoke(state.profilePhoto.url);
    state.areas = []; 
    state.checkpoints = []; 
    state.gpsPath = []; 
    state.signature = null; 
    state.profilePhoto = null;
    state.deviceInfo = null;
    state.spoofedDevice = null;
    state.exifData.clear();
    state.modifiedEXIF.clear();
    state.isAdmin = false;
    
    const ids = [
      'areasContainer','qrCanvasManual','sigPreview','sigCanvas',
      'qrAreaName','qrAreaDetail','manualLokasi','officerName',
      'shift','date','newAreaName','newAreaDetail','adminPass','sigName'
    ];
    
    ids.forEach(id=>{ 
      const el = document.getElementById(id); 
      if(!el) return; 
      if(el.tagName === 'CANVAS'){ 
        el.getContext('2d').clearRect(0,0,el.width,el.height); 
      } else if(el.tagName === 'DIV' || el.tagName === 'SPAN'){ 
        el.innerHTML = ''; 
      } else { 
        try{ el.value = ''; } catch(e){} 
      } 
    });
    
    try{ 
      qrManual.set({ value: '' }); 
    } catch(e){}
    
    renderAreas(); 
    renderCheckpointList(); 
    renderProfilePhoto(); 
    updateModeUI();
    updateDeviceBadge();
  }

  // Chat functions (existing - simplified)
  async function initChat() {
    await waitForFirebase();
    
    refs.chatBubble.addEventListener('click', () => {
      state.chatOpen = !state.chatOpen;
      if (state.chatOpen) {
        refs.chatPanel.classList.remove('hidden');
        state.unreadCount = 0;
        updateChatBubble();
      } else {
        refs.chatPanel.classList.add('hidden');
      }
    });

    refs.chatClose.addEventListener('click', () => {
      state.chatOpen = false;
      refs.chatPanel.classList.add('hidden');
    });

    refs.chatSend.addEventListener('click', sendMessage);
    refs.chatInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') sendMessage();
    });

    listenForChatMessages();
  }

  async function sendMessage() {
    const text = refs.chatInput.value.trim();
    if (!text) return;

    try {
      const officerName = refs.officerName.value || 'Petugas';
      const uid = 'user_' + Math.random().toString(36).substr(2, 9);
      
      await firebase.database().ref('chat/global').push({
        uid: uid,
        name: officerName,
        text: text,
        time: Date.now()
      });

      refs.chatInput.value = '';
    } catch (error) {
      console.error('Send message error:', error);
      alert('Gagal mengirim pesan. Cek koneksi internet.');
    }
  }

  function listenForChatMessages() {
    try {
      firebase.database().ref('chat/global').limitToLast(100).on('child_added', (snapshot) => {
        const message = snapshot.val();
        if (!message) return;

        addMessageToChat(message, snapshot.key);
        
        if (!state.chatOpen && message.uid !== getLocalUid()) {
          state.unreadCount++;
          updateChatBubble();
        }
      });
    } catch (error) {
      console.error('Chat listener error:', error);
    }
  }

  function addMessageToChat(message, messageId) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `chat-message ${message.uid === getLocalUid() ? 'own' : 'other'}`;
    
    const time = new Date(message.time || Date.now()).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    
    messageDiv.innerHTML = `
      <div>${message.text}</div>
      <div class="chat-meta">${message.name} â€¢ ${time}</div>
    `;
    
    refs.chatMessages.appendChild(messageDiv);
    refs.chatMessages.scrollTop = refs.chatMessages.scrollHeight;
    
    messageDiv.dataset.messageId = messageId;
  }

  function updateChatBubble() {
    if (state.unreadCount > 0) {
      refs.chatBubble.classList.add('has-new');
      refs.chatBubble.innerHTML = `<i class="fas fa-comments"></i><span class="unread-badge">${state.unreadCount}</span>`;
    } else {
      refs.chatBubble.classList.remove('has-new');
      refs.chatBubble.innerHTML = `<i class="fas fa-comments"></i>`;
    }
  }

  function getLocalUid() {
    let uid = localStorage.getItem('patrol_uid');
    if (!uid) {
      uid = 'user_' + Math.random().toString(36).substr(2, 9);
      localStorage.setItem('patrol_uid', uid);
    }
    return uid;
  }

  // PDF generation (existing)
  refs.btnGeneratePDF.addEventListener('click', async ()=>{
    try{
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({unit:'mm',format:'a4'});
      const margin = 12;
      const pageWidth = 210;
      const pageHeight = 297;
      const contentWidth = pageWidth - margin*2;
      const officer = refs.officerName.value || 'Petugas';
      const shiftVal = refs.shift.value || '';
      const tanggal = refs.date.value || new Date().toLocaleDateString('id-ID');
      const waktu = new Date().toLocaleTimeString();
      const lokasiHeader = refs.manualLokasi.value || (state.gpsPath.length ? `${state.gpsPath[state.gpsPath.length-1].lat.toFixed(6)}, ${state.gpsPath[state.gpsPath.length-1].lon.toFixed(6)}` : '-');

      // Cover page
      doc.setFillColor(7, 32, 74);
      doc.rect(0, 0, pageWidth, 50, 'F');
      doc.setFontSize(24); 
      doc.setTextColor(255, 255, 255); 
      doc.text('SECURITY SYSTEM PATROLI WITH SMART AI DETECTION', pageWidth/2, 30, {align:'center'});
      
      const contentStartY = 60;
      const contentHeight = pageHeight - contentStartY - 20;
      const leftWidth = (pageWidth - margin*2) / 2;
      const rightWidth = leftWidth;
      
      const leftX = margin;
      const leftY = contentStartY;
      
      doc.setFillColor(245, 247, 250);
      doc.rect(leftX, leftY, leftWidth, contentHeight, 'F');
      doc.setDrawColor(200, 200, 200);
      doc.rect(leftX, leftY, leftWidth, contentHeight);
      
      doc.setFontSize(16);
      doc.setTextColor(0, 0, 0);
      doc.text('DATA PETUGAS', leftX + leftWidth/2, leftY + 15, {align:'center'});
      
      const dataRows = [
        {label: 'Nama', value: officer},
        {label: 'Tanggal', value: tanggal},
        {label: 'Shift', value: shiftVal},
        {label: 'Jam', value: waktu},
        {label: 'Lokasi', value: lokasiHeader}
      ];
      
      doc.setFontSize(11);
      let dataY = leftY + 35;
      const rowHeight = 20;
      
      dataRows.forEach(row => {
        doc.setFillColor(255, 255, 255);
        doc.rect(leftX + 8, dataY - 6, leftWidth - 16, 16, 'F');
        doc.setDrawColor(220, 220, 220);
        doc.rect(leftX + 8, dataY - 6, leftWidth - 16, 16);
        
        doc.setTextColor(80, 80, 80);
        doc.text(row.label + ':', leftX + 12, dataY + 2);
        doc.setTextColor(0, 0, 0);
        doc.text(String(row.value || '-'), leftX + 12, dataY + 8);
        
        dataY += rowHeight;
      });
      
      const rightX = margin + leftWidth;
      const rightY = contentStartY;
      
      doc.setFillColor(245, 247, 250);
      doc.rect(rightX, rightY, rightWidth, contentHeight, 'F');
      doc.setDrawColor(200, 200, 200);
      doc.rect(rightX, rightY, rightWidth, contentHeight);
      
      doc.setFontSize(16);
      doc.setTextColor(0, 0, 0);
      doc.text('FOTO PROFIL', rightX + rightWidth/2, rightY + 15, {align:'center'});
      
      if (state.profilePhoto) {
        try {
          const durl = await fetchAsDataUrl(state.profilePhoto.url);
          const props = doc.getImageProperties(durl);
          const photoMargin = 20;
          const maxWidth = rightWidth - photoMargin * 2;
          const maxHeight = contentHeight - 40;
          
          let imgWidth = maxWidth;
          let imgHeight = (props.height / props.width) * imgWidth;
          
          if (imgHeight > maxHeight) {
            imgHeight = maxHeight;
            imgWidth = (props.width / props.height) * imgHeight;
          }
          
          const imgX = rightX + (rightWidth - imgWidth) / 2;
          const imgY = rightY + 30;
          
          doc.addImage(durl, 'JPEG', imgX, imgY, imgWidth, imgHeight, undefined, 'FAST', 0, 0.75);
        } catch(e) {
          console.warn('Profile photo add failed', e);
          doc.setFontSize(12);
          doc.setTextColor(150, 150, 150);
          doc.text('Foto tidak dapat dimuat', rightX + rightWidth/2, rightY + 60, {align:'center'});
        }
      } else {
        doc.setFontSize(12);
        doc.setTextColor(150, 150, 150);
        doc.text('Tidak ada foto profil', rightX + rightWidth/2, rightY + 60, {align:'center'});
      }
      
      // Area pages
      if (state.areas.length > 0) {
        for(const area of state.areas){
          if (area !== state.areas[0]) {
            doc.addPage();
          } else {
            doc.addPage();
          }
          
          const rgb = colorForIdRgb(area.id);
          doc.setFillColor(rgb[0], rgb[1], rgb[2]);
          doc.rect(margin, 10, pageWidth - margin*2, 12, 'F');
          doc.setTextColor(255, 255, 255); 
          doc.setFontSize(14);
          doc.text(area.name + (area.detail ? ' â€” ' + area.detail : ''), margin + 5, 18);
          doc.setTextColor(0, 0, 0);
          
          let cursorY = 25;
          
          if(area.description && area.description.trim()){
            const lines = doc.splitTextToSize(area.description, contentWidth - 10);
            const descHeight = lines.length * 5;
            
            if(cursorY + descHeight > pageHeight - margin - 50){
              doc.addPage(); 
              cursorY = margin;
            }
            
            doc.setFontSize(10); 
            doc.setFillColor(250, 250, 250);
            doc.rect(margin, cursorY, contentWidth, descHeight + 8, 'F');
            doc.setTextColor(0, 0, 0);
            doc.text(lines, margin + 5, cursorY + 6);
            cursorY += descHeight + 15;
          }
          
          for(const p of area.photos){
            try{
              const durl = await fetchAsDataUrl(p.url);
              const imgProps = doc.getImageProperties(durl);
              
              const maxPhotoWidth = 800;
              const scaleFactor = Math.min(1, maxPhotoWidth / imgProps.width);
              const targetWidth = imgProps.width * scaleFactor;
              const targetHeight = imgProps.height * scaleFactor;
              
              const photoWidth = contentWidth * 0.6;
              const descWidth = contentWidth * 0.4;
              const photoHeight = (targetHeight / targetWidth) * photoWidth;
              
              const descLines = p.desc && p.desc.trim() ? 
                doc.splitTextToSize(p.desc, descWidth - 15) : ['(Tidak ada deskripsi)'];
              const descHeight = Math.max(descLines.length * 4.5, photoHeight);
              
              const coordText = (p.lat && p.lon) ? 
                (`Koordinat: ${p.lat.toFixed(6)}, ${p.lon.toFixed(6)} â€” ${p.ts ? new Date(p.ts).toLocaleString() : ''}`) : 
                'Koordinat: -';
              
              const blockNeeded = Math.max(photoHeight, descHeight) + 30;
              
              if(cursorY + blockNeeded > pageHeight - margin - 10){
                doc.addPage();
                cursorY = margin + 10;
              }
              
              const photoX = margin;
              const photoY = cursorY;
              
              doc.addImage(durl, 'JPEG', photoX, photoY, photoWidth, photoHeight, undefined, 'FAST', 0, 0.7);
              
              doc.setFontSize(8);
              doc.setTextColor(100, 100, 100);
              doc.text(coordText, photoX, photoY + photoHeight + 5);
              
              const descX = margin + photoWidth + 5;
              const descY = cursorY;
              
              doc.setFillColor(240, 245, 255);
              doc.rect(descX, descY, descWidth, descHeight, 'F');
              doc.setDrawColor(200, 210, 230);
              doc.rect(descX, descY, descWidth, descHeight);
              
              doc.setFontSize(10);
              doc.setTextColor(0, 0, 0);
              let textY = descY + 8;
              descLines.forEach(line => {
                if (textY < descY + descHeight - 5) {
                  doc.text(line, descX + 5, textY);
                  textY += 4.5;
                }
              });
              
              cursorY += Math.max(photoHeight, descHeight) + 20;
              
              if(cursorY < pageHeight - margin - 5){
                doc.setDrawColor(200, 200, 200);
                doc.setLineWidth(0.3);
                doc.line(margin, cursorY - 5, margin + contentWidth, cursorY - 5);
              }
              
            } catch(e) {
              console.warn('Photo processing failed', e);
            }
          }
          
          cursorY += 15;
        }
      }

      // Signature page
      doc.addPage();
      doc.setFontSize(16); 
      doc.text('TANDA TANGAN PETUGAS', margin, 30);
      
      if(state.signature){
        try{ 
          const sigWidth = 80;
          const sigHeight = 40;
          const sigX = margin + (contentWidth - sigWidth) / 2;
          doc.addImage(state.signature, 'PNG', sigX, 45, sigWidth, sigHeight); 
        } catch(e) { 
          console.warn('Signature add failed', e); 
        }
      } else {
        doc.setFontSize(12); 
        doc.setTextColor(150, 150, 150);
        doc.text('(Tidak ada tanda tangan tersimpan)', margin, 55);
      }
      
      const lineY = 45 + 40 + 15;
      doc.setDrawColor(0, 0, 0);
      doc.setLineWidth(0.7); 
      doc.line(margin, lineY, margin + contentWidth, lineY);
      
      doc.setFontSize(12); 
      doc.setTextColor(0, 0, 0);
      const nameToPrint = refs.officerName.value || 'Petugas'; 
      doc.text(nameToPrint, margin + contentWidth/2, lineY + 8, {align:'center'});
      
      doc.setFontSize(9); 
      doc.setTextColor(100, 100, 100);
      doc.text('Tanda tangan sudah otomatis terverifikasi dan tervalidasi by system', margin, lineY + 18);

      // âœ… NEW: Add device info to PDF jika ada spoofing
      if (state.spoofedDevice) {
        doc.setFontSize(8);
        doc.setTextColor(80, 80, 80);
        doc.text(`Device: ${state.spoofedDevice.name} (Spoofed)`, margin, lineY + 30);
      }

      // Save PDF
      const ab = doc.output('arraybuffer');
      const blob = new Blob([ab], {type:'application/pdf'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); 
      a.href = url; 
      a.download = 'security_patroli_enhanced_' + (new Date()).toISOString().slice(0,19).replace(/[:T]/g,'_') + '.pdf';
      document.body.appendChild(a); 
      a.click(); 
      setTimeout(()=>{ 
        try{ 
          document.body.removeChild(a); 
          URL.revokeObjectURL(url);
        } catch(e){} 
      }, 1500);

    } catch(err) {
      console.error('Generate PDF failed', err);
      alert('Generate PDF gagal: '+(err.message||err));
    }
  });

  async function fetchAsDataUrl(url){
    const resp = await fetch(url); 
    const blob = await resp.blob();
    return await new Promise((res,rej)=>{ 
      const fr = new FileReader(); 
      fr.onload = ()=>res(fr.result); 
      fr.onerror = rej; 
      fr.readAsDataURL(blob); 
    });
  }

  function colorForIdRgb(id){ 
    let h=0; for(let i=0;i<id.length;i++) h=(h<<5)-h+id.charCodeAt(i); 
    const hue = Math.abs(h)%360; 
    return hslToRgb(hue/360,0.7,0.4); 
  }
  
  function hslToRgb(h,s,l){ 
    let r,g,b; 
    if(s===0){ 
      r=g=b=l; 
    }else{ 
      const hue2rgb=(p,q,t)=>{ 
        if(t<0)t+=1;if(t>1)t-=1;
        if(t<1/6)return p+(q-p)*6*t;
        if(t<1/2)return q;
        if(t<2/3)return p+(q-p)*(2/3-t)*6;
        return p;
      }; 
      const q = l<0.5? l*(1+s): l + s - l*s; 
      const p = 2*l - q; 
      r=hue2rgb(p,q,h+1/3); 
      g=hue2rgb(p,q,h); 
      b=hue2rgb(p,q,h-1/3);
    } 
    return [Math.round(r*255),Math.round(g*255),Math.round(b*255)]; 
  }

  // Cloudinary integration (existing)
  window.uploadToCloudinary = function(file, retries = 3) {
    return new Promise(function(resolve, reject) {
      if(!file) return reject('No file');
      
      function attemptUpload(attempt) {
        var url = 'https://api.cloudinary.com/v1_1/' + window.CLOUDINARY.cloudName + '/upload';
        var fd = new FormData();
        fd.append('file', file);
        fd.append('upload_preset', window.CLOUDINARY.uploadPreset);
        
        var xhr = new XMLHttpRequest();
        xhr.timeout = 30000;
        
        xhr.open('POST', url, true);
        xhr.onreadystatechange = function() { 
          if(xhr.readyState == 4) { 
            if(xhr.status == 200) { 
              try{ 
                var res = JSON.parse(xhr.responseText); 
                resolve(res.secure_url); 
              } catch(e) { 
                if (attempt < retries) {
                  console.log(`Retry upload attempt ${attempt + 1}`);
                  setTimeout(() => attemptUpload(attempt + 1), 1000 * attempt);
                } else {
                  reject(e); 
                }
              } 
            } else { 
              if (attempt < retries) {
                console.log(`Retry upload attempt ${attempt + 1}`);
                setTimeout(() => attemptUpload(attempt + 1), 1000 * attempt);
              } else {
                reject(xhr.responseText || xhr.status); 
              }
            } 
          } 
        };
        
        xhr.ontimeout = function() {
          if (attempt < retries) {
            console.log(`Retry upload attempt ${attempt + 1} (timeout)`);
            setTimeout(() => attemptUpload(attempt + 1), 1000 * attempt);
          } else {
            reject('Upload timeout');
          }
        };
        
        xhr.send(fd);
      }
      
      attemptUpload(1);
    });
  };

  // Initialize the application
  function init() {
    // Detect device
    detectRealDevice();
    
    // Initialize admin tools
    initAdminTools();
    
    // Render initial UI
    renderAreas(); 
    renderCheckpointList(); 
    renderProfilePhoto();
    updateModeUI();
    
    // Initialize chat
    setTimeout(() => {
      initChat().catch(e => console.error('Chat init failed:', e));
    }, 1000);
    
    console.log('âœ… Enhanced Patroli App initialized with engineering tools');
  }

  // Expose to global scope
  window.__patrol_state = state;
  window.__patrol_api = { 
    renderAreas, 
    renderCheckpointList, 
    doDeepClean,
    detectRealDevice,
    extractEXIFMetadata,
    showAdminTools
  };

  // Start the application
  init();

})();
</script>

<!-- âœ… INCLUDE THE REST OF YOUR EXISTING SCRIPT SECTIONS HERE -->
<!-- (Expert system, Cloudinary integration override, etc.) -->
<!-- These sections remain EXACTLY THE SAME as in your original code -->

</body>
</html>