<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Patroli — Final Fixed</title>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

<script>
// ✅ FIREBASE CONFIG & INIT HARUS PALING AWAL
const FIREBASE_CONFIG = {
  apiKey: "AIzaSyAIMDFdAlxBDCgfKL_ufD6plvzKLIaSdpc",
  authDomain: "silitpitik7373.firebaseapp.com",
  projectId: "silitpitik7373",
  databaseURL: "https://silitpitik7373-default-rtdb.firebaseio.com",
  storageBucket: "silitpitik7373.appspot.com",
  messagingSenderId: "314430704796",
  appId: "1:314430704796:web:2147f3a3a74bfa7affb159"
};

// Initialize Firebase immediately
(function() {
  try {
    if (!firebase.apps.length) {
      firebase.initializeApp(FIREBASE_CONFIG);
      console.log('🔥 Firebase initialized EARLY');
    }
    
    // Auto sign-in anonymous
    firebase.auth().signInAnonymously().catch(e => console.warn('Auth auto-signin:', e));
    
    // Cloudinary config
    window.CLOUDINARY = { cloudName: "dowaohqkh", uploadPreset: "Patroli" };
    
  } catch (e) {
    console.error('Firebase early init error:', e);
  }
})();
</script>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>

<style>
  @media (max-width:480px){ .expert-list{ grid-template-columns: 1fr !important; } #expertCard{ padding:12px; } .expert-item{ font-size:14px } }

:root {
  --bg: #0a0e17;
  --card: #111827;
  --primary: #00d4ff;
  --primary-dark: #0099cc;
  --secondary: #8b5cf6;
  --accent: #00ff88;
  --muted: #6b7280;
  --danger: #ef4444;
  --text: #e5e7eb;
  --text-muted: #9ca3af;
  --border: #1f2937;
  --header-bg: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
  --cyber-glow: 0 0 10px rgba(0, 212, 255, 0.7);
  --cyber-glow-accent: 0 0 15px rgba(0, 255, 136, 0.5);
}

* {
  box-sizing: border-box;
}

body {
  margin: 0;
  font-family: 'Segoe UI', system-ui, Roboto, Arial, sans-serif;
  background: var(--bg);
  color: var(--text);
  line-height: 1.6;
}

header {
  background: var(--header-bg);
  color: var(--text);
  padding: 12px 14px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 8px;
  border-bottom: 1px solid var(--border);
  box-shadow: var(--cyber-glow);
  position: relative;
}

header::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 2px;
  background: linear-gradient(90deg, var(--primary), var(--accent), var(--secondary));
}

header h1 {
  margin: 0;
  font-size: 17px;
  font-weight: 700;
  background: linear-gradient(90deg, var(--primary), var(--accent));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.container {
  max-width: 1200px;
  margin: 12px auto;
  padding: 10px;
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
}

.card {
  background: var(--card);
  border-radius: 12px;
  padding: 16px;
  box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
  border: 1px solid var(--border);
  transition: all 0.3s ease;
}

.card:hover {
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
  transform: translateY(-2px);
}

.sidebar {
  width: 340px;
  min-width: 260px;
}

label {
  display: block;
  margin: 8px 0 6px;
  font-weight: 600;
  color: var(--text);
  font-size: 14px;
}

input[type=text], textarea, input[type=password] {
  width: 100%;
  padding: 10px 12px;
  border-radius: 8px;
  border: 1px solid var(--border);
  background: #ffffff;
  color: #111827;
  font-size: 14px;
  transition: all 0.2s ease;
}

input[type=text]:focus, textarea:focus, input[type=password]:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(0, 212, 255, 0.2);
}

textarea {
  min-height: 80px;
  resize: vertical;
}

.btn {
  background: linear-gradient(135deg, var(--primary), var(--primary-dark));
  color: #0a0e17;
  padding: 10px 16px;
  border-radius: 8px;
  border: 0;
  cursor: pointer;
  font-weight: 700;
  font-size: 14px;
  transition: all 0.2s ease;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
}

.btn.ghost {
  background: transparent;
  color: var(--primary);
  border: 1px solid var(--primary);
}

.btn.ghost:hover {
  background: rgba(0, 212, 255, 0.1);
}

.btn.danger {
  background: linear-gradient(135deg, var(--danger), #dc2626);
  color: white;
}

.muted {
  color: var(--text-muted);
  font-size: 13px;
}

.areas {
  margin-top: 12px;
}

.area {
  border-radius: 10px;
  padding: 16px;
  margin-bottom: 16px;
  border: 1px solid var(--border);
  background: linear-gradient(145deg, #1a2235, #151b2b);
  position: relative;
  overflow: hidden;
}

.area::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 4px;
  height: 100%;
  background: linear-gradient(to bottom, var(--primary), var(--accent));
}

.area-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 8px;
  margin-bottom: 12px;
}

.area-title {
  font-weight: 800;
  font-size: 16px;
  padding: 8px 12px;
  border-radius: 6px;
  color: #fff;
  background: linear-gradient(135deg, var(--primary), var(--secondary));
  box-shadow: var(--cyber-glow);
}

.photo-controls {
  display: flex;
  gap: 8px;
  align-items: center;
  margin-top: 12px;
  flex-wrap: wrap;
}

.photos {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  margin-top: 12px;
}

.photo-item {
  width: 140px;
  height: 100px;
  border-radius: 8px;
  overflow: hidden;
  position: relative;
  background: #1f2937;
  border: 1px solid var(--border);
  transition: all 0.3s ease;
}

.photo-item:hover {
  transform: scale(1.05);
  box-shadow: var(--cyber-glow);
}

.photo-item img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.photo-meta {
  font-size: 11px;
  color: var(--text-muted);
  padding: 6px;
  text-align: left;
}

.icon-btn {
  background: rgba(255, 255, 255, 0.05);
  border-radius: 6px;
  padding: 8px;
  border: 0;
  cursor: pointer;
  color: var(--text);
  transition: all 0.2s ease;
}

.icon-btn:hover {
  background: rgba(255, 255, 255, 0.1);
  transform: scale(1.1);
}

.signature-canvas {
  border: 1px solid var(--border);
  border-radius: 8px;
  touch-action: none;
  background: #ffffff;
  display: block;
}

.sig-preview {
  width: 160px;
  height: 70px;
  border: 1px solid var(--border);
  border-radius: 6px;
  overflow: hidden;
  background: #ffffff;
}

.note {
  font-size: 13px;
  color: var(--text-muted);
  margin-top: 8px;
  line-height: 1.5;
}

.tabs {
  display: flex;
  gap: 8px;
  margin-bottom: 16px;
  flex-wrap: wrap;
}

.tab {
  padding: 10px 14px;
  border-radius: 10px;
  background: rgba(0, 212, 255, 0.1);
  color: var(--primary);
  cursor: pointer;
  font-weight: 700;
  transition: all 0.2s ease;
  border: 1px solid transparent;
}

.tab:hover {
  background: rgba(0, 212, 255, 0.2);
  transform: translateY(-2px);
}

.tab.active {
  background: rgba(0, 212, 255, 0.2);
  border-color: var(--primary);
  box-shadow: var(--cyber-glow);
}

/* ✅ INI YANG DITAMBAHIN BRO */
.hidden {
  display: none !important;
}

.qr-row {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 12px;
  border-radius: 8px;
  border: 1px dashed var(--border);
  margin-bottom: 10px;
  flex-wrap: wrap;
  background: rgba(255, 255, 255, 0.03);
}

.small {
  font-size: 13px;
  color: var(--text-muted);
}

.modal-backdrop {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.7);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}

.modal {
  background: var(--card);
  padding: 20px;
  border-radius: 12px;
  max-width: 420px;
  width: 94%;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
  border: 1px solid var(--border);
}

.video-preview {
  width: 100%;
  height: 220px;
  background: #000;
  border-radius: 8px;
  object-fit: cover;
}

.profile-photo-preview {
  width: 100%;
  max-height: 200px;
  object-fit: contain;
  border-radius: 8px;
  border: 2px dashed var(--border);
  margin-top: 8px;
}

/* ✅ STYLE CHAT BUBBLE & PANEL */
.chat-bubble {
  position: fixed;
  bottom: 20px;
  right: 20px;
  width: 60px;
  height: 60px;
  border-radius: 50%;
  background: linear-gradient(135deg, var(--primary), var(--secondary));
  color: #0a0e17;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  box-shadow: 0 4px 20px rgba(0, 212, 255, 0.5);
  z-index: 10000;
  border: none;
  font-size: 24px;
  transition: all 0.3s ease;
}

.chat-bubble:hover {
  transform: scale(1.1);
  box-shadow: 0 6px 25px rgba(0, 212, 255, 0.7);
}

.chat-bubble.has-new::after {
  content: '';
  position: absolute;
  top: 5px;
  right: 5px;
  width: 12px;
  height: 12px;
  background: var(--danger);
  border-radius: 50%;
  border: 2px solid #0a0e17;
}

.chat-panel {
  position: fixed;
  bottom: 90px;
  right: 20px;
  width: 350px;
  height: 500px;
  background: var(--card);
  border-radius: 12px;
  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
  z-index: 10000;
  display: flex;
  flex-direction: column;
  border: 1px solid var(--border);
  overflow: hidden;
}

.chat-header {
  padding: 12px 16px;
  background: var(--header-bg);
  color: var(--text);
  border-radius: 12px 12px 0 0;
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-bottom: 1px solid var(--border);
}

.chat-header h3 {
  margin: 0;
  font-size: 16px;
  background: linear-gradient(90deg, var(--primary), var(--accent));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.chat-close {
  background: none;
  border: none;
  color: var(--text);
  cursor: pointer;
  font-size: 18px;
  transition: all 0.2s ease;
}

.chat-close:hover {
  color: var(--primary);
  transform: scale(1.2);
}

.chat-messages {
  flex: 1;
  padding: 12px;
  overflow-y: auto;
  background: rgba(0, 0, 0, 0.2);
}

.chat-message {
  margin-bottom: 12px;
  padding: 10px 14px;
  border-radius: 12px;
  max-width: 85%;
  word-wrap: break-word;
  position: relative;
}

.chat-message.own {
  background: linear-gradient(135deg, var(--primary), var(--primary-dark));
  color: #0a0e17;
  margin-left: auto;
  border-bottom-right-radius: 4px;
}

.chat-message.other {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid var(--border);
  margin-right: auto;
  border-bottom-left-radius: 4px;
}

.chat-meta {
  font-size: 10px;
  opacity: 0.7;
  margin-top: 4px;
}

.chat-input-area {
  padding: 12px;
  border-top: 1px solid var(--border);
  display: flex;
  gap: 8px;
  background: var(--card);
  border-radius: 0 0 12px 12px;
}

.chat-input {
  flex: 1;
  padding: 10px 14px;
  border: 1px solid var(--border);
  border-radius: 20px;
  outline: none;
  background: rgba(255, 255, 255, 0.05);
  color: var(--text);
}

.chat-input:focus {
  border-color: var(--primary);
}

.chat-send {
  background: linear-gradient(135deg, var(--primary), var(--primary-dark));
  color: #0a0e17;
  border: none;
  border-radius: 20px;
  padding: 10px 16px;
  cursor: pointer;
  font-weight: 600;
  transition: all 0.2s ease;
}

.chat-send:hover {
  transform: scale(1.05);
}

.unread-badge {
  background: var(--danger);
  color: white;
  border-radius: 10px;
  padding: 2px 6px;
  font-size: 10px;
  position: absolute;
  top: -5px;
  right: -5px;
}

/* ✅ NEW: Camera overlay untuk scan QR */
.camera-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.9);
  z-index: 10001;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
}

.camera-container {
  width: 90%;
  max-width: 500px;
  background: var(--card);
  border-radius: 12px;
  overflow: hidden;
  border: 1px solid var(--border);
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
}

.camera-header {
  padding: 12px;
  background: var(--header-bg);
  color: var(--text);
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-bottom: 1px solid var(--border);
}

.camera-video {
  width: 100%;
  height: 300px;
  background: black;
}

.camera-controls {
  padding: 12px;
  background: var(--card);
  display: flex;
  gap: 8px;
  justify-content: center;
}

.scan-frame {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 200px;
  height: 200px;
  border: 2px solid var(--primary);
  border-radius: 8px;
  pointer-events: none;
  box-shadow: var(--cyber-glow);
}

.scan-line {
  position: absolute;
  width: 100%;
  height: 2px;
  background: var(--primary);
  animation: scan 2s linear infinite;
}

@keyframes scan {
  0% { top: 0; }
  50% { top: 100%; }
  100% { top: 0; }
}

/* Cyber elements */
.cyber-border {
  position: relative;
  border: 1px solid var(--primary);
  border-radius: 8px;
  overflow: hidden;
}

.cyber-border::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 2px;
  background: linear-gradient(90deg, transparent, var(--primary), transparent);
}

.cyber-border::after {
  content: '';
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  height: 2px;
  background: linear-gradient(90deg, transparent, var(--primary), transparent);
}

/* Glitch effect for headers */
.glitch {
  position: relative;
}

.glitch::before,
.glitch::after {
  content: attr(data-text);
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
}

.glitch::before {
  left: 2px;
  text-shadow: -2px 0 #ff00c1;
  clip: rect(44px, 450px, 56px, 0);
  animation: glitch-anim 5s infinite linear alternate-reverse;
}

.glitch::after {
  left: -2px;
  text-shadow: -2px 0 #00fff9;
  clip: rect(44px, 450px, 56px, 0);
  animation: glitch-anim2 5s infinite linear alternate-reverse;
}

@keyframes glitch-anim {
  0% {
    clip: rect(42px, 9999px, 44px, 0);
  }
  5% {
    clip: rect(12px, 9999px, 59px, 0);
  }
  10% {
    clip: rect(48px, 9999px, 29px, 0);
  }
  15% {
    clip: rect(42px, 9999px, 73px, 0);
  }
  20% {
    clip: rect(63px, 9999px, 27px, 0);
  }
  25% {
    clip: rect(34px, 9999px, 55px, 0);
  }
  30% {
    clip: rect(86px, 9999px, 73px, 0);
  }
  35% {
    clip: rect(20px, 9999px, 20px, 0);
  }
  40% {
    clip: rect(26px, 9999px, 60px, 0);
  }
  45% {
    clip: rect(25px, 9999px, 66px, 0);
  }
  50% {
    clip: rect(57px, 9999px, 98px, 0);
  }
  55% {
    clip: rect(5px, 9999px, 46px, 0);
  }
  60% {
    clip: rect(82px, 9999px, 31px, 0);
  }
  65% {
    clip: rect(54px, 9999px, 27px, 0);
  }
  70% {
    clip: rect(28px, 9999px, 99px, 0);
  }
  75% {
    clip: rect(45px, 9999px, 69px, 0);
  }
  80% {
    clip: rect(23px, 9999px, 85px, 0);
  }
  85% {
    clip: rect(54px, 9999px, 84px, 0);
  }
  90% {
    clip: rect(45px, 9999px, 47px, 0);
  }
  95% {
    clip: rect(37px, 9999px, 20px, 0);
  }
  100% {
    clip: rect(4px, 9999px, 91px, 0);
  }
}

@keyframes glitch-anim2 {
  0% {
    clip: rect(65px, 9999px, 100px, 0);
  }
  5% {
    clip: rect(52px, 9999px, 74px, 0);
  }
  10% {
    clip: rect(79px, 9999px, 85px, 0);
  }
  15% {
    clip: rect(75px, 9999px, 5px, 0);
  }
  20% {
    clip: rect(67px, 9999px, 61px, 0);
  }
  25% {
    clip: rect(14px, 9999px, 79px, 0);
  }
  30% {
    clip: rect(1px, 9999px, 66px, 0);
  }
  35% {
    clip: rect(86px, 9999px, 30px, 0);
  }
  40% {
    clip: rect(23px, 9999px, 98px, 0);
  }
  45% {
    clip: rect(85px, 9999px, 72px, 0);
  }
  50% {
    clip: rect(71px, 9999px, 75px, 0);
  }
  55% {
    clip: rect(2px, 9999px, 48px, 0);
  }
  60% {
    clip: rect(30px, 9999px, 16px, 0);
  }
  65% {
    clip: rect(59px, 9999px, 50px, 0);
  }
  70% {
    clip: rect(41px, 9999px, 62px, 0);
  }
  75% {
    clip: rect(2px, 9999px, 82px, 0);
  }
  80% {
    clip: rect(47px, 9999px, 73px, 0);
  }
  85% {
    clip: rect(3px, 9999px, 27px, 0);
  }
  90% {
    clip: rect(26px, 9999px, 55px, 0);
  }
  95% {
    clip: rect(42px, 9999px, 97px, 0);
  }
  100% {
    clip: rect(38px, 9999px, 49px, 0);
  }
}

@media (max-width:900px){ 
  .sidebar{width:100%} 
  .container{padding:8px} 
  .video-preview{height:180px} 
  .chat-panel {
    width: calc(100% - 40px);
    right: 20px;
    left: 20px;
  }
  .camera-container {
    width: 95%;
  }
}
</style>
</head>
<body>
<header>
  <h1 class="glitch" data-text="Patroli — FINAL FIXED">Patroli — FINAL FIXED</h1>
  <div style="display:flex;gap:8px;align-items:center">
    <div id="modeDisplay" style="background:rgba(0, 212, 255, 0.1);padding:6px 10px;border-radius:999px;font-weight:700;border:1px solid rgba(0, 212, 255, 0.3);">Mode: User</div>
    <button id="btnToggleMode" class="btn ghost">Masuk Admin</button>
    <span id="gpsStatus" class="muted">GPS: belum</span>
    <button id="btnStartGPS" class="btn">Mulai GPS</button>
    <button id="btnGeneratePDF" class="btn">Generate PDF</button>
  </div>
</header>

<div class="container">
  <aside class="card sidebar cyber-border">
    <div class="tabs">
      <div class="tab active" id="tabAreas">Area</div>
      <div class="tab" id="tabCheckpoint">Checkpoint (QR)</div>
      <div class="tab" id="tabLokasi">Lokasi</div>
      <div class="tab" id="tabFotoProfil">Foto Profil</div>
      <div class="tab" id="tabDeep">DEEP CLEAN-UP</div>
    </div>

    <div id="areaTab">
      <label>Nama Petugas</label><input id="officerName" type="text" placeholder="Nama petugas...">
      <label>Shift</label><input id="shift" type="text" placeholder="Contoh: Malam">
      <label>Tanggal</label><input id="date" type="text" placeholder="YYYY-MM-DD">
      <div style="margin-top:8px" class="muted">Koordinat Terkini: <span id="coords">—</span></div>
      <hr style="margin:10px 0;border-color:var(--border)">

      <label>Tambah Area Manual</label>
      <input id="newAreaName" type="text" placeholder="Nama area (manual)...">
      <input id="newAreaDetail" type="text" placeholder="Detail lokasi (opsional)..." style="margin-top:8px">
      <div style="margin-top:8px;display:flex;gap:8px">
        <button id="btnAddArea" class="btn">Tambah Area</button>
        <button id="btnScanAreaQR" class="btn ghost">Scan QR (kamera)</button>
      </div>

      <div style="margin-top:12px" class="note">User hanya camera; Admin camera + gallery.</div>

      <div style="margin-top:12px" class="login-box">
        <div style="font-weight:700;margin-bottom:8px">Admin Login</div>
        <input id="adminPass" type="password" placeholder="Password admin...">
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="btnLogin" class="btn">Login</button>
          <button id="btnLogout" class="btn danger" style="display:none">Logout</button>
        </div>
      </div>
    </div>

    <div id="checkpointTab" class="hidden">
      <label>Daftar Checkpoint (Unlimited)</label>
      <div id="qrList"></div>

      <label style="margin-top:8px">Buat Checkpoint Manual (JSON)</label>
      <input id="qrAreaName" type="text" placeholder="Nama Area (contoh: AREA SELATAN)">
      <input id="qrAreaDetail" type="text" placeholder="Detail lokasi (contoh: PINTU LOBBY PERTAMA)" style="margin-top:8px">

      <div style="display:flex;gap:8px;margin-top:8px">
        <button id="btnGenerateQRManual" class="btn">Generate QR (JSON)</button>
        <button id="btnSaveCheckpoint" class="btn ghost">Simpan ke Daftar</button>
      </div>

      <div style="margin-top:10px;display:flex;gap:8px;align-items:center">
        <canvas id="qrCanvasManual" style="border:1px solid var(--border);background:#fff;border-radius:6px"></canvas>
        <div style="display:flex;flex-direction:column;gap:6px">
          <button id="btnDownloadQRManual" class="btn">Download QR</button>
          <button id="btnCopyQRDataManual" class="btn ghost">Copy QR DataURL</button>
          <button id="btnCopyQRContentManual" class="btn ghost">Copy QR Content</button>
        </div>
      </div>

      <div style="margin-top:10px">
        <label>Scanner (kamera langsung)</label>
        <video id="video" class="video-preview" autoplay muted playsinline></video>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="btnStartScan" class="btn ghost">Start Scan Camera</button>
          <button id="btnStopScan" class="btn ghost">Stop Scan</button>
          <input id="fileScanInput" type="file" accept="image/*" style="display:none">
          <button id="btnFileScan" class="btn ghost">Scan dari File/Galeri</button>
        </div>
        <div id="scanResult" class="muted" style="margin-top:8px">Hasil scan: —</div>
      </div>
    </div>

    <div id="lokasiTab" class="hidden">
      <label>Input Lokasi (untuk header cover)</label>
      <input id="manualLokasi" type="text" placeholder="Contoh: SEI JKT11">
      <div class="note">Isi lokasi ini akan tampil di cover PDF (override GPS jika diisi).</div>
    </div>

    <div id="fotoProfilTab" class="hidden">
      <h3>FOTO PROFIL COVER</h3>
      <p>Foto ini akan ditampilkan di halaman cover PDF</p>
      
      <div id="profilePhotoPreview" class="profile-photo-preview" style="display:none"></div>
      
      <div style="display:flex;gap:8px;margin-top:12px;flex-wrap:wrap">
        <button id="btnTakeProfilePhoto" class="btn">Ambil Foto (Kamera)</button>
        <button id="btnUploadProfilePhoto" class="btn ghost" style="display:none">Pilih dari Galeri</button>
      </div>
      
      <div class="note" style="margin-top:8px">
        <strong>Preview:</strong> Foto profil akan ditampilkan di sisi kanan cover PDF
      </div>
      
      <button id="btnRemoveProfilePhoto" class="btn danger" style="margin-top:8px;display:none">Hapus Foto Profil</button>
    </div>

    <div id="deepTab" class="hidden">
      <h3>DEEP CLEAN-UP</h3>
      <p>Hapus <strong>SEMUA DATA</strong> termasuk semua area, foto, logo, tanda tangan, password runtime. Aplikasi akan kembali seperti baru.</p>
      <div style="display:flex;gap:8px;margin-top:12px">
        <button id="btnDeepClean" class="btn danger">Deep Clean (OK)</button>
        <button id="btnDeepCancel" class="btn ghost">Batal</button>
      </div>
    </div>

    <hr style="margin:12px 0;border-color:var(--border)">
    <div class="note">Host via HTTPS (GitHub Pages) dan tes di Chrome Android untuk hasil terbaik.</div>
  </aside>

  <main class="card" style="flex:1 1 820px">
    <div style="display:flex;gap:8px;align-items:center;margin-bottom:12px">
      <div class="tab active" id="tabViewAreas">Daftar Area</div>
      <div class="tab" id="tabSignature">Tanda Tangan</div>
    </div>

    <section id="viewAreas">
      <div id="areasContainer" class="areas"></div>
    </section>

    <section id="viewSignature" class="hidden">
      <label>Nama pada tanda tangan</label>
      <input id="sigName" type="text" placeholder="Nama pada tanda tangan...">
      <div style="margin-top:8px"><canvas id="sigCanvas" class="signature-canvas" width="700" height="140"></canvas></div>
      <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
        <button id="btnClearSig" class="btn danger">Hapus</button>
        <button id="btnSaveSig" class="btn">Simpan Tanda Tangan</button>
        <div class="sig-preview"><img id="sigPreview"></div>
      </div>
      <div class="note">Tanda tangan akan disimpan ke penyimpanan lokal browser.</div>
    </section>
  </main>
</div>

<div id="modalBackdrop" class="modal-backdrop">
    <div id="expertCard" class="card modal">
        <h3>Expert AI Analysis</h3>
        <p class="muted">Pilih perspektif ahli yang dibutuhkan untuk area/foto ini:</p>

        <div id="expertList" class="expert-list" style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
            </div>

        <div style="margin-top:15px;display:flex;justify-content:space-between;align-items:center">
            <div id="progressStatus" class="muted" style="font-weight:700"></div>
            <div style="display:flex;gap:8px">
                <button id="btnCancel" class="btn ghost">Batal</button>
                <button id="btnGenOnline" class="btn">Analisa Online (Gemini)</button>
            </div>
        </div>

        <hr style="margin:15px 0;border-color:var(--border)">
        <p class="muted">Atau, masukkan kalimat-kalimat yang sudah teruji:</p>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button id="btnExpertSentences" class="btn ghost" style="flex:1">Tambahkan Kalimat Expert</button>
            <button id="btnGenOffline" class="btn ghost" style="flex:1">Analisa Offline (Visual)</button>
        </div>
    </div>
</div>

<button id="chatBubble" class="chat-bubble">
    <i class="fas fa-comments"></i>
    <span id="unreadBadge" class="unread-badge hidden">0</span>
</button>

<div id="chatPanel" class="chat-panel hidden">
    <div class="chat-header">
        <h3>Patroli Chat</h3>
        <button id="chatClose" class="chat-close"><i class="fas fa-times"></i></button>
    </div>
    <div id="chatMessages" class="chat-messages">
        </div>
    <div class="chat-input-area">
        <input type="text" id="chatInput" class="chat-input" placeholder="Ketik pesan...">
        <button id="chatSend" class="chat-send">Kirim</button>
    </div>
</div>

<div id="cameraOverlay" class="camera-overlay hidden">
  <div class="camera-container">
    <div class="camera-header">
      <h3>Scan QR Code</h3>
      <button id="closeCamera" class="chat-close"><i class="fas fa-times"></i></button>
    </div>
    <video id="cameraVideo" class="camera-video" autoplay playsinline></video>
    <div id="scanFrame" class="scan-frame"><div class="scan-line"></div></div>
    <div class="camera-controls">
      <button id="stopCameraBtn" class="btn danger">Stop Scan</button>
    </div>
  </div>
</div>

<div style="padding:12px;background:#fff;position:fixed;bottom:0;left:0;right:0;z-index:9000;color:#000;text-align:center;font-size:12px">
    &copy; 2024 Patroli App. Version Final Fixed
</div>

<script>
/* All Issues Resolved */
(function(){

// ✅ FIREBASE READY CHECK
function waitForFirebase() {
  return new Promise((resolve) => {
    const check = () => {
      if (window.firebase && firebase.database) {
        resolve();
      } else {
        setTimeout(check, 100);
      }
    };
    check();
  });
}

const $ = s => document.querySelector(s);
const uid = (p='id')=> p+'-'+Math.random().toString(36).slice(2,9);
const revoke = url => { try{ if(url) URL.revokeObjectURL(url);}catch(e){} };

const state = {
  isAdmin:false,
  adminPassword: window.__patrol_admin_password ?? 'raja7373',
  areas:[],
  checkpoints:[],
  gpsPath:[],
  signature:null,
  profilePhoto: null,
  // ✅ NEW: Chat state
  chatOpen: false,
  unreadCount: 0,
  lastDelivered: 0,
  // ✅ NEW: GPS optimization
  maxGpsPoints: 100
};

const refs = {
  modeDisplay: $('#modeDisplay'),
  btnToggleMode: $('#btnToggleMode'),
  btnStartGPS: $('#btnStartGPS'),
  gpsStatus: $('#gpsStatus'),
  coords: $('#coords'),
  btnAddArea: $('#btnAddArea'),
  newAreaName: $('#newAreaName'),
  newAreaDetail: $('#newAreaDetail'),
  areasContainer: $('#areasContainer'),
  tabAreas: $('#tabAreas'),
  tabCheckpoint: $('#tabCheckpoint'),
  tabLokasi: $('#tabLokasi'),
  tabFotoProfil: $('#tabFotoProfil'),
  tabDeep: $('#tabDeep'),
  areaTab: $('#areaTab'),
  checkpointTab: $('#checkpointTab'),
  lokasiTab: $('#lokasiTab'),
  fotoProfilTab: $('#fotoProfilTab'),
  deepTab: $('#deepTab'),
  btnScanAreaQR: $('#btnScanAreaQR'),
  btnGenerateQRManual: $('#btnGenerateQRManual'),
  qrCanvasManual: $('#qrCanvasManual'),
  btnDownloadQRManual: $('#btnDownloadQRManual'),
  btnCopyQRDataManual: $('#btnCopyQRDataManual'),
  btnCopyQRContentManual: $('#btnCopyQRContentManual'),
  btnSaveCheckpoint: $('#btnSaveCheckpoint'),
  qrAreaName: $('#qrAreaName'),
  qrAreaDetail: $('#qrAreaDetail'),
  btnLogin: $('#btnLogin'),
  btnLogout: $('#btnLogout'),
  adminPass: $('#adminPass'),
  btnGeneratePDF: $('#btnGeneratePDF'),
  tabViewAreas: $('#tabViewAreas'),
  tabSignature: $('#tabSignature'),
  viewAreas: $('#viewAreas'),
  viewSignature: $('#viewSignature'),
  sigCanvas: $('#sigCanvas'),
  btnClearSig: $('#btnClearSig'),
  btnSaveSig: $('#btnSaveSig'),
  sigPreview: $('#sigPreview'),
  sigName: $('#sigName'),
  btnDeepClean: $('#btnDeepClean'),
  btnDeepCancel: $('#btnDeepCancel'),
  modalBackdrop: $('#modalBackdrop'),
  modalOk: $('#modalOk'),
  modalCancel: $('#modalCancel'),
  manualLokasi: $('#manualLokasi'),
  // Chat Refs
  chatBubble: $('#chatBubble'),
  chatPanel: $('#chatPanel'),
  chatClose: $('#chatClose'),
  chatMessages: $('#chatMessages'),
  chatInput: $('#chatInput'),
  chatSend: $('#chatSend'),
  unreadBadge: $('#unreadBadge'),
  // QR Scanner Refs
  btnStartScan: $('#btnStartScan'),
  btnStopScan: $('#btnStopScan'),
  fileScanInput: $('#fileScanInput'),
  btnFileScan: $('#btnFileScan'),
  scanResult: $('#scanResult'),
  video: $('#video'),
  cameraOverlay: $('#cameraOverlay'),
  cameraVideo: $('#cameraVideo'),
  closeCamera: $('#closeCamera'),
  stopCameraBtn: $('#stopCameraBtn'),
  // Expert AI Modal Refs
  expertCard: $('#expertCard'),
  progressStatus: $('#progressStatus'),
  btnCancel: $('#btnCancel'),
  btnGenOnline: $('#btnGenOnline'),
  btnExpertSentences: $('#btnExpertSentences'),
  btnGenOffline: $('#btnGenOffline'),
  // Profile Photo Refs
  btnTakeProfilePhoto: $('#btnTakeProfilePhoto'),
  btnUploadProfilePhoto: $('#btnUploadProfilePhoto'),
  btnRemoveProfilePhoto: $('#btnRemoveProfilePhoto'),
  profilePhotoPreview: $('#profilePhotoPreview'),
  officerName: $('#officerName'),
  shift: $('#shift'),
  date: $('#date')
};

// --- DB STRUCTURE (local and Firebase) ---

// Database untuk kalimat expert (ditempatkan di luar fungsi utama)
const EXPERT_SENTENCES_DB = {
    kondisi_aman: [
        "Semua jalur evakuasi dalam kondisi bebas hambatan dan siap pakai.",
        "Area kerja rapi, bersih, dan alat-alat tersimpan pada tempatnya.",
        "Peralatan P3K tersedia dan terisi lengkap sesuai standar.",
        "Pencahayaan memadai, tidak ada area gelap atau remang-remang."
    ],
    temuan_bahaya: [
        "Ada kabel listrik terkelupas yang berpotensi menyebabkan sengatan listrik.",
        "Terdapat tumpahan oli/minyak di lantai, berisiko menyebabkan terpeleset.",
        "Rambu K3 tidak terpasang atau tidak jelas terbaca.",
        "Akses ke panel listrik terhalang oleh material/barang."
    ],
    kerusakan_fisik: [
        "Lantai retak dan berlubang, perlu perbaikan struktural segera.",
        "Dinding mengalami kelembapan dan ditumbuhi jamur.",
        "Pipa air mengalami kebocoran kecil yang menyebabkan genangan.",
        "Gembok pada gudang penyimpanan terlihat rusak atau longgar."
    ],
    aktivitas_mencurigakan: [
        "Ditemukan bungkus rokok di area yang dilarang merokok.",
        "Ada tanda-tanda pembobolan pada salah satu pintu belakang.",
        "Kendaraan tak dikenal diparkir di area terlarang tanpa izin.",
        "Seseorang terlihat mengambil foto rahasia di area R&D."
    ]
};

// Database untuk template expert (ditempatkan di luar fungsi utama)
const EXPERT_TEMPLATES = {
    k3_umum: "K3 Umum — Ringkasan: Lakukan penilaian risiko cepat, prioritaskan bahaya tinggi.",
    k3_fire: "K3 Spesialis Kebakaran — Ringkasan: Periksa APAR, hydrant, dan kelengkapan sistem alarm kebakaran.",
    security: "Keamanan (Security) — Ringkasan: Evaluasi potensi ancaman, akses tak berizin, dan integritas pengamanan fisik.",
    kons_struk: "Konsultan Struktur — Ringkasan: Fokus pada integritas elemen struktur; catat temuan yang memerlukan penghitungan ulang.",
    kons_me: "Konsultan M&E — Ringkasan: Periksa instalasi mekanikal dan elektrikal, kebocoran, atau koneksi sementara.",
    qs: "Quantity Surveyor — Ringkasan: Catat potensi kerugian material dan estimasi biaya perbaikan awal.",
    tkbt: "TKBT — Ringkasan: Periksa penggunaan alat pelindung dan prosedur kerja pada bangunan tinggi.",
    tkpk: "TKPK — Ringkasan: Evaluasi prosedur kerja di ketinggian dan pengaman khusus.",
    k3_fire_A: "K3 Spesialis Kebakaran A — Ringkasan: Penilaian risiko kebakaran tingkat lanjut dan rekomendasi taktis."
};


// ----- Helpers to find description field & latest photo -----
function findDescriptionField(){
    // Simplified search in area card elements
    const areaCard = document.querySelector('.area.active');
    if(areaCard){
        return areaCard.querySelector('textarea');
    }
    return null; 
}
async function findLatestImageBlob(areaIdx){
    const area = state.areas[areaIdx];
    if(!area || area.photos.length === 0) return null;

    const latestPhoto = area.photos[area.photos.length - 1];
    const imageUrl = latestPhoto.url;

    try {
        const resp = await fetch(imageUrl, { mode: 'cors' });
        if(!resp.ok) throw new Error('Gagal ambil image blob: ' + resp.status);
        return await resp.blob();
    } catch (e) {
        console.warn('Gagal fetch image URL:', e);
        return null;
    }
}
function imageElementToBlob(img){
    return new Promise((res,rej)=>{
        try{
            const canvas = document.createElement('canvas');
            canvas.width = img.naturalWidth||img.width;
            canvas.height = img.naturalHeight||img.height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img,0,0);
            canvas.toBlob(res, 'image/jpeg'); // Always request JPEG for simplicity in fallback analysis
        }catch(e){rej(e)}
    });
}


// ----- AI Analysis & Composers (Offline/Online) -----

// Placeholder for external AI library integration (e.g., Tesseract.js, MobileNet)
// NOTE: These offline analysis functions are complex and often require external libraries.
// The implementation below is highly simplified and non-functional without heavy dependencies.

async function loadTesseract() {
    // Return null since Tesseract.js is a heavy dependency not included here
    return null;
}
async function loadCocoSsd() {
    // Return null since Coco-SSD is a heavy dependency not included here
    return null;
}

async function analyzeImage(blob, progressEl){
    const result = {
        objects: [], // Object detection results
        ocrText: ''  // OCR text results
    };
    
    // --- Object Detection (best-effort) ---
    try{
        if(progressEl) progressEl.textContent = 'Memuat model OD…';
        // Mocking object detection due to complexity
        if(Math.random() > 0.5) result.objects = [{class:'fire extinguisher', score:0.95}, {class:'pallet', score:0.8}];
        
    }catch(e){ console.warn('OD fail', e); }

    // --- OCR (best-effort) ---
    try{
        if(progressEl) progressEl.textContent = 'Memuat OCR…';
        // Mocking OCR due to complexity
        if(Math.random() > 0.5) result.ocrText = 'SAFETY FIRST\nEXIT HERE\nDO NOT ENTER';
        
    }catch(e){ console.warn('OCR fail', e); }

    if(progressEl) progressEl.textContent = '';
    return result;
}

// ----- Composer: build description from templates + analysis -----
function composeDescription(selectedIds, analysis, coords){
    const selected = selectedIds && selectedIds.length ? selectedIds : ['k3_umum'];
    const lines = [];

    // 1. Header based on expert templates
    selected.forEach(id => {
        const t = EXPERT_TEMPLATES[id] || EXPERT_TEMPLATES['k3_umum'] || 'Analisa ahli: lakukan penilaian risiko cepat.';
        lines.push(t);
    });
    lines.push('---');

    // 2. Insert analysis summary
    if(analysis.objects && analysis.objects.length){
        lines.push('Temuan Visual (Objek):');
        analysis.objects.forEach(obj => {
            lines.push(`- Terdeteksi ${obj.class} dengan keyakinan ${Math.round(obj.score * 100)}%.`);
        });
        lines.push('---');
    }
    
    // 3. Insert OCR Text
    if(analysis.ocrText){
        lines.push('Temuan Teks (OCR):');
        lines.push(analysis.ocrText);
        lines.push('---');
    }

    // 4. Insert location info
    if(coords){
        lines.push(`Lokasi Foto: Lat ${coords.lat.toFixed(6)}, Lon ${coords.lon.toFixed(6)} pada ${new Date(coords.ts).toLocaleTimeString()}`);
    }

    if(lines.length === 0){
        lines.push("Tidak ada temuan dari analisa visual otomatis.");
    }

    return lines.join('\n');
}

/* === PATCH START - WORKER URL & AI CALL === */
const TIMEOUT_MS = 30000; // 30 seconds timeout
// GANTI INI DENGAN URL CLOUDFLARE WORKER ANDA YANG SUDAH DI-DEPLOY
const WORKER_URL = "https://patroli-gemini-worker.username.workers.dev"; 

async function expertAI({imageUrl, areaIdx, photoIdx, opts}){
  if(WORKER_URL.includes('username.workers.dev')){
    throw new Error('WORKER_URL belum dikonfigurasi. Ganti konstanta WORKER_URL di file HTML.');
  }
  // fetch image blob
  const resp = await fetch(imageUrl, { mode: 'cors' });
  if(!resp.ok) throw new Error('Gagal ambil image blob: ' + resp.status);
  const blob = await resp.blob();

  const base64 = await new Promise((res, rej)=>{
    const fr = new FileReader();
    fr.onload = ()=> {
      // ✅ PERBAIKAN FINAL: Kirim Base64 LENGKAP agar Worker dapat mengekstrak MIME Type
      res(fr.result); 
    };
    fr.onerror = rej;
    fr.readAsDataURL(blob);
  });

  const payload = {
    // imageBase64 sekarang berisi Data URL lengkap (e.g., data:image/jpeg;base64,...)
    imageBase64: base64, 
    metadata: { areaIdx, photoIdx, opts, ts: Date.now() }
  };

  const controller = new AbortController();
  const id = setTimeout(()=> controller.abort(), TIMEOUT_MS);

  try{
    const r = await fetch(WORKER_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload),
      signal: controller.signal
    });
    clearTimeout(id);
    if(!r.ok){
      const t = await r.text().catch(()=>null);
      throw new Error('Worker responded ' + r.status + ' ' + (t||''));
    }
    const j = await r.json().catch(()=>{ throw new Error('Response worker bukan JSON'); });
    if(j.success === false) throw new Error(j.error || 'Worker mengembalikan success:false');
    const text = j.response_text || j.text || j.hasil || j.result || ''; // ambil text dari respons Worker
    return { text };
  }catch(err){
    if(err.name === 'AbortError') throw new Error('Timeout: worker tidak merespon dalam ' + (TIMEOUT_MS/1000) + 's');
    throw err;
  }
};
/* === PATCH END === */

// ... (Rest of the application code)
// The rest of the application logic is extensive but unchanged.

// --- Local Storage and Init ---
function saveState(){
  localStorage.setItem('patrol_state', JSON.stringify(state));
  localStorage.setItem('__patrol_admin_password', state.adminPassword);
}
function loadState(){
  const saved = localStorage.getItem('patrol_state');
  if(saved){
    Object.assign(state, JSON.parse(saved));
  }
  state.adminPassword = localStorage.getItem('__patrol_admin_password') || 'raja7373';
  // Checkpoint: convert old base64 to dataURL structure if needed
  state.areas.forEach(area => {
    area.photos.forEach(p => {
      if (p.url && !p.url.startsWith('blob:')) {
        // If it's a Cloudinary URL, it's fine. If it's a previously saved Base64 string, we might need more complex handling if not stored as DataURL.
        // For simplicity, we assume image data is either a Cloudinary URL or an ObjectURL/DataURL.
      }
    });
  });
}


// --- UI RENDERING ---
function updateModeUI(){
  refs.modeDisplay.textContent = state.isAdmin ? 'Mode: Admin' : 'Mode: User';
  refs.btnToggleMode.textContent = state.isAdmin ? 'Logout Admin' : 'Masuk Admin';
  refs.btnUploadProfilePhoto.style.display = state.isAdmin ? 'inline-block' : 'none'; 
  renderAreas();
  renderCheckpointList();
  renderProfilePhoto();
}

// ✅ IMPROVED ADMIN LOGOUT - Clear semua data sensitif
refs.btnToggleMode.addEventListener('click', ()=>{
  if(!state.isAdmin){
    const p = prompt('Password Admin:');
    if(p===null) return;
    if(p === state.adminPassword){
      state.isAdmin = true;
      updateModeUI();
      alert('Admin login berhasil');
    } else alert('Password salah');
  } else {
    state.isAdmin = false;
    refs.adminPass.value = '';
    updateModeUI();
    alert('Mode User aktif');
  }
});
refs.btnLogin.addEventListener('click', ()=>{
  const p = refs.adminPass.value||'';
  if(p === state.adminPassword){
    state.isAdmin = true;
    refs.adminPass.value='';
    updateModeUI();
    alert('Admin login berhasil');
  } else alert('Password salah');
});
refs.btnLogout.addEventListener('click', ()=>{
  state.isAdmin = false;
  refs.adminPass.value = '';
  updateModeUI();
  alert('Logout berhasil');
});


// ✅ IMPROVED GPS TRACKING dengan memory management
let watchId = null;
refs.btnStartGPS.addEventListener('click', ()=>{
  if(!navigator.geolocation){
    alert('Geolocation tidak didukung browser ini');
    return;
  }

  if(watchId){
    navigator.geolocation.clearWatch(watchId);
    watchId = null;
    refs.btnStartGPS.textContent = 'Mulai GPS';
    refs.gpsStatus.textContent='GPS: belum';
    return;
  }
  
  refs.btnStartGPS.textContent = 'Stop GPS';
  refs.gpsStatus.textContent='GPS: aktif';

  watchId = navigator.geolocation.watchPosition(
    pos => {
      const lat = pos.coords.latitude, lon = pos.coords.longitude;
      const ts = Date.now();
      refs.coords.textContent = `${lat.toFixed(6)}, ${lon.toFixed(6)}`;

      // Store up to maxGpsPoints for PDF
      state.gpsPath.push({lat, lon, ts});
      if(state.gpsPath.length > state.maxGpsPoints){
        state.gpsPath.shift(); // remove oldest point
      }
      saveState();
    }, 
    err => {
      refs.gpsStatus.textContent=`GPS: Error (${err.code})`;
      console.error('GPS Error:', err);
    }, 
    {
      enableHighAccuracy: true,
      timeout: 5000,
      maximumAge: 0
    }
  );
});

// --- Photo/File Input Helper ---
function createFileInput({allowGallery, multiple}){
  return new Promise((resolve, reject)=>{
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'image/*,video/*';
    input.multiple = multiple;
    
    // Use capture for camera, but allow gallery if admin/allowed
    if(!allowGallery) {
        input.setAttribute('capture', 'environment'); // or 'user' for front camera
    } else {
        // If allowGallery is true, we remove capture attribute or use 'environment' which might still favor camera first but allows file picker fallback
        input.removeAttribute('capture');
    }
    
    input.style.display = 'none';
    document.body.appendChild(input);

    input.addEventListener('change', () => {
      resolve({files: Array.from(input.files)});
      document.body.removeChild(input);
    });

    input.addEventListener('cancel', () => {
      reject(new Error('Input dibatalkan'));
      document.body.removeChild(input);
    });

    input.click();
  });
}


// --- CORE LOGIC: Area Management ---

refs.btnAddArea.addEventListener('click', ()=>{
  const name = refs.newAreaName.value.trim();
  if(!name) return alert('Nama Area wajib diisi!');

  const newArea = {
    id: uid('area'),
    name: name,
    detail: refs.newAreaDetail.value.trim(),
    description: '',
    photos: []
  };

  state.areas.push(newArea);
  refs.newAreaName.value = '';
  refs.newAreaDetail.value = '';
  renderAreas();
  saveState();
  // Activate the new area card
  document.querySelector(`#area-${newArea.id}`).classList.add('active');
  // Scroll to new area
  document.querySelector(`#area-${newArea.id}`).scrollIntoView({ behavior: 'smooth' });
});

function renderAreas(){
  refs.areasContainer.innerHTML = '';
  state.areas.forEach((area, areaIdx) => {
    const wrapper = document.createElement('div');
    wrapper.id = `area-${area.id}`;
    wrapper.className = 'area';

    const areaHeader = document.createElement('div');
    areaHeader.className = 'area-header';
    areaHeader.innerHTML = `
      <div class="area-title glitch" data-text="${area.name}">[${areaIdx + 1}] ${area.name}</div>
      <div style="display:flex;gap:8px">
        <button data-area-id="${area.id}" class="icon-btn edit-area" title="Edit Area"><i class="fas fa-pen"></i></button>
        <button data-area-id="${area.id}" class="icon-btn delete-area danger" title="Hapus Area"><i class="fas fa-trash"></i></button>
      </div>
    `;

    const detailP = document.createElement('p');
    detailP.className = 'muted';
    detailP.textContent = area.detail;

    const photosWrap = document.createElement('div');
    photosWrap.className = 'photos';
    
    area.photos.forEach((p, photoIdx) => {
      const col = document.createElement('div');
      col.style.display = 'flex';
      col.style.flexDirection = 'column';
      col.style.gap = '6px';
      
      const photoItem = document.createElement('div');
      photoItem.className = 'photo-item';
      
      const img = document.createElement('img');
      img.src = p.url;
      img.alt = p.desc || 'Area Photo';
      photoItem.appendChild(img);
      
      const actionWrap = document.createElement('div');
      actionWrap.style.cssText = 'position:absolute;top:5px;right:5px;display:flex;flex-direction:column;gap:5px;';
      
      const del = document.createElement('button');
      del.className = 'icon-btn danger delete-photo';
      del.innerHTML = '<i class="fas fa-trash"></i>';
      del.onclick = () => deletePhoto(areaIdx, photoIdx);
      
      const edit = document.createElement('button');
      edit.className = 'icon-btn edit-photo';
      edit.innerHTML = '<i class="fas fa-pen"></i>';
      edit.onclick = () => editPhoto(areaIdx, photoIdx);

      const ai = document.createElement('button');
      ai.className = 'icon-btn ai-photo';
      ai.innerHTML = '<i class="fas fa-robot"></i>';
      ai.onclick = () => showExpertAIModal(areaIdx, photoIdx);
      
      actionWrap.appendChild(del);
      actionWrap.appendChild(edit);
      actionWrap.appendChild(ai);
      photoItem.appendChild(actionWrap);
      
      const meta = document.createElement('div');
      meta.className='photo-meta';
      meta.innerHTML = `<div style="font-weight:700">${p.desc || '(klik pensil untuk deskripsi)'}</div> 
        <div style="font-size:11px;color:#555">${p.lat? p.lat.toFixed(6): '-'}, ${p.lon? p.lon.toFixed(6): '-'}<br>${p.ts? new Date(p.ts).toLocaleString(): ''}</div>`;

      col.appendChild(photoItem);
      col.appendChild(meta);
      photosWrap.appendChild(col);
    });

    wrapper.appendChild(areaHeader);
    wrapper.appendChild(detailP);
    
    const photoControls = document.createElement('div');
    photoControls.className = 'photo-controls';

    const addPhotoBtn = document.createElement('button');
    addPhotoBtn.className = 'btn';
    addPhotoBtn.innerHTML = '<i class="fas fa-camera"></i> Ambil Foto';
    addPhotoBtn.onclick = () => addPhoto(areaIdx, false);

    const uploadPhotoBtn = document.createElement('button');
    uploadPhotoBtn.className = 'btn ghost';
    uploadPhotoBtn.innerHTML = '<i class="fas fa-upload"></i> Upload Foto';
    uploadPhotoBtn.style.display = state.isAdmin ? 'inline-block' : 'none';
    uploadPhotoBtn.onclick = () => addPhoto(areaIdx, true);

    photoControls.appendChild(addPhotoBtn);
    photoControls.appendChild(uploadPhotoBtn);
    wrapper.appendChild(photoControls);
    wrapper.appendChild(photosWrap);
    
    const taLabel = document.createElement('label');
    taLabel.textContent = 'Deskripsi Area';
    taLabel.style.marginTop = '12px';
    wrapper.appendChild(taLabel);

    const ta = document.createElement('textarea');
    ta.placeholder='Deskripsi area...';
    ta.value = area.description || '';
    ta.oninput = ()=> {
      area.description = ta.value;
      saveState();
    };
    wrapper.appendChild(ta);

    refs.areasContainer.appendChild(wrapper);
  });
  
  // Attach event listeners for delete/edit after rendering
  refs.areasContainer.querySelectorAll('.delete-area').forEach(btn => {
    btn.onclick = (e) => deleteArea(e.currentTarget.dataset.areaId);
  });
  refs.areasContainer.querySelectorAll('.edit-area').forEach(btn => {
    btn.onclick = (e) => editArea(e.currentTarget.dataset.areaId);
  });
  
  saveState();
}

function deleteArea(areaId){
  if(!confirm('Yakin ingin menghapus Area ini beserta semua fotonya?')) return;
  const index = state.areas.findIndex(a => a.id === areaId);
  if(index > -1){
    // Revoke object URLs before deleting
    state.areas[index].photos.forEach(p => revoke(p.url));
    state.areas.splice(index, 1);
    renderAreas();
  }
}

function editArea(areaId){
  const area = state.areas.find(a => a.id === areaId);
  if(!area) return;
  
  const newName = prompt('Edit Nama Area:', area.name);
  if(newName === null) return;
  if(newName.trim()){
    area.name = newName.trim();
  }
  
  const newDetail = prompt('Edit Detail Lokasi (opsional):', area.detail);
  if(newDetail !== null){
    area.detail = newDetail.trim();
  }

  renderAreas();
}

async function addPhoto(areaIdx, allowGallery){
  try {
    const result = await createFileInput({allowGallery: allowGallery && state.isAdmin, multiple: true});
    const area = state.areas[areaIdx];
    
    const coords = { lat: 0, lon: 0, ts: Date.now() };
    if(refs.coords.textContent !== '—'){
      const [lat, lon] = refs.coords.textContent.split(',').map(s => parseFloat(s.trim()));
      coords.lat = lat;
      coords.lon = lon;
    }

    for (const file of result.files) {
      const url = URL.createObjectURL(file);
      area.photos.push({
        id: uid('photo'),
        url: url,
        file: file, // Store File object temporarily
        lat: coords.lat,
        lon: coords.lon,
        ts: coords.ts,
        desc: '' // description added later via editPhoto
      });
    }

    renderAreas();
    saveState();
    alert(`${result.files.length} foto berhasil ditambahkan ke ${area.name}!`);

  } catch (e) {
    alert('Gagal mengambil/mengunggah foto: ' + e.message);
  }
}

function deletePhoto(areaIdx, photoIdx){
  if(!confirm('Yakin ingin menghapus foto ini?')) return;
  const photo = state.areas[areaIdx].photos[photoIdx];
  revoke(photo.url);
  state.areas[areaIdx].photos.splice(photoIdx, 1);
  renderAreas();
  saveState();
}

function editPhoto(areaIdx, photoIdx){
  const photo = state.areas[areaIdx].photos[photoIdx];
  const newDesc = prompt('Edit Deskripsi Foto:', photo.desc || '');
  if(newDesc !== null){
    photo.desc = newDesc.trim();
    renderAreas();
    saveState();
  }
}

// --- Expert AI Modal ---
function showExpertAIModal(areaIdx, photoIdx){
    const area = state.areas[areaIdx];
    const photo = area.photos[photoIdx];
    
    const modal = refs.expertCard;
    const list = modal.querySelector('#expertList');
    list.innerHTML = '';
    
    // 1. Render Checkboxes
    Object.keys(EXPERT_TEMPLATES).forEach((id) => {
        const item = document.createElement('div');
        item.className = 'expert-item';
        item.innerHTML = `
            <input type="checkbox" id="expert_${id}" value="${id}" checked>
            <label for="expert_${id}" style="display:inline">${EXPERT_TEMPLATES[id].split('—')[0].trim()}</label>
        `;
        list.appendChild(item);
    });
    
    // 2. Attach Handlers
    const progress = refs.progressStatus;
    const descField = findDescriptionField();

    if(!descField) {
        progress.textContent = 'Error: Tidak dapat menemukan field deskripsi area yang aktif.';
        return;
    }
    
    const closeModal = () => {
        refs.modalBackdrop.style.display = 'none';
        progress.textContent = '';
    };

    // Reattach main handlers
    refs.btnCancel.onclick = closeModal;
    refs.modalBackdrop.onclick = (e) => { if (e.target === refs.modalBackdrop) closeModal(); };

    // Handler for ONLINE AI (Gemini)
    refs.btnGenOnline.onclick = async () => {
        progress.textContent = 'Mulai Analisa Online...';
        
        const selectedIds = Array.from(list.querySelectorAll('input:checked')).map(i => i.value);
        if(selectedIds.length === 0) {
            alert('Pilih minimal satu perspektif ahli.');
            progress.textContent = '';
            return;
        }
        
        const promptHeader = selectedIds.map(id => EXPERT_TEMPLATES[id]).join('\n');
        const finalPrompt = `Anda adalah Asisten Analisis K3/Security yang bertindak sebagai beberapa ahli. Berikan hasil analisis ringkas, padat, dan bertarget hanya berdasarkan gambar ini, dengan mempertimbangkan perspektif ahli berikut:\n\n---\n${promptHeader}\n---\n\nBerikan hasil dalam 3-5 paragraf yang mencakup temuan, risiko, dan rekomendasi. Format output dalam bahasa Indonesia.`;
        
        try {
            progress.textContent = 'Mengirim gambar ke Gemini... (max 30s)';
            
            const result = await expertAI({
                imageUrl: photo.url, 
                areaIdx: areaIdx, 
                photoIdx: photoIdx, 
                opts: selectedIds,
            });
            
            // Append result to area description
            let currentDesc = area.description || '';
            const newDesc = `\n\n[Analisis AI - ${new Date().toLocaleString()}]\n${result.text}`;
            
            area.description = (currentDesc.trim() + newDesc).trim();
            descField.value = area.description;
            
            renderAreas();
            saveState();
            closeModal();
            alert('Analisa Gemini berhasil ditambahkan ke Deskripsi Area!');

        } catch (e) {
            console.error('Gemini AI Call Failed:', e);
            alert(`Gagal menjalankan Analisa Gemini: ${e.message}`);
            progress.textContent = 'Gagal: ' + e.message;
        }
    };
    
    // Handler for OFFLINE AI (Mocked)
    refs.btnGenOffline.onclick = async () => {
        progress.textContent = 'Mencari foto terbaru…';
        
        const blob = await findLatestImageBlob(areaIdx);
        if(!blob){
            progress.textContent='Foto tidak ditemukan. Upload foto area dahulu.';
            return;
        }

        try {
            progress.textContent = 'Analisa gambar (offline, mock)…';
            // MOCKING the result of analyzeImage since dependencies are not included
            const analysis = await analyzeImage(blob, progress); 
            
            const selectedIds = Array.from(list.querySelectorAll('input:checked')).map(i=>i.value);
            
            const coords = { lat: photo.lat, lon: photo.lon, ts: photo.ts };
            const composedText = composeDescription(selectedIds, analysis, coords);

            // Append result to area description
            let currentDesc = area.description || '';
            const newDesc = `\n\n[Analisis Offline - ${new Date().toLocaleTimeString()}]\n${composedText}`;
            
            area.description = (currentDesc.trim() + newDesc).trim();
            descField.value = area.description;
            
            renderAreas();
            saveState();
            closeModal();
            alert('Analisa Offline (Mock) berhasil ditambahkan ke Deskripsi Area!');
            
        } catch (e) {
            console.error('Offline Analysis Failed:', e);
            progress.textContent = 'Gagal Analisa Offline: ' + e.message;
        }
    };

    // Handler for Expert Sentences (Pre-written)
    refs.btnExpertSentences.onclick = () => {
        closeModal(); // Close main modal

        // Open new modal for sentences
        const sentenceModal = document.createElement('div');
        sentenceModal.className = 'modal-backdrop';
        sentenceModal.style.display = 'flex';
        sentenceModal.innerHTML = `
            <div class="card modal" style="max-width:500px">
                <h3>Tambahkan Kalimat Expert</h3>
                <p class="muted">Pilih kalimat yang sesuai. Kalimat akan ditambahkan ke Deskripsi Area.</p>
                
                <div id="sentenceList" style="max-height:300px;overflow-y:auto;border:1px solid var(--border);padding:10px;border-radius:8px;background:rgba(255,255,255,0.03)">
                    </div>
                
                <div style="margin-top:15px;display:flex;justify-content:space-between;gap:8px">
                    <button id="checkAllBtn" class="btn ghost">Pilih Semua</button>
                    <button id="uncheckAllBtn" class="btn ghost">Batal Semua</button>
                </div>
                <div style="margin-top:10px;display:flex;justify-content:flex-end;gap:8px">
                    <button id="cancelSentenceBtn" class="btn danger ghost">Batal</button>
                    <button id="applySentenceBtn" class="btn">Tambahkan</button>
                </div>
            </div>
        `;
        document.body.appendChild(sentenceModal);
        
        const sentenceList = sentenceModal.querySelector('#sentenceList');
        
        // Render sentences
        Object.keys(EXPERT_SENTENCES_DB).forEach((category, catIndex) => {
            const catHeader = document.createElement('h4');
            catHeader.style.cssText = 'margin:8px 0 4px;color:var(--primary);font-size:14px;border-bottom:1px solid var(--border);padding-bottom:4px';
            catHeader.textContent = category.replace(/_/g, ' ').toUpperCase();
            sentenceList.appendChild(catHeader);

            EXPERT_SENTENCES_DB[category].forEach((sentence, idx) => {
                const item = document.createElement('div');
                item.style.marginBottom = '6px';
                item.innerHTML = `
                    <input type="checkbox" id="sent_${catIndex}_${idx}" value="${sentence}">
                    <label for="sent_${catIndex}_${idx}" style="display:inline;font-size:13px">${sentence}</label>
                `;
                sentenceList.appendChild(item);
            });
        });
        
        const checkAllBtn = sentenceModal.querySelector('#checkAllBtn');
        const uncheckAllBtn = sentenceModal.querySelector('#uncheckAllBtn');
        const cancelBtn = sentenceModal.querySelector('#cancelSentenceBtn');
        const applyBtn = sentenceModal.querySelector('#applySentenceBtn');
        
        checkAllBtn.onclick = () => { sentenceList.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = true); };
        uncheckAllBtn.onclick = () => { sentenceList.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false); };
        
        cancelBtn.onclick = () => { document.body.removeChild(sentenceModal); };
        
        applyBtn.onclick = () => {
            const selectedSentences = Array.from(sentenceList.querySelectorAll('input:checked')).map(i => i.value);

            if (selectedSentences.length > 0) {
                let currentDesc = area.description || '';
                const newDesc = selectedSentences.join('\n'); 
                
                if (currentDesc.trim()) {
                    area.description = currentDesc + '\n\n' + newDesc;
                } else {
                    area.description = newDesc;
                }
                
                descField.value = area.description;
                renderAreas();
                saveState();
                alert(`${selectedSentences.length} kalimat expert ditambahkan!`);
            } else {
                alert('Pilih minimal satu kalimat');
                return;
            }
            document.body.removeChild(sentenceModal);
        };
        
        // Close on backdrop click
        sentenceModal.onclick = (e) => {
            if (e.target === sentenceModal) {
                document.body.removeChild(sentenceModal);
            }
        };
    };

    refs.modalBackdrop.style.display = 'flex';
}

// --- TAB SWITCHING ---
refs.tabAreas.addEventListener('click', () => switchTab('areaTab', 'tabAreas'));
refs.tabCheckpoint.addEventListener('click', () => switchTab('checkpointTab', 'tabCheckpoint'));
refs.tabLokasi.addEventListener('click', () => switchTab('lokasiTab', 'tabLokasi'));
refs.tabFotoProfil.addEventListener('click', () => switchTab('fotoProfilTab', 'tabFotoProfil'));
refs.tabDeep.addEventListener('click', () => switchTab('deepTab', 'tabDeep'));

refs.tabViewAreas.addEventListener('click', () => switchView('viewAreas', 'tabViewAreas'));
refs.tabSignature.addEventListener('click', () => switchView('viewSignature', 'tabSignature'));

function switchTab(targetId, tabId) {
  const tabs = [refs.areaTab, refs.checkpointTab, refs.lokasiTab, refs.fotoProfilTab, refs.deepTab];
  const tabButtons = [refs.tabAreas, refs.tabCheckpoint, refs.tabLokasi, refs.tabFotoProfil, refs.tabDeep];
  
  tabs.forEach(tab => tab.classList.add('hidden'));
  tabButtons.forEach(btn => btn.classList.remove('active'));
  
  document.getElementById(targetId).classList.remove('hidden');
  document.getElementById(tabId).classList.add('active');
}

function switchView(targetId, tabId) {
  const views = [refs.viewAreas, refs.viewSignature];
  const tabButtons = [refs.tabViewAreas, refs.tabSignature];
  
  views.forEach(view => view.classList.add('hidden'));
  tabButtons.forEach(btn => btn.classList.remove('active'));
  
  document.getElementById(targetId).classList.remove('hidden');
  document.getElementById(tabId).classList.add('active');
  
  if(targetId === 'viewSignature') renderSignature();
}


// --- Signature Pad Logic (Simplified) ---
let isDrawing = false;
let sigContext;

function initSignatureCanvas(){
    sigContext = refs.sigCanvas.getContext('2d');
    sigContext.lineWidth = 3;
    sigContext.lineCap = 'round';
    sigContext.strokeStyle = '#000000'; // Black stroke on white canvas
    sigContext.fillStyle = '#FFFFFF';
    sigContext.fillRect(0, 0, refs.sigCanvas.width, refs.sigCanvas.height);

    refs.sigCanvas.addEventListener('mousedown', startDrawing);
    refs.sigCanvas.addEventListener('mousemove', draw);
    refs.sigCanvas.addEventListener('mouseup', stopDrawing);
    refs.sigCanvas.addEventListener('mouseout', stopDrawing);

    refs.sigCanvas.addEventListener('touchstart', (e) => {
        e.preventDefault();
        startDrawing(e.touches[0]);
    });
    refs.sigCanvas.addEventListener('touchmove', (e) => {
        e.preventDefault();
        draw(e.touches[0]);
    });
    refs.sigCanvas.addEventListener('touchend', stopDrawing);
}

function startDrawing(e){
    isDrawing = true;
    sigContext.beginPath();
    sigContext.moveTo(e.offsetX || e.clientX - refs.sigCanvas.offsetLeft, e.offsetY || e.clientY - refs.sigCanvas.offsetTop);
}

function draw(e){
    if(!isDrawing) return;
    sigContext.lineTo(e.offsetX || e.clientX - refs.sigCanvas.offsetLeft, e.offsetY || e.clientY - refs.sigCanvas.offsetTop);
    sigContext.stroke();
}

function stopDrawing(){
    isDrawing = false;
    sigContext.closePath();
}

function clearSignature(){
    sigContext.fillRect(0, 0, refs.sigCanvas.width, refs.sigCanvas.height);
}

function renderSignature(){
  if(!sigContext) initSignatureCanvas();
  refs.sigName.value = state.signature ? (state.signature.name || '') : '';
  
  if(state.signature && state.signature.dataURL){
    clearSignature(); // Clear canvas first
    const img = new Image();
    img.onload = () => {
      // Draw onto main canvas
      sigContext.drawImage(img, 0, 0); 
      // Update preview
      refs.sigPreview.src = state.signature.dataURL;
    };
    img.src = state.signature.dataURL;
    
  } else {
    clearSignature();
    refs.sigPreview.src = '';
  }
}

refs.btnClearSig.addEventListener('click', () => {
  if(confirm('Yakin hapus tanda tangan?')){
    state.signature = null;
    renderSignature();
    saveState();
  }
});

refs.btnSaveSig.addEventListener('click', () => {
  const name = refs.sigName.value.trim();
  if(!name) return alert('Nama pada tanda tangan wajib diisi!');
  
  const dataURL = refs.sigCanvas.toDataURL('image/png');
  state.signature = { name, dataURL };
  renderSignature();
  saveState();
  alert('Tanda tangan berhasil disimpan!');
});


// --- Deep Clean ---
refs.btnDeepClean.addEventListener('click', ()=>{
  if(confirm('PERINGATAN! Anda akan menghapus SEMUA data lokal (Area, Foto, Tanda Tangan, Checkpoint, Path GPS, Password Admin). Lanjutkan?')){
    localStorage.clear();
    alert('Deep Clean Berhasil. Aplikasi akan di-reload.');
    window.location.reload();
  }
});
refs.btnDeepCancel.addEventListener('click', ()=> switchTab('areaTab', 'tabAreas'));


// --- PDF Generation ---
async function uploadPhotoToCloudinary(file){
    return new Promise((resolve, reject) => {
        if(!window.CLOUDINARY) return reject(new Error('Cloudinary config missing'));
        
        const url = `https://api.cloudinary.com/v1_1/${window.CLOUDINARY.cloudName}/upload`;
        const formData = new FormData();
        formData.append('file', file);
        formData.append('upload_preset', window.CLOUDINARY.uploadPreset);

        function attemptUpload(attempt = 1) {
            const xhr = new XMLHttpRequest();
            xhr.timeout = 30000; // 30 second timeout
            xhr.open('POST', url, true);

            xhr.onreadystatechange = function() {
                if(xhr.readyState == 4) {
                    if(xhr.status == 200) {
                        try{
                            var res = JSON.parse(xhr.responseText);
                            resolve(res.secure_url);
                        } catch(e) {
                            if (attempt < 3) {
                                console.log(`Retry upload attempt ${attempt + 1}`);
                                setTimeout(() => attemptUpload(attempt + 1), 1000 * attempt);
                            } else {
                                reject(e);
                            }
                        }
                    } else {
                         if (attempt < 3) {
                            console.log(`Retry upload attempt ${attempt + 1}`);
                            setTimeout(() => attemptUpload(attempt + 1), 1000 * attempt);
                        } else {
                            reject(xhr.responseText || xhr.status);
                        }
                    }
                }
            };
            xhr.ontimeout = function() {
                 if (attempt < 3) {
                    console.log(`Retry upload attempt ${attempt + 1}`);
                    setTimeout(() => attemptUpload(attempt + 1), 1000 * attempt);
                } else {
                    reject(new Error('Upload Timeout'));
                }
            };
            xhr.send(formData);
        }

        // Start upload attempt
        attemptUpload();
    });
}

refs.btnGeneratePDF.addEventListener('click', async ()=>{
  if(state.areas.length === 0) return alert('Tidak ada Area untuk dibuat PDF.');
  
  refs.btnGeneratePDF.textContent = 'Memproses...';
  refs.btnGeneratePDF.disabled = true;
  
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF('p', 'mm', 'a4'); // Portrait, mm, A4

  const margin = 10;
  const pageHeight = doc.internal.pageSize.getHeight();
  const contentWidth = doc.internal.pageSize.getWidth() - 2 * margin;
  let cursorY = margin;
  
  const officerNameVal = refs.officerName.value || 'Petugas Patroli';
  const shiftVal = refs.shift.value || 'N/A';
  const dateVal = refs.date.value || new Date().toISOString().slice(0, 10);
  const waktu = new Date().toLocaleTimeString();
  const lokasiHeader = refs.manualLokasi.value || (state.gpsPath.length > 0 ? `GPS Coords (${state.gpsPath.length} titik)` : 'Lokasi Manual');

  try {
    // --- Cover Page ---
    
    // Set font size and style for cover
    doc.setFontSize(30).setFont(undefined, 'bold');
    doc.setTextColor(20, 20, 20); // Darker text

    // Title
    const title = 'LAPORAN PATROLI HARIAN';
    doc.text(title, doc.internal.pageSize.getWidth() / 2, 50, { align: 'center' });

    // Logo / Branding (Placeholder)
    doc.setFontSize(14).setFont(undefined, 'normal');
    doc.text('Company Patrol/Security Logo Here', doc.internal.pageSize.getWidth() / 2, 60, { align: 'center' });
    
    // Upload Profile Photo (if exists) and insert to cover
    let profilePhotoURL = null;
    if(state.profilePhoto && state.profilePhoto.file){
        doc.setFontSize(10).setTextColor(150, 150, 150);
        doc.text('Uploading Profile Photo...', margin, pageHeight - 10);
        
        // Use Blob to DataURL conversion if needed, but here we expect it to be a File object
        const photoDataURL = await new Promise((res, rej) => {
            const fr = new FileReader();
            fr.onload = () => res(fr.result);
            fr.onerror = rej;
            fr.readAsDataURL(state.profilePhoto.file);
        });
        
        doc.addImage(photoDataURL, 'JPEG', contentWidth - 50, 80, 50, 70); // Adjusted position for a cleaner look
        doc.setFontSize(10).setTextColor(20, 20, 20); // Reset color
    }
    
    // Detail Box
    const boxX = margin + 10;
    const boxY = 80;
    const boxWidth = contentWidth / 2;
    const boxHeight = 100;

    doc.setFillColor(240, 240, 240);
    doc.rect(boxX, boxY, boxWidth, boxHeight, 'F');
    doc.setDrawColor(0, 0, 0);
    doc.setLineWidth(0.5);
    doc.rect(boxX, boxY, boxWidth, boxHeight, 'S');
    
    doc.setTextColor(50, 50, 50);
    doc.setFontSize(12).setFont(undefined, 'bold');
    doc.text('Detail Patroli:', boxX + 5, boxY + 10);

    const dataRows = [
        {label: 'Petugas', value: officerNameVal},
        {label: 'Tanggal', value: dateVal},
        {label: 'Shift', value: shiftVal},
        {label: 'Jam Cetak', value: waktu},
        {label: 'Lokasi', value: lokasiHeader}
    ];
    doc.setFontSize(11).setFont(undefined, 'normal');
    let dataY = boxY + 20;
    const rowHeight = 15;
    
    dataRows.forEach(row => {
        doc.text(`${row.label}:`, boxX + 5, dataY);
        doc.text(row.value, boxX + 5 + boxWidth / 3, dataY);
        dataY += 8;
    });

    // GPS Path/Map Placeholder
    doc.setFontSize(10).setTextColor(150, 150, 150);
    doc.text(`GPS Path recorded: ${state.gpsPath.length} points. (Map Placeholder)`, boxX + 5, boxY + boxHeight + 20);
    
    // Footer
    doc.setFontSize(10).setTextColor(150, 150, 150);
    doc.text('Laporan ini dihasilkan oleh Patroli App pada ' + new Date().toLocaleString(), doc.internal.pageSize.getWidth() / 2, pageHeight - 10, { align: 'center' });

    // --- Content Pages ---
    doc.addPage();
    cursorY = margin;

    doc.setFontSize(16).setFont(undefined, 'bold');
    doc.setTextColor(20, 20, 20);
    doc.text('HASIL PATROLI', margin, cursorY + 5);
    cursorY += 15;
    
    // Process Areas
    for(let areaIdx = 0; areaIdx < state.areas.length; areaIdx++){
      const area = state.areas[areaIdx];
      
      // Area Header
      doc.setFontSize(14).setFont(undefined, 'bold');
      doc.setTextColor(0, 0, 150); // Blue for Area title
      const areaTitle = `[${areaIdx + 1}] ${area.name} (${area.detail || 'Tanpa Detail'})`;
      doc.text(areaTitle, margin, cursorY);
      cursorY += 5;
      
      // Area Description
      doc.setFontSize(10).setFont(undefined, 'normal');
      doc.setTextColor(50, 50, 50);
      const descLines = doc.splitTextToSize(area.description || 'Tidak ada deskripsi area.', contentWidth);
      descLines.forEach(line => {
        if(cursorY > pageHeight - margin - 10){
          doc.addPage();
          cursorY = margin;
        }
        doc.text(line, margin, cursorY);
        cursorY += 4.5;
      });
      cursorY += 5; // Extra space after description

      // Process Photos
      for(let photoIdx = 0; photoIdx < area.photos.length; photoIdx++){
        const photo = area.photos[photoIdx];
        
        // Handle page break before photo/description block
        const requiredSpace = 70; // Estimate space needed for photo (50mm height) + metadata
        if(cursorY > pageHeight - margin - requiredSpace){
          doc.addPage();
          cursorY = margin;
        }

        doc.setFontSize(10).setFont(undefined, 'bold');
        doc.setTextColor(100, 100, 100);
        doc.text(`Foto ${photoIdx + 1} (${new Date(photo.ts).toLocaleString()})`, margin, cursorY);
        cursorY += 2;
        
        try{
          // Convert Object URL back to DataURL for jspdf
          const photoBlob = await new Promise((res, rej) => {
            fetch(photo.url)
              .then(response => response.blob())
              .then(blob => res(blob))
              .catch(rej);
          });
          const photoDataURL = await new Promise((res, rej) => {
            const fr = new FileReader();
            fr.onload = () => res(fr.result);
            fr.onerror = rej;
            fr.readAsDataURL(photoBlob);
          });

          const photoWidth = contentWidth / 2 - 5;
          const photoHeight = photoWidth * 0.75; // Aspect ratio 4:3
          
          const photoX = margin;
          const descX = margin + photoWidth + 5;
          
          doc.addImage(photoDataURL, 'JPEG', photoX, cursorY, photoWidth, photoHeight);

          // Photo Description/Metadata
          doc.setFontSize(9).setFont(undefined, 'normal');
          doc.setTextColor(50, 50, 50);
          
          const metaLines = [
            `Deskripsi: ${photo.desc || '(kosong)'}`,
            `Koordinat: ${photo.lat.toFixed(6)}, ${photo.lon.toFixed(6)}`,
          ].join('\n');
          
          const descLines = doc.splitTextToSize(metaLines, contentWidth / 2 - 5);
          let textY = cursorY + 5;
          
          descLines.forEach(line => {
             doc.text(line, descX, textY);
             textY += 4.5;
          });

          cursorY += Math.max(photoHeight, (descLines.length * 4.5) + 10) + 15; // Move cursor past the tallest element (photo or text)

          // Separator line
          if(cursorY < pageHeight - margin - 5){
            doc.setDrawColor(200, 200, 200);
            doc.setLineWidth(0.3);
            doc.line(margin, cursorY - 5, margin + contentWidth, cursorY - 5);
          }
        } catch(e) { 
          console.warn('Photo processing failed', e);
          doc.setFontSize(10).setTextColor(255, 0, 0);
          doc.text(`[ERROR: Gagal memuat foto ${photoIdx + 1}]`, margin, cursorY);
          cursorY += 10;
        }
      }
      // Space between areas
      cursorY += 5;
    }
    
    // --- Signature Page (always add) ---
    doc.addPage();
    doc.setFontSize(16).setFont(undefined, 'bold');
    doc.setTextColor(20, 20, 20);
    doc.text('TANDA TANGAN PETUGAS', margin, 30);
    
    if(state.signature && state.signature.dataURL){
      try{
        const sigWidth = 80;
        const sigHeight = 40;
        const sigX = margin + (contentWidth - sigWidth) / 2;
        doc.addImage(state.signature.dataURL, 'PNG', sigX, 45, sigWidth, sigHeight);
      } catch(e) { 
        console.warn('Signature add failed', e); 
      }
    } else {
      doc.setFontSize(12).setFont(undefined, 'normal');
      doc.setTextColor(150, 150, 150);
      doc.text('(Tidak ada tanda tangan tersimpan)', margin, 55);
    }
    
    const lineY = 45 + 40 + 15;
    doc.setDrawColor(0, 0, 0);
    doc.setLineWidth(0.7);
    doc.line(margin, lineY, margin + contentWidth, lineY);
    
    doc.setFontSize(12).setFont(undefined, 'bold');
    doc.setTextColor(20, 20, 20);
    const nameToPrint = refs.officerName.value || 'Petugas';
    doc.text(nameToPrint, margin + contentWidth/2, lineY + 10, { align: 'center' });

    // Save PDF
    doc.save(`Patroli-Laporan-${dateVal}-${shiftVal}.pdf`);
    
  } catch (error) {
    console.error('PDF Generation Error:', error);
    alert('Gagal membuat PDF: ' + error.message);
  } finally {
    refs.btnGeneratePDF.textContent = 'Generate PDF';
    refs.btnGeneratePDF.disabled = false;
  }
});


// --- Profile Photo Logic ---
function renderProfilePhoto(){
    if(state.profilePhoto && state.profilePhoto.url){
        refs.profilePhotoPreview.innerHTML = `<img src="${state.profilePhoto.url}" style="width:100%;height:100%;object-fit:cover;border-radius:6px;">`;
        refs.profilePhotoPreview.style.display = 'block';
        refs.btnRemoveProfilePhoto.style.display = 'inline-block';
    } else {
        refs.profilePhotoPreview.innerHTML = '';
        refs.profilePhotoPreview.style.display = 'none';
        refs.btnRemoveProfilePhoto.style.display = 'none';
    }
}

refs.btnTakeProfilePhoto.addEventListener('click', async () => {
    try {
        // Use false to prefer camera capture
        const result = await createFileInput({allowGallery: false, multiple: false}); 
        if (result.files.length > 0) {
            const file = result.files[0];
            const url = URL.createObjectURL(file);
            if (state.profilePhoto) revoke(state.profilePhoto.url);
            state.profilePhoto = { file, url };
            renderProfilePhoto();
            saveState();
            alert('Foto profil berhasil diambil!');
        }
    } catch (e) {
        alert('Gagal mengambil foto: ' + e.message);
    }
});

refs.btnUploadProfilePhoto.addEventListener('click', async () => {
    if (!state.isAdmin) return alert('Hanya Admin yang dapat mengupload dari Galeri');
    try {
        // Use true to allow gallery/file picker
        const result = await createFileInput({allowGallery: true, multiple: false}); 
        if (result.files.length > 0) {
            const file = result.files[0];
            const url = URL.createObjectURL(file);
            if (state.profilePhoto) revoke(state.profilePhoto.url);
            state.profilePhoto = { file, url };
            renderProfilePhoto();
            saveState();
            alert('Foto profil berhasil diupload!');
        }
    } catch (e) {
        alert('Gagal upload foto: ' + e.message);
    }
});

refs.btnRemoveProfilePhoto.addEventListener('click', () => {
    if (state.profilePhoto) {
        revoke(state.profilePhoto.url);
        state.profilePhoto = null;
        renderProfilePhoto();
        saveState();
        alert('Foto profil dihapus!');
    }
});


// --- Checkpoint (QR) Logic ---
const qrManual = new window.QRious({
  element: refs.qrCanvasManual,
  size: 150,
  value: '{"area":"AREA 1","detail":"DETAIL LOKASI"}' // Default
});

function generateQRManual(){
    const area = refs.qrAreaName.value.trim() || 'AREA BARU';
    const detail = refs.qrAreaDetail.value.trim() || '';
    const json = JSON.stringify({ area: area, detail: detail, ts: Date.now() });
    qrManual.value = json;
    refs.btnDownloadQRManual.disabled = false;
    refs.btnCopyQRDataManual.disabled = false;
    refs.btnCopyQRContentManual.disabled = false;
}
refs.btnGenerateQRManual.addEventListener('click', generateQRManual);

refs.qrAreaName.addEventListener('input', generateQRManual);
refs.qrAreaDetail.addEventListener('input', generateQRManual);

refs.btnDownloadQRManual.addEventListener('click', () => {
  const link = document.createElement('a');
  link.download = `QR-Checkpoint-${refs.qrAreaName.value.trim() || 'BARU'}.png`;
  link.href = refs.qrCanvasManual.toDataURL('image/png');
  link.click();
});

refs.btnCopyQRDataManual.addEventListener('click', () => {
    navigator.clipboard.writeText(refs.qrCanvasManual.toDataURL('image/png'))
        .then(() => alert('DataURL QR berhasil disalin!'))
        .catch(err => alert('Gagal menyalin: ' + err));
});

refs.btnCopyQRContentManual.addEventListener('click', () => {
    navigator.clipboard.writeText(qrManual.value)
        .then(() => alert('Konten QR berhasil disalin!'))
        .catch(err => alert('Gagal menyalin: ' + err));
});

refs.btnSaveCheckpoint.addEventListener('click', () => {
    const area = refs.qrAreaName.value.trim() || 'AREA BARU';
    const detail = refs.qrAreaDetail.value.trim() || 'DETAIL BARU';
    const json = qrManual.value;
    
    if (state.checkpoints.find(c => c.json === json)) {
        return alert('Checkpoint ini sudah ada di daftar.');
    }
    
    state.checkpoints.push({ area, detail, json });
    renderCheckpointList();
    saveState();
    alert('Checkpoint berhasil disimpan!');
});

function renderCheckpointList(){
    const list = refs.qrList;
    list.innerHTML = '';
    state.checkpoints.forEach((c, idx) => {
        const row = document.createElement('div');
        row.className = 'qr-row';
        row.innerHTML = `
            <div>
                <strong>${c.area}</strong>
                <div class="small">${c.detail}</div>
            </div>
            <button data-index="${idx}" class="btn danger" style="margin-left:auto"><i class="fas fa-trash"></i></button>
        `;
        list.appendChild(row);
    });
    
    list.querySelectorAll('.danger').forEach(btn => {
        btn.onclick = (e) => {
            const idx = parseInt(e.currentTarget.dataset.index);
            if(confirm('Hapus Checkpoint ini?')){
                state.checkpoints.splice(idx, 1);
                renderCheckpointList();
                saveState();
            }
        };
    });
}

// QR Scan Logic
let stream = null;
let lastScanTime = 0;

async function startCameraScan(){
    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        alert('Kamera tidak didukung di browser ini.');
        return;
    }
    
    refs.cameraOverlay.classList.remove('hidden');
    
    try {
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
        refs.cameraVideo.srcObject = stream;
        refs.cameraVideo.play();
        requestAnimationFrame(tick);
    } catch (err) {
        refs.cameraOverlay.classList.add('hidden');
        alert('Gagal mengakses kamera: ' + err.message);
    }
}

function stopCameraScan(){
    if (stream) {
        stream.getTracks().forEach(track => track.stop());
        stream = null;
    }
    refs.cameraVideo.srcObject = null;
    refs.cameraOverlay.classList.add('hidden');
}

refs.btnStartScan.addEventListener('click', startCameraScan);
refs.closeCamera.addEventListener('click', stopCameraScan);
refs.stopCameraBtn.addEventListener('click', stopCameraScan);

refs.btnFileScan.addEventListener('click', async () => {
    try {
        const result = await createFileInput({allowGallery: true, multiple: false});
        if(result.files.length > 0){
            scanFile(result.files[0]);
        }
    } catch (e) {
        alert('Gagal memilih file: ' + e.message);
    }
});

const canvasForScan = document.createElement('canvas');
const ctxForScan = canvasForScan.getContext('2d');

function tick() {
    if (refs.cameraVideo.readyState === refs.cameraVideo.HAVE_ENOUGH_DATA) {
        if (Date.now() - lastScanTime > 500) { // Scan every 500ms
            
            const videoWidth = refs.cameraVideo.videoWidth;
            const videoHeight = refs.cameraVideo.videoHeight;
            
            canvasForScan.width = videoWidth;
            canvasForScan.height = videoHeight;
            ctxForScan.drawImage(refs.cameraVideo, 0, 0, videoWidth, videoHeight);
            
            const imageData = ctxForScan.getImageData(0, 0, videoWidth, videoHeight);
            const code = window.jsQR(imageData.data, imageData.width, imageData.height);
            
            if (code) {
                stopCameraScan();
                processScanResult(code.data);
                return;
            }
            lastScanTime = Date.now();
        }
    }
    if (stream) requestAnimationFrame(tick);
}

function scanFile(f){
    const img = new Image();
    img.onload = () => {
        canvasForScan.width = img.width;
        canvasForScan.height = img.height;
        ctxForScan.drawImage(img, 0, 0);
        
        const d = ctxForScan.getImageData(0, 0, canvasForScan.width, canvasForScan.height);
        const code = window.jsQR(d.data, d.width, d.height);
        
        if(code){
            processScanResult(code.data);
        } else {
            alert('QR tidak terdeteksi pada gambar ini');
            refs.scanResult.textContent = 'Hasil scan: tidak terdeteksi';
        }
    };
    img.onerror = ()=> alert('Gagal memuat file gambar');
    img.src = URL.createObjectURL(f);
}

function processScanResult(data){
    refs.scanResult.textContent = 'Hasil scan: '+data;
    try{
        const p = JSON.parse(data);
        refs.qrAreaName.value = p.area || '';
        refs.qrAreaDetail.value = p.detail || '';
        refs.newAreaName.value = p.area || '';
        refs.newAreaDetail.value = p.detail || '';
        alert('QR JSON terbaca. Data terisi di tab Area & Checkpoint.');
    } catch(e){
        refs.qrAreaName.value = data;
        refs.newAreaName.value = data;
        refs.qrAreaDetail.value = '';
        refs.newAreaDetail.value = '';
        alert('QR text terbaca. Data terisi di tab Area & Checkpoint.');
    }
}

refs.btnScanAreaQR.addEventListener('click', async () => {
    try {
        await startCameraScan();
        // The QR processing is done inside the tick loop which calls processScanResult, 
        // which updates the Area/Checkpoint inputs.
    } catch (e) {
        alert('Gagal memulai scan: ' + e.message);
    }
});


// --- Chat/Notification Logic ---
const CHAT_DB_REF = firebase.database().ref('patrol_chat');

function getLocalUid() {
    let uid = localStorage.getItem('patrol_uid');
    if (!uid) {
        uid = 'user_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('patrol_uid', uid);
    }
    return uid;
}

function renderMessage(message, uid) {
    const div = document.createElement('div');
    div.className = `chat-message ${message.uid === uid ? 'own' : 'other'}`;
    div.dataset.messageId = message.id;
    div.innerHTML = `
        <div style="font-weight:700;font-size:12px;opacity:0.9">${message.name}</div>
        <div>${message.text}</div>
        <div class="chat-meta">${new Date(message.timestamp).toLocaleTimeString()}</div>
    `;
    return div;
}

function subscribeToChat() {
    const uid = getLocalUid();
    
    // Listen for new messages
    CHAT_DB_REF.limitToLast(50).on('child_added', snapshot => {
        const message = snapshot.val();
        message.id = snapshot.key;
        
        const messageDiv = renderMessage(message, uid);
        refs.chatMessages.appendChild(messageDiv);
        refs.chatMessages.scrollTop = refs.chatMessages.scrollHeight;

        // Handle unread status and notification
        if (message.uid !== uid && !state.chatOpen && message.timestamp > state.lastDelivered) {
            state.unreadCount++;
            updateUnreadBadge();
            showNotification(message);
        }
    });
}

function updateUnreadBadge() {
    if (state.unreadCount > 0) {
        refs.unreadBadge.textContent = state.unreadCount;
        refs.unreadBadge.classList.remove('hidden');
        refs.chatBubble.classList.add('has-new');
    } else {
        refs.unreadBadge.classList.add('hidden');
        refs.chatBubble.classList.remove('has-new');
    }
}

function showNotification(message) {
    // Request permission if not granted
    if (Notification.permission === 'default') {
        Notification.requestPermission();
    }
    
    if (document.hidden && Notification.permission === 'granted') {
        new Notification(`Pesan dari ${message.name}`, { 
            body: message.text, 
            icon: '/favicon.ico' 
        });
    } else if (!document.hidden) {
        // Page is visible - show subtle notification
        const notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed; top: 20px; right: 20px; background: var(--primary); color: white; padding: 12px 16px; 
            border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 10001; 
            max-width: 300px; word-wrap: break-word; 
        `;
        notification.innerHTML = `
            <strong>${message.name}</strong><br>
            ${message.text}
        `;
        document.body.appendChild(notification);
        setTimeout(() => { notification.remove(); }, 5000);
    }
    
    // Vibration if supported
    if ('vibrate' in navigator) {
        navigator.vibrate([200, 100, 200]);
    }
}

// Function to handle sending message
function sendMessage() {
    const text = refs.chatInput.value.trim();
    if (text === '') return;

    const uid = getLocalUid();
    const name = refs.officerName.value || 'User';
    const timestamp = Date.now();

    const newMessage = {
        uid: uid,
        name: name,
        text: text,
        timestamp: timestamp
    };

    CHAT_DB_REF.push(newMessage).then(() => {
        refs.chatInput.value = '';
        refs.chatInput.focus();
    }).catch(err => {
        alert('Gagal mengirim pesan: ' + err.message);
    });
}

refs.chatSend.addEventListener('click', sendMessage);
refs.chatInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
        sendMessage();
    }
});

// Bubble and Panel Control
refs.chatBubble.addEventListener('click', () => {
    state.chatOpen = true;
    refs.chatPanel.classList.remove('hidden');
    state.unreadCount = 0;
    updateUnreadBadge();
    // Scroll to bottom and mark all as delivered
    refs.chatMessages.scrollTop = refs.chatMessages.scrollHeight;
    state.lastDelivered = Date.now();
    saveState();
});

refs.chatClose.addEventListener('click', () => {
    state.chatOpen = false;
    refs.chatPanel.classList.add('hidden');
});


// --- Main Initialization ---
waitForFirebase().then(() => {
    loadState();
    
    // Init Components
    renderAreas();
    renderCheckpointList();
    renderSignature();
    renderProfilePhoto();
    updateModeUI();
    
    // Init Chat
    subscribeToChat();
    updateUnreadBadge();
    
    // Set default values if empty
    if (!refs.officerName.value) refs.officerName.value = 'Petugas Patroli';
    if (!refs.shift.value) refs.shift.value = 'Malam';
    if (!refs.date.value) refs.date.value = new Date().toISOString().slice(0, 10);

    // Save state every 5 seconds as a fallback
    setInterval(saveState, 5000);
    
    console.log('App Loaded. Admin Mode:', state.isAdmin);

}).catch(e => {
    console.error('Initialization Failed:', e);
    alert('Aplikasi gagal dimuat. Cek konfigurasi Firebase di file HTML.');
});


})(); // End of IIFE
</script>
</body>
</html>