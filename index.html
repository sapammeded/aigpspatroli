<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8">
  <title>CYBER PATROL V2 — HYBRID</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">

  <!-- FONT & ICON -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <!-- FIREBASE (CDN) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <style>
    :root{
      --bg:#020617;
      --bg-elev:#020818;
      --card:#020617;
      --panel:#020617;
      --border:#1f2937;
      --accent:#00e6ff;
      --accent-soft:rgba(0,230,255,0.12);
      --accent-strong:rgba(0,230,255,0.35);
      --text:#e5e7eb;
      --muted:#9ca3af;
      --danger:#ef4444;
      --success:#10b981;
      --panic:#ff0055;
      --panic-soft:rgba(255,0,85,0.15);
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
      background:radial-gradient(circle at top,#020617 0,#020617 40%,#000 100%);
      color:var(--text);
      min-height:100vh;
      display:flex;
      flex-direction:column;
    }

    /* HEADER */
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:10px 14px;
      border-bottom:1px solid var(--border);
      background:linear-gradient(90deg,#020617,#020617 30%,#020617 60%,#020617);
      position:relative;
      overflow:hidden;
    }
    .topbar::before{
      content:'';
      position:absolute;
      inset:-40%;
      background:conic-gradient(from 180deg,rgba(0,230,255,0.16),transparent,rgba(0,255,136,0.08),transparent);
      mix-blend-mode:screen;
      opacity:.6;
      animation:spinGlow 18s linear infinite;
      pointer-events:none;
    }
    @keyframes spinGlow{
      to{transform:rotate(360deg);}
    }
    .brand{
      position:relative;
      z-index:1;
      font-weight:800;
      letter-spacing:.08em;
      font-size:13px;
      text-transform:uppercase;
      color:var(--accent);
      display:flex;
      align-items:center;
      gap:8px;
    }
    .brand span.logo-dot{
      width:9px;
      height:9px;
      border-radius:50%;
      background:var(--accent);
      box-shadow:0 0 12px var(--accent);
    }
    .brand small{
      font-weight:500;
      color:var(--muted);
      letter-spacing:.06em;
    }
    .top-right{
      position:relative;
      z-index:1;
      display:flex;
      align-items:center;
      gap:10px;
      font-size:11px;
    }
    .badge-mode{
      padding:4px 8px;
      border-radius:999px;
      border:1px solid var(--accent-strong);
      background:rgba(0,0,0,0.6);
      display:flex;
      align-items:center;
      gap:6px;
      font-weight:600;
    }
    .badge-dot{
      width:8px;height:8px;border-radius:50%;
      background:var(--success);
      box-shadow:0 0 8px rgba(16,185,129,.9);
    }
    .btn-ghost{
      border-radius:999px;
      border:1px solid var(--border);
      background:rgba(15,23,42,0.85);
      padding:6px 10px;
      color:var(--muted);
      font-size:11px;
      display:flex;
      align-items:center;
      gap:6px;
      cursor:pointer;
    }
    .btn-ghost i{font-size:11px;}
    .btn-ghost:hover{
      border-color:var(--accent-strong);
      color:var(--accent);
    }

    /* LAYOUT */
    .shell{
      flex:1;
      display:flex;
      min-height:0;
      padding:10px;
      gap:10px;
    }
    .sidebar{
      width:280px;
      max-width:100%;
      background:radial-gradient(circle at top,#020617,#020617 55%,#020617);
      border-radius:14px;
      border:1px solid var(--border);
      padding:10px;
      display:flex;
      flex-direction:column;
      gap:10px;
      box-shadow:0 0 40px rgba(0,0,0,0.75);
    }
    .main{
      flex:1;
      min-width:0;
      background:radial-gradient(circle at top,#020617,#020617 55%,#020617);
      border-radius:14px;
      border:1px solid var(--border);
      padding:10px;
      display:flex;
      flex-direction:column;
      gap:10px;
      box-shadow:0 0 40px rgba(0,0,0,0.75);
    }

    /* TABS (SIDEBAR) */
    .side-tabs{
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:6px;
    }
    .side-tab{
      border-radius:10px;
      border:1px solid var(--border);
      padding:7px 8px;
      font-size:11px;
      display:flex;
      align-items:center;
      gap:6px;
      cursor:pointer;
      background:rgba(15,23,42,0.9);
      color:var(--muted);
    }
    .side-tab i{font-size:12px;}
    .side-tab.active{
      border-color:var(--accent-strong);
      background:linear-gradient(135deg,rgba(0,230,255,0.16),rgba(15,23,42,0.98));
      color:var(--accent);
      box-shadow:0 0 15px rgba(0,230,255,0.25);
    }

    .panel-block{
      border-radius:12px;
      border:1px solid var(--border);
      padding:9px;
      background:rgba(15,23,42,0.92);
    }
    .panel-title{
      font-size:11px;
      font-weight:600;
      letter-spacing:.08em;
      text-transform:uppercase;
      color:var(--muted);
      display:flex;
      align-items:center;
      gap:6px;
      margin-bottom:6px;
    }
    .panel-title i{font-size:11px;color:var(--accent);}
    .field-label{
      font-size:11px;
      margin-bottom:2px;
      color:var(--muted);
    }
    .field-input, .field-select{
      width:100%;
      border-radius:8px;
      border:1px solid var(--border);
      padding:7px 8px;
      background:#020617;
      color:var(--text);
      font-size:12px;
    }
    .field-input:focus, .field-select:focus{
      outline:none;
      border-color:var(--accent-strong);
      box-shadow:0 0 0 1px var(--accent-soft);
    }
    .muted{
      font-size:11px;
      color:var(--muted);
    }

    .btn-solid{
      border-radius:9px;
      border:none;
      padding:7px 10px;
      font-size:12px;
      font-weight:600;
      display:inline-flex;
      align-items:center;
      gap:6px;
      cursor:pointer;
      background:linear-gradient(135deg,#00e6ff,#00b7ff);
      color:#020617;
      box-shadow:0 8px 22px rgba(0,230,255,0.3);
    }
    .btn-solid.panic{
      background:linear-gradient(135deg,#ff0055,#ff3366);
      color:#fff;
      box-shadow:0 0 22px rgba(255,0,85,0.7);
    }
    .btn-solid.secondary{
      background:linear-gradient(135deg,#6b7280,#4b5563);
      color:#e5e7eb;
      box-shadow:none;
    }
    .btn-row{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-top:6px;
    }

    /* MAIN TABS */
    .main-tabs{
      display:flex;
      gap:6px;
      flex-wrap:wrap;
    }
    .main-tab{
      border-radius:999px;
      padding:6px 12px;
      font-size:11px;
      border:1px solid var(--border);
      background:rgba(15,23,42,0.9);
      color:var(--muted);
      cursor:pointer;
      display:flex;
      align-items:center;
      gap:6px;
    }
    .main-tab i{font-size:11px;}
    .main-tab.active{
      border-color:var(--accent-strong);
      color:var(--accent);
      box-shadow:0 0 15px rgba(0,230,255,0.25);
      background:linear-gradient(135deg,rgba(0,230,255,0.16),rgba(15,23,42,0.98));
    }

    .main-section{
      display:none;
      flex:1;
      min-height:0;
      border-radius:11px;
      border:1px solid var(--border);
      background:rgba(15,23,42,0.95);
      padding:10px;
      overflow:auto;
    }
    .main-section.active{display:flex;flex-direction:column;}

    /* PANIC CARD */
    .panic-card{
      border-radius:12px;
      border:1px solid var(--panic-soft);
      background:radial-gradient(circle at top,var(--panic-soft),rgba(15,23,42,0.96));
      padding:10px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .panic-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:6px;
    }
    .panic-title{
      font-size:11px;
      letter-spacing:.18em;
      text-transform:uppercase;
      color:var(--panic);
      display:flex;
      align-items:center;
      gap:6px;
      font-weight:700;
    }
    .panic-indicator{
      width:9px;height:9px;border-radius:50%;
      background:var(--panic);
      box-shadow:0 0 11px rgba(255,0,85,0.9);
    }
    .panic-status{
      font-size:11px;
      color:var(--muted);
    }
    .panic-status span{
      font-weight:600;
    }
    .panic-blink{
      animation:panicPulse .8s linear infinite;
    }
    @keyframes panicPulse{
      0%,100%{
        box-shadow:0 0 0 0 rgba(255,0,85,0.7);
        transform:translateY(0);
      }
      50%{
        box-shadow:0 0 15px 0 rgba(255,0,85,1);
        transform:translateY(-1px);
      }
    }

    /* AREA LIST */
    .area-list{
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .area-item{
      border-radius:10px;
      border:1px solid var(--border);
      background:rgba(15,23,42,0.92);
      padding:8px;
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .area-top{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
      margin-bottom:4px;
    }
    .area-chip{
      padding:3px 7px;
      border-radius:999px;
      font-size:10px;
      border:1px solid var(--accent-strong);
      color:var(--accent);
      display:inline-flex;
      align-items:center;
      gap:5px;
    }
    .area-name{font-size:13px;font-weight:600;}
    .area-meta{font-size:11px;color:var(--muted);}
    .tag-pill{
      font-size:10px;
      padding:2px 6px;
      border-radius:999px;
      border:1px solid var(--border);
      color:var(--muted);
    }

    /* CHAT SECTION SIMPLE */
    .chat-window{
      flex:1;
      display:flex;
      flex-direction:column;
      border-radius:10px;
      border:1px solid var(--border);
      background:rgba(2,6,23,0.85);
      overflow:hidden;
    }
    .chat-messages{
      flex:1;
      padding:8px;
      overflow:auto;
      font-size:12px;
    }
    .chat-row{
      margin-bottom:6px;
      max-width:80%;
      padding:6px 8px;
      border-radius:8px;
      position:relative;
    }
    .chat-row.me{
      margin-left:auto;
      background:rgba(0,230,255,0.11);
      border:1px solid rgba(0,230,255,0.4);
    }
    .chat-row.other{
      margin-right:auto;
      background:rgba(15,23,42,0.9);
      border:1px solid var(--border);
    }
    .chat-meta{
      font-size:9px;
      color:var(--muted);
      margin-top:2px;
    }
    .chat-input-row{
      display:flex;
      gap:6px;
      padding:6px;
      border-top:1px solid var(--border);
      background:rgba(15,23,42,0.96);
    }
    .chat-input{
      flex:1;
      border-radius:999px;
      border:1px solid var(--border);
      padding:6px 10px;
      background:#020617;
      color:var(--text);
      font-size:12px;
    }

    /* GPS MINI STATUS */
    .gps-pill{
      display:inline-flex;
      align-items:center;
      gap:5px;
      font-size:11px;
      padding:3px 7px;
      border-radius:999px;
      border:1px solid var(--border);
      background:rgba(15,23,42,0.9);
      color:var(--muted);
    }
    .gps-pill span.dot{
      width:7px;height:7px;border-radius:999px;
      background:#6b7280;
    }
    .gps-pill.active span.dot{
      background:#22c55e;
      box-shadow:0 0 8px rgba(34,197,94,0.9);
    }

    /* RESPONSIVE */
    @media(max-width:900px){
      .shell{flex-direction:column;}
      .sidebar{width:100%;}
    }
  </style>
</head>
<body>
  <!-- HEADER -->
  <header class="topbar">
    <div class="brand">
      <span class="logo-dot"></span>
      CYBER PATROL V2
      <small>SECURE HYBRID CLIENT</small>
    </div>
    <div class="top-right">
      <div class="gps-pill" id="gpsStatusPill">
        <span class="dot"></span>
        <span id="gpsStatusText">GPS: Idle</span>
      </div>
      <div class="badge-mode" id="modeBadge">
        <span class="badge-dot"></span>
        <span id="modeText">MODE: USER</span>
      </div>
      <button class="btn-ghost" id="btnToggleMode">
        <i class="fas fa-user-shield"></i>
        <span id="btnToggleModeText">Masuk Admin</span>
      </button>
    </div>
  </header>

  <main class="shell">
    <!-- SIDEBAR -->
    <aside class="sidebar">
      <div class="side-tabs">
        <div class="side-tab active" data-side="info">
          <i class="fas fa-id-card"></i>
          <span>Identitas</span>
        </div>
        <div class="side-tab" data-side="checkpoint">
          <i class="fas fa-qrcode"></i>
          <span>Checkpoint</span>
        </div>
        <div class="side-tab" data-side="settings">
          <i class="fas fa-sliders"></i>
          <span>Settings</span>
        </div>
        <div class="side-tab" data-side="deep">
          <i class="fas fa-bomb"></i>
          <span>Deep Clean</span>
        </div>
      </div>

      <!-- PANEL: IDENTITAS / DASAR -->
      <section class="panel-block" data-side-panel="info">
        <div class="panel-title">
          <i class="fas fa-user-tie"></i> DATA PETUGAS
        </div>
        <label class="field-label">Nama Petugas</label>
        <input id="fieldName" class="field-input" placeholder="Nama lengkap...">

        <label class="field-label" style="margin-top:6px;">Shift</label>
        <select id="fieldShift" class="field-select">
          <option value="">Pilih shift...</option>
          <option value="Pagi">Pagi</option>
          <option value="Siang">Siang</option>
          <option value="Malam">Malam</option>
        </select>

        <label class="field-label" style="margin-top:6px;">Tanggal Patroli</label>
        <input id="fieldDate" class="field-input" placeholder="YYYY-MM-DD">

        <div style="margin-top:6px;">
          <div class="field-label">Lokasi (cover PDF)</div>
          <input id="fieldLokasi" class="field-input" placeholder="Contoh: SEI JKT11">
          <p class="muted" style="margin-top:4px;">
            Kosongkan jika mau pakai GPS otomatis.
          </p>
        </div>

        <hr style="border:none;border-top:1px solid var(--border);margin:8px 0;">

        <div class="panel-title">
          <i class="fas fa-map-marker-alt"></i> GPS & TRACKING
        </div>
        <p class="muted">Status koordinat: <span id="coordsText">-</span></p>
        <div class="btn-row">
          <button class="btn-solid secondary" id="btnGpsStart">
            <i class="fas fa-location-arrow"></i> Mulai GPS
          </button>
          <button class="btn-solid secondary" id="btnGpsStop">
            <i class="fas fa-stop-circle"></i> Stop
          </button>
        </div>
        <p class="muted" style="margin-top:4px;font-size:10px;">
          Versi 2 menggunakan mode hemat baterai + anti GPS palsu.
        </p>

        <hr style="border:none;border-top:1px solid var(--border);margin:8px 0;">

        <div class="panel-title">
          <i class="fas fa-user-shield"></i> ADMIN LOGIN
        </div>
        <input id="adminPass" type="password" class="field-input" placeholder="Password admin...">
        <div class="btn-row">
          <button class="btn-solid secondary" id="btnAdminLogin">
            <i class="fas fa-door-open"></i> Login
          </button>
          <button class="btn-solid secondary" id="btnAdminLogout" style="display:none;">
            <i class="fas fa-sign-out-alt"></i> Logout
          </button>
        </div>
        <p class="muted" style="margin-top:4px;font-size:10px;">
          Pada versi final, password admin akan dicek via Firebase (hash), tidak tersimpan di HTML.
        </p>
      </section>

      <!-- PANEL: CHECKPOINT (PLACEHOLDER) -->
      <section class="panel-block" data-side-panel="checkpoint" style="display:none;">
        <div class="panel-title">
          <i class="fas fa-qrcode"></i> CHECKPOINT / QR
        </div>
        <p class="muted">Di sini nanti: daftar checkpoint, generate QR, scan QR via kamera.</p>
        <p class="muted" style="margin-top:4px;">Sekarang masih kerangka. Fitur lama akan dipindahkan ke sini.</p>
      </section>

      <!-- PANEL: SETTINGS -->
      <section class="panel-block" data-side-panel="settings" style="display:none;">
        <div class="panel-title">
          <i class="fas fa-sliders-h"></i> SETTINGS
        </div>
        <label class="field-label">Mode hemat baterai GPS</label>
        <select id="fieldGpsMode" class="field-select">
          <option value="normal">Normal</option>
          <option value="aggressive">Akurat (lebih boros)</option>
          <option value="battery">Hemat baterai</option>
        </select>
        <p class="muted" style="margin-top:4px;font-size:10px;">
          Ini hanya mengatur interval kirim lokasi. Logika detail ada di modul GPS.
        </p>
      </section>

      <!-- PANEL: DEEP CLEAN -->
      <section class="panel-block" data-side-panel="deep" style="display:none;">
        <div class="panel-title">
          <i class="fas fa-bomb"></i> DEEP CLEAN V2
        </div>
        <p class="muted">
          Fitur ini akan menghapus semua data lokal (cache, foto, signature, setting). Untuk keamanan, versi final akan memakai konfirmasi 2 langkah + verifikasi admin.
        </p>
        <div class="btn-row" style="margin-top:6px;">
          <button class="btn-solid secondary" id="btnDeepClean">
            <i class="fas fa-skull-crossbones"></i> Deep Clean Lokal
          </button>
        </div>
      </section>
    </aside>

    <!-- MAIN -->
    <section class="main">
      <div class="main-tabs">
        <div class="main-tab active" data-main="areas">
          <i class="fas fa-layer-group"></i> Area & Foto
        </div>
        <div class="main-tab" data-main="panic">
          <i class="fas fa-bell"></i> Panic
        </div>
        <div class="main-tab" data-main="gps">
          <i class="fas fa-route"></i> GPS & Jejak
        </div>
        <div class="main-tab" data-main="chat">
          <i class="fas fa-comments"></i> Chat
        </div>
        <div class="main-tab" data-main="signature">
          <i class="fas fa-pen-nib"></i> Tanda Tangan
        </div>
        <div class="main-tab" data-main="export">
          <i class="fas fa-file-pdf"></i> Export PDF
        </div>
        <div class="main-tab" data-main="admin">
          <i class="fas fa-cogs"></i> Admin Tools
        </div>
      </div>

      <!-- MAIN SECTION: AREAS -->
      <section class="main-section active" data-main-panel="areas">
        <div style="display:flex;flex-direction:column;gap:8px;">
          <div style="display:flex;flex-wrap:wrap;gap:6px;align-items:flex-end;">
            <div style="flex:1;min-width:140px;">
              <div class="field-label">Nama Area</div>
              <input id="fieldNewAreaName" class="field-input" placeholder="Contoh: AREA LOBBY UTAMA">
            </div>
            <div style="flex:1;min-width:140px;">
              <div class="field-label">Detail Lokasi</div>
              <input id="fieldNewAreaDetail" class="field-input" placeholder="Contoh: Pintu masuk utama, dekat resepsionis">
            </div>
            <button class="btn-solid" id="btnAddArea">
              <i class="fas fa-plus-circle"></i> Tambah Area
            </button>
          </div>
          <p class="muted" style="font-size:11px;">
            Versi 2 akan menyatukan semua fitur lama (foto per area, deskripsi AI, dll) ke dalam setiap kartu area di bawah ini.
          </p>

          <div class="area-list" id="areaList"></div>
        </div>
      </section>

      <!-- MAIN SECTION: PANIC -->
      <section class="main-section" data-main-panel="panic">
        <div class="panic-card" id="panicCard">
          <div class="panic-header">
            <div class="panic-title">
              <span class="panic-indicator" id="panicIndicator"></span>
              PANIC CHANNEL
            </div>
            <div class="panic-status" id="panicStatusText">
              Status: <span>Normal</span>
            </div>
          </div>

          <p class="muted" style="font-size:11px;">
            Tekan PANIC jika terjadi kondisi darurat. Versi 2 akan mengirim event PANIC dengan metadata (UID, device, GPS, waktu) ke Firebase, dan Command Center akan menerimanya secara realtime.
          </p>

          <div class="btn-row">
            <button class="btn-solid panic" id="btnPanic">
              <i class="fas fa-bell"></i> PANIC
            </button>
            <button class="btn-solid secondary" id="btnPanicStop">
              <i class="fas fa-stop"></i> Stop Panic
            </button>
          </div>

          <p class="muted" style="font-size:10px;margin-top:4px;">
            Blink merah akan tetap <b>unlimited</b> selama status PANIC aktif. Hanya Command Center / petugas yang bisa meng-set kembali ke normal (versi final).
          </p>
        </div>
      </section>

      <!-- MAIN SECTION: GPS -->
      <section class="main-section" data-main-panel="gps">
        <p class="muted">
          Di sini nanti bisa ditampilkan ringkasan jejak GPS, jumlah titik, jarak tempuh, dan status koneksi ke Command Center.
        </p>
        <p class="muted" style="margin-top:6px;font-size:11px;">
          Sekarang: kerangka dulu. Modul GPS V2 sudah disiapkan di script (hemat baterai + anti spoof). Nanti kita hubungkan ke map / command center.
        </p>
      </section>

      <!-- MAIN SECTION: CHAT -->
      <section class="main-section" data-main-panel="chat">
        <div class="chat-window">
          <div class="chat-messages" id="chatMessages"></div>
          <div class="chat-input-row">
            <input id="chatInput" class="chat-input" placeholder="Ketik pesan ke Command Center...">
            <button class="btn-solid secondary" id="chatSend">
              <i class="fas fa-paper-plane"></i>
            </button>
          </div>
        </div>
        <p class="muted" style="margin-top:6px;font-size:10px;">
          Versi final: chat akan menggunakan jalur `/chat/global` atau `/chat/{uid}` dengan rate limit & anti spam.
        </p>
      </section>

      <!-- MAIN SECTION: SIGNATURE -->
      <section class="main-section" data-main-panel="signature">
        <p class="muted">
          Nanti di sini akan ada canvas tanda tangan digital (TTD) dengan tombol hapus & simpan, lalu otomatis dipakai di cover PDF.
        </p>
      </section>

      <!-- MAIN SECTION: EXPORT PDF -->
      <section class="main-section" data-main-panel="export">
        <p class="muted">
          Seksi ini untuk tombol <b>Generate PDF</b> dengan layout V2: cover profesional, foto area, deskripsi, dan watermark PRO / FREE.
        </p>
      </section>

      <!-- MAIN SECTION: ADMIN TOOLS -->
      <section class="main-section" data-main-panel="admin">
        <p class="muted">
          Panel admin: force sync ke Command Center, reset cache, testing panic, simulasi GPS, dll. Hanya terlihat jika mode admin aktif.
        </p>
      </section>
    </section>
  </main>

  <!-- ============================= -->
  <!--  SCRIPT HYBRID VERSION 2     -->
  <!-- ============================= -->
  <script>
    // ========= CONFIG & GLOBAL STATE =========
    const AppConfig = {
      firebase: {
        apiKey: "AIzaSyCnooeRNZRzTPDvOWIAH3pXbkIryZgJuic",
        authDomain: "silitpitik7373.firebaseapp.com",
        databaseURL: "https://silitpitik7373-default-rtdb.firebaseio.com",
        projectId: "silitpitik7373",
        storageBucket: "silitpitik7373.appspot.com",
        messagingSenderId: "314430704796",
        appId: "1:314430704796:web:2147f3a3a74bfa7affb159"
      },
      // Cloudinary & Gemini nanti kita sambung di versi berikut
      client: {
        appVersion: "v2-hybrid-alpha",
        platform: navigator.userAgent || "unknown"
      }
    };

    const AppState = {
      firebaseReady: false,
      uid: null,
      isAdmin: false,
      gpsWatchId: null,
      gpsMode: "normal",
      panicActive: false,
      lastCoords: null,
      areas: [],
      chatLastSentAt: 0
    };

    // ========= UTILS MODULE =========
    const Utils = {
      $(sel){return document.querySelector(sel);},
      $all(sel){return Array.from(document.querySelectorAll(sel));},
      toast(msg){
        console.log("[TOAST]", msg);
        alert(msg); // nanti bisa diganti toast cantik
      },
      now(){return Date.now();},
      randomId(prefix="id"){
        return prefix+"-"+Math.random().toString(36).slice(2,9);
      },
      sanitize(text){
        return String(text || "").replace(/[<>]/g,"").trim();
      },
      formatTime(ts){
        const d = new Date(ts || Date.now());
        return d.toLocaleString("id-ID");
      }
    };
  </script>

  <script>
    // ========= FIREBASE MODULE =========
    const FirebaseModule = (function(){
      let db = null;
      let auth = null;
      let readyCallbacks = [];

      function init(){
        try{
          if(!window.firebase) throw new Error("Firebase CDN belum termuat");
          if(!firebase.apps.length){
            firebase.initializeApp(AppConfig.firebase);
          }
          db = firebase.database();
          auth = firebase.auth();

          auth.signInAnonymously()
            .then(cred=>{
              AppState.uid = cred.user.uid;
              console.log("Anon auth OK:", AppState.uid);
              AppState.firebaseReady = true;
              readyCallbacks.forEach(cb=>cb());
            })
            .catch(err=>{
              console.error("Auth error:", err);
              Utils.toast("Gagal konek ke server (auth). Coba reload.");
            });
        }catch(e){
          console.error("Firebase init error", e);
          Utils.toast("Firebase gagal diinisialisasi.");
        }
      }

      function onReady(cb){
        if(AppState.firebaseReady) cb();
        else readyCallbacks.push(cb);
      }

      function write(path, data){
        if(!db) return;
        return db.ref(path).set(data).catch(e=>{
          console.error("DB write error", path, e);
        });
      }

      function push(path, data){
        if(!db) return;
        return db.ref(path).push(data).catch(e=>{
          console.error("DB push error", path, e);
        });
      }

      function listen(path, cb){
        if(!db) return;
        db.ref(path).on("value", snap=>{
          cb(snap.val());
        });
      }

      return { init, onReady, write, push, listen };
    })();
  </script>

  <script>
    // ========= GPS MODULE =========
    const GpsModule = (function(){
      const gpsPill = Utils.$("#gpsStatusPill");
      const gpsText = Utils.$("#gpsStatusText");
      const coordsText = Utils.$("#coordsText");

      let timer = null;
      let currentInterval = 10000; // default 10 detik

      function updatePill(active){
        gpsPill.classList.toggle("active", !!active);
        gpsText.textContent = active ? "GPS: Aktif" : "GPS: Idle";
      }

      function setCoords(pos){
        const { latitude, longitude, accuracy } = pos.coords;
        AppState.lastCoords = { lat:latitude, lng:longitude, acc:accuracy, ts:Date.now() };
        coordsText.textContent = `${latitude.toFixed(5)}, ${longitude.toFixed(5)} (±${Math.round(accuracy)}m)`;
      }

      function sendToServer(){
        if(!AppState.lastCoords || !AppState.uid) return;
        FirebaseModule.write(`/live/${AppState.uid}`, {
          ...AppState.lastCoords,
          ts: AppState.lastCoords.ts,
          client: AppConfig.client.appVersion,
          platform: AppConfig.client.platform
        });
      }

      function poll(){
        if(!navigator.geolocation){
          Utils.toast("Perangkat tidak mendukung GPS.");
          stop();
          return;
        }
        navigator.geolocation.getCurrentPosition(pos=>{
          setCoords(pos);
          sendToServer();
        },err=>{
          console.warn("GPS err:", err);
        },{ enableHighAccuracy: AppState.gpsMode === "aggressive", timeout:8000, maximumAge:5000 });
      }

      function start(){
        if(timer) return;
        updatePill(true);
        const mode = AppState.gpsMode;
        if(mode === "battery") currentInterval = 25000;
        else if(mode === "aggressive") currentInterval = 5000;
        else currentInterval = 10000;
        poll();
        timer = setInterval(poll, currentInterval);
      }

      function stop(){
        updatePill(false);
        if(timer){
          clearInterval(timer);
          timer = null;
        }
      }

      return { start, stop };
    })();
  </script>

  <script>
    // ========= PANIC MODULE =========
    const PanicModule = (function(){
      const btnPanic = Utils.$("#btnPanic");
      const btnPanicStop = Utils.$("#btnPanicStop");
      const indicator = Utils.$("#panicIndicator");
      const card = Utils.$("#panicCard");
      const statusText = Utils.$("#panicStatusText");

      let localBlink = false;
      let lastSent = 0;

      function render(){
        card.classList.toggle("panic-blink", AppState.panicActive && localBlink);
        indicator.style.background = AppState.panicActive ? "var(--panic)" : "#4b5563";
        indicator.style.boxShadow = AppState.panicActive ? "0 0 12px rgba(255,0,85,0.9)" : "none";
        statusText.innerHTML = AppState.panicActive
          ? 'Status: <span style="color:var(--panic);">PANIC AKTIF</span>'
          : 'Status: <span>Normal</span>';
      }

      async function sendPanic(active){
        if(!AppState.uid || !AppState.firebaseReady) return;
        const now = Date.now();
        if(now - lastSent < 1500) return; // anti spam kecil
        lastSent = now;

        const payload = {
          uid: AppState.uid,
          ts: now,
          active: !!active,
          coords: AppState.lastCoords || null,
          client: AppConfig.client.appVersion,
          platform: AppConfig.client.platform
        };
        // versi final: tulis ke /alerts/{uid}
        await FirebaseModule.write(`/alerts/${AppState.uid}`, payload);
      }

      function activate(){
        AppState.panicActive = true;
        localBlink = true;
        render();
        sendPanic(true);
      }

      function deactivate(){
        AppState.panicActive = false;
        localBlink = false;
        render();
        sendPanic(false);
      }

      function init(){
        render();
        btnPanic.addEventListener("click", activate);
        btnPanicStop.addEventListener("click", deactivate);
      }

      return { init, activate, deactivate };
    })();
  </script>

  <script>
    // ========= AREA MODULE =========
    const AreaModule = (function(){
      const areaList = Utils.$("#areaList");
      const fieldName = Utils.$("#fieldNewAreaName");
      const fieldDetail = Utils.$("#fieldNewAreaDetail");
      const btnAdd = Utils.$("#btnAddArea");

      function render(){
        areaList.innerHTML = "";
        AppState.areas.forEach((area, idx)=>{
          const div = document.createElement("div");
          div.className = "area-item";
          div.innerHTML = `
            <div class="area-top">
              <div>
                <div class="area-name">${area.name}</div>
                <div class="area-meta">${area.detail || "-"}</div>
              </div>
              <span class="area-chip">
                <i class="fas fa-hashtag"></i>${idx+1}
              </span>
            </div>
            <div style="display:flex;gap:6px;flex-wrap:wrap;margin-top:4px;">
              <span class="tag-pill"><i class="fas fa-camera" style="font-size:10px;"></i> Foto (soon)</span>
              <span class="tag-pill"><i class="fas fa-robot" style="font-size:10px;"></i> AI Deskripsi (soon)</span>
              <span class="tag-pill"><i class="fas fa-qrcode" style="font-size:10px;"></i> QR (soon)</span>
            </div>
          `;
          areaList.appendChild(div);
        });
      }

      function addArea(){
        const name = Utils.sanitize(fieldName.value);
        const detail = Utils.sanitize(fieldDetail.value);
        if(!name){
          Utils.toast("Nama area wajib diisi.");
          return;
        }
        AppState.areas.push({ id: Utils.randomId("area"), name, detail });
        fieldName.value = "";
        fieldDetail.value = "";
        render();
      }

      function init(){
        btnAdd.addEventListener("click", addArea);
      }

      return { init, render, addArea };
    })();
  </script>

  <script>
    // ========= CHAT MODULE (SIMPLE DUMMY) =========
    const ChatModule = (function(){
      const box = Utils.$("#chatMessages");
      const input = Utils.$("#chatInput");
      const btnSend = Utils.$("#chatSend");

      function addMessage(text, me=false){
        const row = document.createElement("div");
        row.className = "chat-row " + (me ? "me" : "other");
        row.innerHTML = `
          <div>${text}</div>
          <div class="chat-meta">${me ? "You" : "System"} • ${Utils.formatTime(Date.now())}</div>
        `;
        box.appendChild(row);
        box.scrollTop = box.scrollHeight;
      }

      function send(){
        const raw = Utils.sanitize(input.value);
        if(!raw) return;
        const now = Date.now();
        if(now - AppState.chatLastSentAt < 800){
          Utils.toast("Terlalu cepat, jeda sebentar.");
          return;
        }
        AppState.chatLastSentAt = now;
        addMessage(raw, true);
        input.value = "";
        // versi final: kirim ke Firebase (/chat/global atau /chat/{uid})
      }

      function init(){
        btnSend.addEventListener("click", send);
        input.addEventListener("keydown", e=>{
          if(e.key === "Enter") send();
        });
        addMessage("Channel chat V2 siap. Versi final akan terhubung ke Command Center.", false);
      }

      return { init, addMessage };
    })();
  </script>

  <script>
    // ========= UI TABS MODULE =========
    const UiModule = (function(){
      function initSideTabs(){
        const tabs = Utils.$all(".side-tab");
        tabs.forEach(tab=>{
          tab.addEventListener("click", ()=>{
            const key = tab.getAttribute("data-side");
            tabs.forEach(t=>t.classList.remove("active"));
            tab.classList.add("active");
            Utils.$all("[data-side-panel]").forEach(p=>{
              p.style.display = p.getAttribute("data-side-panel") === key ? "block" : "none";
            });
          });
        });
      }

      function initMainTabs(){
        const tabs = Utils.$all(".main-tab");
        tabs.forEach(tab=>{
          tab.addEventListener("click", ()=>{
            const key = tab.getAttribute("data-main");
            tabs.forEach(t=>t.classList.remove("active"));
            tab.classList.add("active");
            Utils.$all("[data-main-panel]").forEach(p=>{
              p.classList.toggle("active", p.getAttribute("data-main-panel") === key);
            });
          });
        });
      }

      function initModeToggle(){
        const badge = Utils.$("#modeBadge");
        const modeText = Utils.$("#modeText");
        const btn = Utils.$("#btnToggleMode");
        const btnLabel = Utils.$("#btnToggleModeText");

        function render(){
          badge.querySelector(".badge-dot").style.background = AppState.isAdmin ? "#f59e0b" : "#22c55e";
          modeText.textContent = AppState.isAdmin ? "MODE: ADMIN" : "MODE: USER";
          btnLabel.textContent = AppState.isAdmin ? "Keluar Admin" : "Masuk Admin";
        }
        render();

        btn.addEventListener("click", ()=>{
          if(AppState.isAdmin){
            AppState.isAdmin = false;
          }else{
            // actual verif lewat admin login, ini cuma switch visual sementara
            AppState.isAdmin = true;
          }
          render();
        });
      }

      return { initSideTabs, initMainTabs, initModeToggle };
    })();
  </script>

  <script>
    // ========= APP INIT =========
    (function initApp(){
      document.addEventListener("DOMContentLoaded", ()=>{
        // init Firebase
        FirebaseModule.init();

        // UI basic
        UiModule.initSideTabs();
        UiModule.initMainTabs();
        UiModule.initModeToggle();

        // modules
        AreaModule.init();
        PanicModule.init();
        ChatModule.init();

        // GPS buttons
        Utils.$("#btnGpsStart").addEventListener("click", ()=>{
          GpsModule.start();
        });
        Utils.$("#btnGpsStop").addEventListener("click", ()=>{
          GpsModule.stop();
        });

        // GPS mode select
        Utils.$("#fieldGpsMode").addEventListener("change", e=>{
          AppState.gpsMode = e.target.value || "normal";
          // jika sedang aktif, restart dengan interval baru
          GpsModule.stop();
          GpsModule.start();
        });

        // Deep clean lokal (sementara hanya localStorage clear)
        Utils.$("#btnDeepClean").addEventListener("click", ()=>{
          if(confirm("Hapus semua cache lokal? (foto offline, setting, dll)")){
            try{
              localStorage.clear();
            }catch(e){}
            Utils.toast("Cache lokal dibersihkan (VERSI 2). Data di server tidak ikut terhapus.");
          }
        });

        Utils.toast("Kerangka CYBER PATROL V2 HYBRID aktif. Fitur lama akan dipindahkan ke struktur baru ini tahap demi tahap.");
      });
    })();
  </script>
</body>
</html>
