<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Patroli — Final Fixed</title>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

<script>
// ✅ FIREBASE CONFIG & INIT HARUS PALING AWAL
const FIREBASE_CONFIG = {
  apiKey: "AIzaSyAIMDFdAlxBDCgfKL_ufD6plvzKLIaSdpc",
  authDomain: "silitpitik7373.firebaseapp.com",
  projectId: "silitpitik7373",
  databaseURL: "https://silitpitik7373-default-rtdb.firebaseio.com",
  storageBucket: "silitpitik7373.appspot.com",
  messagingSenderId: "314430704796",
  appId: "1:314430704796:web:2147f3a3a74bfa7affb159"
};

// Initialize Firebase immediately
(function() {
  try {
    // Pengecekan dasar: pastikan library sudah dimuat sebelum inisialisasi
    if (!window.firebase || !firebase.initializeApp) {
        throw new Error('Firebase library scripts not loaded. Check CDN links or network.');
    }

    if (!firebase.apps.length) {
      firebase.initializeApp(FIREBASE_CONFIG);
      console.log('🔥 Firebase initialized EARLY');
    }
    
    // Auto sign-in anonymous
    firebase.auth().signInAnonymously().catch(e => {
        // Menghindari pesan peringatan 'auth/already-signed-in' yang tidak perlu
        if (e.code !== 'auth/already-signed-in') {
            console.warn('Auth auto-signin:', e);
        }
    });
    
    // Cloudinary config
    window.CLOUDINARY = { cloudName: "dowaohqkh", uploadPreset: "Patroli" };
    
  } catch (e) {
    // 💥 PERBAIKAN UTAMA: Tampilkan alert yang diminta user jika inisialisasi gagal
    console.error('Firebase early init error:', e);
    alert('❌ APLIKASI GAGAL DIMUAT!\n\nPeriksa konfigurasi Firebase di HTML. (Detail Error: ' + e.message + ')');
  }
})();
</script>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>

<style>
  @media (max-width:480px){ .expert-list{ grid-template-columns: 1fr !important; } #expertCard{ padding:12px; } .expert-item{ font-size:14px } }

:root {
  --bg: #0a0e17;
  --card: #111827;
  --primary: #00d4ff;
  --primary-dark: #0099cc;
  --secondary: #8b5cf6;
  --accent: #00ff88;
  --muted: #6b7280;
  --danger: #ef4444;
  --text: #e5e7eb;
  --text-muted: #9ca3af;
  --border: #1f2937;
  --header-bg: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
  --cyber-glow: 0 0 10px rgba(0, 212, 255, 0.7);
  --cyber-glow-accent: 0 0 15px rgba(0, 255, 136, 0.5);
}

* {
  box-sizing: border-box;
}

body {
  margin: 0;
  font-family: 'Segoe UI', system-ui, Roboto, Arial, sans-serif;
  background: var(--bg);
  color: var(--text);
  line-height: 1.6;
}

header {
  background: var(--header-bg);
  color: var(--text);
  padding: 12px 14px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 8px;
  border-bottom: 1px solid var(--border);
  box-shadow: var(--cyber-glow);
  position: relative;
}

header::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 2px;
  background: linear-gradient(90deg, var(--primary), var(--accent), var(--secondary));
}

header h1 {
  margin: 0;
  font-size: 17px;
  font-weight: 700;
  background: linear-gradient(90deg, var(--primary), var(--accent));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.container {
  max-width: 1200px;
  margin: 12px auto;
  padding: 10px;
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
}

.card {
  background: var(--card);
  border-radius: 12px;
  padding: 16px;
  box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
  border: 1px solid var(--border);
  transition: all 0.3s ease;
}

.card:hover {
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
  transform: translateY(-2px);
}

.sidebar {
  width: 340px;
  min-width: 260px;
}

label {
  display: block;
  margin: 8px 0 6px;
  font-weight: 600;
  color: var(--text);
  font-size: 14px;
}

input[type=text], textarea, input[type=password] {
  width: 100%;
  padding: 10px 12px;
  border-radius: 8px;
  border: 1px solid var(--border);
  background: #ffffff;
  color: #111827;
  font-size: 14px;
  transition: all 0.2s ease;
}

input[type=text]:focus, textarea:focus, input[type=password]:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(0, 212, 255, 0.2);
}

textarea {
  min-height: 80px;
  resize: vertical;
}

.btn {
  background: linear-gradient(135deg, var(--primary), var(--primary-dark));
  color: #0a0e17;
  padding: 10px 16px;
  border-radius: 8px;
  border: 0;
  cursor: pointer;
  font-weight: 700;
  font-size: 14px;
  transition: all 0.2s ease;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
}

.btn.ghost {
  background: transparent;
  color: var(--primary);
  border: 1px solid var(--primary);
}

.btn.ghost:hover {
  background: rgba(0, 212, 255, 0.1);
}

.btn.danger {
  background: linear-gradient(135deg, var(--danger), #dc2626);
  color: white;
}

.muted {
  color: var(--text-muted);
  font-size: 13px;
}

.areas {
  margin-top: 12px;
}

.area {
  border-radius: 10px;
  padding: 16px;
  margin-bottom: 16px;
  border: 1px solid var(--border);
  background: linear-gradient(145deg, #1a2235, #151b2b);
  position: relative;
  overflow: hidden;
}

.area::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 4px;
  height: 100%;
  background: linear-gradient(to bottom, var(--primary), var(--accent));
}

.area-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 8px;
  margin-bottom: 12px;
}

.area-title {
  font-weight: 800;
  font-size: 16px;
  padding: 8px 12px;
  border-radius: 6px;
  color: #fff;
  background: linear-gradient(135deg, var(--primary), var(--secondary));
  box-shadow: var(--cyber-glow);
}

.photo-controls {
  display: flex;
  gap: 8px;
  align-items: center;
  margin-top: 12px;
  flex-wrap: wrap;
}

.photos {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  margin-top: 12px;
}

.photo-item {
  width: 140px;
  height: 100px;
  border-radius: 8px;
  overflow: hidden;
  position: relative;
  background: #1f2937;
  border: 1px solid var(--border);
  transition: all 0.3s ease;
}

.photo-item:hover {
  transform: scale(1.05);
  box-shadow: var(--cyber-glow);
}

.photo-item img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.photo-meta {
  font-size: 11px;
  color: var(--text-muted);
  padding: 6px;
  text-align: left;
}

.icon-btn {
  background: rgba(255, 255, 255, 0.05);
  border-radius: 6px;
  padding: 8px;
  border: 0;
  cursor: pointer;
  color: var(--text);
  transition: all 0.2s ease;
}

.icon-btn:hover {
  background: rgba(255, 255, 255, 0.1);
  transform: scale(1.1);
}

.signature-canvas {
  border: 1px solid var(--border);
  border-radius: 8px;
  touch-action: none;
  background: #ffffff;
  display: block;
}

.sig-preview {
  width: 160px;
  height: 70px;
  border: 1px solid var(--border);
  border-radius: 6px;
  overflow: hidden;
  background: #ffffff;
}

.note {
  font-size: 13px;
  color: var(--text-muted);
  margin-top: 8px;
  line-height: 1.5;
}

.tabs {
  display: flex;
  gap: 8px;
  margin-bottom: 16px;
  flex-wrap: wrap;
}

.tab {
  padding: 10px 14px;
  border-radius: 10px;
  background: rgba(0, 212, 255, 0.1);
  color: var(--primary);
  cursor: pointer;
  font-weight: 700;
  transition: all 0.2s ease;
  border: 1px solid transparent;
}

.tab:hover {
  background: rgba(0, 212, 255, 0.2);
  transform: translateY(-2px);
}

.tab.active {
  background: rgba(0, 212, 255, 0.2);
  border-color: var(--primary);
  box-shadow: var(--cyber-glow);
}

/* ✅ INI YANG DITAMBAHIN BRO */
.hidden {
  display: none !important;
}

.qr-row {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 12px;
  border-radius: 8px;
  border: 1px dashed var(--border);
  margin-bottom: 10px;
  flex-wrap: wrap;
  background: rgba(255, 255, 255, 0.03);
}

.small {
  font-size: 13px;
  color: var(--text-muted);
}

.modal-backdrop {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.7);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}

.modal {
  background: var(--card);
  padding: 20px;
  border-radius: 12px;
  max-width: 420px;
  width: 94%;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
  border: 1px solid var(--border);
}

.video-preview {
  width: 100%;
  height: 220px;
  background: #000;
  border-radius: 8px;
  object-fit: cover;
}

.profile-photo-preview {
  width: 100%;
  max-height: 200px;
  object-fit: contain;
  border-radius: 8px;
  border: 2px dashed var(--border);
  margin-top: 8px;
}

/* ✅ STYLE CHAT BUBBLE & PANEL */
.chat-bubble {
  position: fixed;
  bottom: 20px;
  right: 20px;
  width: 60px;
  height: 60px;
  border-radius: 50%;
  background: linear-gradient(135deg, var(--primary), var(--secondary));
  color: #0a0e17;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  box-shadow: 0 4px 20px rgba(0, 212, 255, 0.5);
  z-index: 10000;
  border: none;
  font-size: 24px;
  transition: all 0.3s ease;
}

.chat-bubble:hover {
  transform: scale(1.1);
  box-shadow: 0 6px 25px rgba(0, 212, 255, 0.7);
}

.chat-bubble.has-new::after {
  content: '';
  position: absolute;
  top: 5px;
  right: 5px;
  width: 12px;
  height: 12px;
  background: var(--danger);
  border-radius: 50%;
  border: 2px solid #0a0e17;
}

.chat-panel {
  position: fixed;
  bottom: 90px;
  right: 20px;
  width: 350px;
  height: 500px;
  background: var(--card);
  border-radius: 12px;
  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
  z-index: 10000;
  display: flex;
  flex-direction: column;
  border: 1px solid var(--border);
  overflow: hidden;
}

.chat-header {
  padding: 12px 16px;
  background: var(--header-bg);
  color: var(--text);
  border-radius: 12px 12px 0 0;
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-bottom: 1px solid var(--border);
}

.chat-header h3 {
  margin: 0;
  font-size: 16px;
  background: linear-gradient(90deg, var(--primary), var(--accent));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.chat-close {
  background: none;
  border: none;
  color: var(--text);
  cursor: pointer;
  font-size: 18px;
  transition: all 0.2s ease;
}

.chat-close:hover {
  color: var(--primary);
  transform: scale(1.2);
}

.chat-messages {
  flex: 1;
  padding: 12px;
  overflow-y: auto;
  background: rgba(0, 0, 0, 0.2);
}

.chat-message {
  margin-bottom: 12px;
  padding: 10px 14px;
  border-radius: 12px;
  max-width: 85%;
  word-wrap: break-word;
  position: relative;
}

.chat-message.own {
  background: linear-gradient(135deg, var(--primary), var(--primary-dark));
  color: #0a0e17;
  margin-left: auto;
  border-bottom-right-radius: 4px;
}

.chat-message.other {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid var(--border);
  margin-right: auto;
  border-bottom-left-radius: 4px;
}

.chat-meta {
  font-size: 10px;
  opacity: 0.7;
  margin-top: 4px;
}

.chat-input-area {
  padding: 12px;
  border-top: 1px solid var(--border);
  display: flex;
  gap: 8px;
  background: var(--card);
  border-radius: 0 0 12px 12px;
}

.chat-input {
  flex: 1;
  padding: 10px 14px;
  border: 1px solid var(--border);
  border-radius: 20px;
  outline: none;
  background: rgba(255, 255, 255, 0.05);
  color: var(--text);
}

.chat-input:focus {
  border-color: var(--primary);
}

.chat-send {
  background: linear-gradient(135deg, var(--primary), var(--primary-dark));
  color: #0a0e17;
  border: none;
  border-radius: 20px;
  padding: 10px 16px;
  cursor: pointer;
  font-weight: 600;
  transition: all 0.2s ease;
}

.chat-send:hover {
  transform: scale(1.05);
}

.unread-badge {
  background: var(--danger);
  color: white;
  border-radius: 10px;
  padding: 2px 6px;
  font-size: 10px;
  position: absolute;
  top: -5px;
  right: -5px;
}

/* ✅ NEW: Camera overlay untuk scan QR */
.camera-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.9);
  z-index: 10001;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
}

.camera-container {
  width: 90%;
  max-width: 500px;
  background: var(--card);
  border-radius: 12px;
  overflow: hidden;
  border: 1px solid var(--border);
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
}

.camera-header {
  padding: 12px;
  background: var(--header-bg);
  color: var(--text);
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-bottom: 1px solid var(--border);
}

.camera-video {
  width: 100%;
  height: 300px;
  background: black;
}

.camera-controls {
  padding: 12px;
  background: var(--card);
  display: flex;
  gap: 8px;
  justify-content: center;
}

.scan-frame {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 200px;
  height: 200px;
  border: 2px solid var(--primary);
  border-radius: 8px;
  pointer-events: none;
  box-shadow: var(--cyber-glow);
}

.scan-line {
  position: absolute;
  width: 100%;
  height: 2px;
  background: var(--primary);
  animation: scan 2s linear infinite;
}

@keyframes scan {
  0% { top: 0; }
  50% { top: 100%; }
  100% { top: 0; }
}

/* Cyber elements */
.cyber-border {
  position: relative;
  border: 1px solid var(--primary);
  border-radius: 8px;
  overflow: hidden;
}

.cyber-border::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 2px;
  background: linear-gradient(90deg, transparent, var(--primary), transparent);
}

.cyber-border::after {
  content: '';
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  height: 2px;
  background: linear-gradient(90deg, transparent, var(--primary), transparent);
}

/* Glitch effect for headers */
.glitch {
  position: relative;
}

.glitch::before,
.glitch::after {
  content: attr(data-text);
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
}

.glitch::before {
  left: 2px;
  text-shadow: -2px 0 #ff00c1;
  clip: rect(44px, 450px, 56px, 0);
  animation: glitch-anim 5s infinite linear alternate-reverse;
}

.glitch::after {
  left: -2px;
  text-shadow: -2px 0 #00fff9;
  clip: rect(44px, 450px, 56px, 0);
  animation: glitch-anim2 5s infinite linear alternate-reverse;
}

@keyframes glitch-anim {
  0% {
    clip: rect(42px, 9999px, 44px, 0);
  }
  5% {
    clip: rect(12px, 9999px, 59px, 0);
  }
  10% {
    clip: rect(48px, 9999px, 29px, 0);
  }
  15% {
    clip: rect(42px, 9999px, 73px, 0);
  }
  20% {
    clip: rect(63px, 9999px, 27px, 0);
  }
  25% {
    clip: rect(34px, 9999px, 55px, 0);
  }
  30% {
    clip: rect(86px, 9999px, 73px, 0);
  }
  35% {
    clip: rect(20px, 9999px, 20px, 0);
  }
  40% {
    clip: rect(26px, 9999px, 60px, 0);
  }
  45% {
    clip: rect(25px, 9999px, 66px, 0);
  }
  50% {
    clip: rect(57px, 9999px, 98px, 0);
  }
  55% {
    clip: rect(5px, 9999px, 46px, 0);
  }
  60% {
    clip: rect(82px, 9999px, 31px, 0);
  }
  65% {
    clip: rect(54px, 9999px, 27px, 0);
  }
  70% {
    clip: rect(28px, 9999px, 99px, 0);
  }
  75% {
    clip: rect(45px, 9999px, 69px, 0);
  }
  80% {
    clip: rect(23px, 9999px, 85px, 0);
  }
  85% {
    clip: rect(54px, 9999px, 84px, 0);
  }
  90% {
    clip: rect(45px, 9999px, 47px, 0);
  }
  95% {
    clip: rect(37px, 9999px, 20px, 0);
  }
  100% {
    clip: rect(4px, 9999px, 91px, 0);
  }
}

@keyframes glitch-anim2 {
  0% {
    clip: rect(65px, 9999px, 100px, 0);
  }
  5% {
    clip: rect(52px, 9999px, 74px, 0);
  }
  10% {
    clip: rect(79px, 9999px, 85px, 0);
  }
  15% {
    clip: rect(75px, 9999px, 5px, 0);
  }
  20% {
    clip: rect(67px, 9999px, 61px, 0);
  }
  25% {
    clip: rect(14px, 9999px, 79px, 0);
  }
  30% {
    clip: rect(1px, 9999px, 66px, 0);
  }
  35% {
    clip: rect(86px, 9999px, 30px, 0);
  }
  40% {
    clip: rect(23px, 9999px, 98px, 0);
  }
  45% {
    clip: rect(85px, 9999px, 72px, 0);
  }
  50% {
    clip: rect(71px, 9999px, 75px, 0);
  }
  55% {
    clip: rect(2px, 9999px, 48px, 0);
  }
  60% {
    clip: rect(30px, 9999px, 16px, 0);
  }
  65% {
    clip: rect(59px, 9999px, 50px, 0);
  }
  70% {
    clip: rect(41px, 9999px, 62px, 0);
  }
  75% {
    clip: rect(2px, 9999px, 82px, 0);
  }
  80% {
    clip: rect(47px, 9999px, 73px, 0);
  }
  85% {
    clip: rect(3px, 9999px, 27px, 0);
  }
  90% {
    clip: rect(26px, 9999px, 55px, 0);
  }
  95% {
    clip: rect(42px, 9999px, 97px, 0);
  }
  100% {
    clip: rect(38px, 9999px, 49px, 0);
  }
}

@media (max-width:900px){ 
  .sidebar{width:100%} 
  .container{padding:8px} 
  .video-preview{height:180px} 
  .chat-panel {
    width: calc(100% - 40px);
    right: 20px;
    left: 20px;
  }
  .camera-container {
    width: 95%;
  }
}
</style>
</head>
<body>
<header>
  <h1 class="glitch" data-text="Patroli — FINAL FIXED">Patroli — FINAL FIXED</h1>
  <div style="display:flex;gap:8px;align-items:center">
    <div id="modeDisplay" style="background:rgba(0, 212, 255, 0.1);padding:6px 10px;border-radius:999px;font-weight:700;border:1px solid rgba(0, 212, 255, 0.3);">Mode: User</div>
    <button id="btnToggleMode" class="btn ghost">Masuk Admin</button>
    <span id="gpsStatus" class="muted">GPS: belum</span>
    <button id="btnStartGPS" class="btn">Mulai GPS</button>
    <button id="btnGeneratePDF" class="btn">Generate PDF</button>
  </div>
</header>

<div class="container">
  <aside class="card sidebar cyber-border">
    <div class="tabs">
      <div class="tab active" id="tabAreas">Area</div>
      <div class="tab" id="tabCheckpoint">Checkpoint (QR)</div>
      <div class="tab" id="tabLokasi">Lokasi</div>
      <div class="tab" id="tabFotoProfil">Foto Profil</div>
      <div class="tab" id="tabDeep">DEEP CLEAN-UP</div>
    </div>

    <div id="areaTab">
      <label>Nama Petugas</label><input id="officerName" type="text" placeholder="Nama petugas...">
      <label>Shift</label><input id="shift" type="text" placeholder="Contoh: Malam">
      <label>Tanggal</label><input id="date" type="text" placeholder="YYYY-MM-DD">
      <div style="margin-top:8px" class="muted">Koordinat Terkini: <span id="coords">—</span></div>
      <hr style="margin:10px 0;border-color:var(--border)">

      <label>Tambah Area Manual</label>
      <input id="newAreaName" type="text" placeholder="Nama area (manual)...">
      <input id="newAreaDetail" type="text" placeholder="Detail lokasi (opsional)..." style="margin-top:8px">
      <div style="margin-top:8px;display:flex;gap:8px">
        <button id="btnAddArea" class="btn">Tambah Area</button>
        <button id="btnScanAreaQR" class="btn ghost">Scan QR (kamera)</button>
      </div>

      <div style="margin-top:12px" class="note">User hanya camera; Admin camera + gallery.</div>

      <div style="margin-top:12px" class="login-box">
        <div style="font-weight:700;margin-bottom:8px">Admin Login</div>
        <input id="adminPass" type="password" placeholder="Password admin...">
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="btnLogin" class="btn">Login</button>
          <button id="btnLogout" class="btn danger" style="display:none">Logout</button>
        </div>
      </div>
    </div>

    <div id="checkpointTab" class="hidden">
      <label>Daftar Checkpoint (Unlimited)</label>
      <div id="qrList"></div>

      <label style="margin-top:8px">Buat Checkpoint Manual (JSON)</label>
      <input id="qrAreaName" type="text" placeholder="Nama Area (contoh: AREA SELATAN)">
      <input id="qrAreaDetail" type="text" placeholder="Detail lokasi (contoh: PINTU LOBBY PERTAMA)" style="margin-top:8px">

      <div style="display:flex;gap:8px;margin-top:8px">
        <button id="btnGenerateQRManual" class="btn">Generate QR (JSON)</button>
        <button id="btnSaveCheckpoint" class="btn ghost">Simpan ke Daftar</button>
      </div>

      <div style="margin-top:10px;display:flex;gap:8px;align-items:center">
        <canvas id="qrCanvasManual" style="border:1px solid var(--border);background:#fff;border-radius:6px"></canvas>
        <div style="display:flex;flex-direction:column;gap:6px">
          <button id="btnDownloadQRManual" class="btn">Download QR</button>
          <button id="btnCopyQRDataManual" class="btn ghost">Copy QR DataURL</button>
          <button id="btnCopyQRContentManual" class="btn ghost">Copy QR Content</button>
        </div>
      </div>

      <div style="margin-top:10px">
        <label>Scanner (kamera langsung)</label>
        <video id="video" class="video-preview" autoplay muted playsinline></video>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="btnStartScan" class="btn ghost">Start Scan Camera</button>
          <button id="btnStopScan" class="btn ghost">Stop Scan</button>
          <input id="fileScanInput" type="file" accept="image/*" style="display:none">
          <button id="btnFileScan" class="btn ghost">Scan dari File/Galeri</button>
        </div>
        <div id="scanResult" class="muted" style="margin-top:8px">Hasil scan: —</div>
      </div>
    </div>

    <div id="lokasiTab" class="hidden">
      <label>Input Lokasi (untuk header cover)</label>
      <input id="manualLokasi" type="text" placeholder="Contoh: SEI JKT11">
      <div class="note">Isi lokasi ini akan tampil di cover PDF (override GPS jika diisi).</div>
    </div>

    <div id="fotoProfilTab" class="hidden">
      <h3>FOTO PROFIL COVER</h3>
      <p>Foto ini akan ditampilkan di halaman cover PDF</p>
      
      <div id="profilePhotoPreview" class="profile-photo-preview" style="display:none"></div>
      
      <div style="display:flex;gap:8px;margin-top:12px;flex-wrap:wrap">
        <button id="btnTakeProfilePhoto" class="btn">Ambil Foto (Kamera)</button>
        <button id="btnUploadProfilePhoto" class="btn ghost" style="display:none">Pilih dari Galeri</button>
      </div>
      
      <div class="note" style="margin-top:8px">
        <strong>Preview:</strong> Foto profil akan ditampilkan di sisi kanan cover PDF
      </div>
      
      <button id="btnRemoveProfilePhoto" class="btn danger" style="margin-top:8px;display:none">Hapus Foto Profil</button>
    </div>

    <div id="deepTab" class="hidden">
      <h3>DEEP CLEAN-UP</h3>
      <p>Hapus <strong>SEMUA DATA</strong> termasuk semua area, foto, logo, tanda tangan, password runtime. Aplikasi akan kembali seperti baru.</p>
      <div style="display:flex;gap:8px;margin-top:12px">
        <button id="btnDeepClean" class="btn danger">Deep Clean (OK)</button>
        <button id="btnDeepCancel" class="btn ghost">Batal</button>
      </div>
    </div>

    <hr style="margin:12px 0;border-color:var(--border)">
    <div class="note">Host via HTTPS (GitHub Pages) dan tes di Chrome Android untuk hasil terbaik.</div>
  </aside>

  <main class="card" style="flex:1 1 820px">
    <div style="display:flex;gap:8px;align-items:center;margin-bottom:12px">
      <div class="tab active" id="tabViewAreas">Daftar Area</div>
      <div class="tab" id="tabSignature">Tanda Tangan</div>
    </div>
    
    <div id="viewAreas">
      <div id="areasContainer" class="areas">
        <div style="text-align:center;color:var(--text-muted);padding:20px;border:1px dashed var(--border);border-radius:12px;">
          Belum ada area ditambahkan. Gunakan tombol 'Tambah Area' atau 'Scan QR' di sidebar.
        </div>
      </div>
    </div>
    
    <div id="viewSignature" class="hidden">
      <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:flex-start">
        <div>
          <label>Tanda Tangan Petugas</label>
          <canvas id="sigCanvas" class="signature-canvas" width="300" height="150"></canvas>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button id="btnClearSig" class="btn ghost">Hapus TTD</button>
            <button id="btnSaveSig" class="btn">Simpan TTD</button>
          </div>
        </div>
        
        <div>
          <label>Preview</label>
          <div id="sigPreview" class="sig-preview" style="border:1px solid var(--border);background:#fff;padding:4px">
            </div>
          <label style="margin-top:12px">Nama untuk Tanda Tangan</label>
          <input id="sigName" type="text" placeholder="Nama penanda tangan...">
          <div class="note">Isi kolom nama ini agar tampil di bawah tanda tangan pada PDF.</div>
        </div>
      </div>
      
    </div>
  </main>
</div>

<div id="modalBackdrop" class="modal-backdrop">
  <div class="modal">
    <h3 id="modalTitle" style="margin-top:0;color:var(--primary)">Pesan</h3>
    <p id="modalMessage">Pesan akan muncul di sini.</p>
    <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:16px">
      <button id="modalOk" class="btn">OK</button>
    </div>
  </div>
</div>

<div id="cameraOverlay" class="camera-overlay hidden">
  <div class="camera-container">
    <div class="camera-header">
      <h3 style="margin:0;color:var(--primary)">SCAN QR CHECKPOINT</h3>
      <button id="cameraClose" class="icon-btn"><i class="fas fa-times"></i></button>
    </div>
    <div style="position:relative;">
      <video id="cameraVideo" class="camera-video" autoplay muted playsinline></video>
      <div id="scanFrame" class="scan-frame">
        <div class="scan-line"></div>
      </div>
    </div>
    <div class="camera-controls">
      <span id="cameraStatus" class="muted">Siap...</span>
    </div>
  </div>
</div>

<button id="chatBubble" class="chat-bubble" title="Buka Chat/Laporan Cepat">
  <i class="fas fa-comment-dots"></i>
</button>

<div id="chatPanel" class="chat-panel hidden">
  <div class="chat-header">
    <h3>Live Chat / Laporan Cepat</h3>
    <button id="chatClose" class="chat-close"><i class="fas fa-times"></i></button>
  </div>
  <div id="chatMessages" class="chat-messages">
    <div style="text-align:center;padding:10px;color:var(--text-muted);font-size:12px;">
      Chat akan dimuat jika Firebase aktif.
    </div>
  </div>
  <div class="chat-input-area">
    <input id="chatInput" type="text" class="chat-input" placeholder="Ketik pesan atau laporan...">
    <button id="chatSend" class="chat-send">Kirim</button>
  </div>
</div>

<script>
/* Global Constants & Configs */
const WORKER_URL = "https://patrol-worker.silitpitik7373.workers.dev/api/expert"; // Ganti dengan URL Worker Anda jika menggunakan fitur Expert
const TIMEOUT_MS = 60000; // 60 seconds timeout for worker

const EXPERT_SENTENCES_DB = {
  kondisi_aman: [
    "Area dalam kondisi aman dan terkendali penuh sesuai standar operasional keamanan",
    "Tidak ditemukan indikasi pelanggaran keamanan atau aktivitas mencurigakan",
    "Situasi normal, semua parameter pengawasan dalam batas toleransi wajar",
    "Lokasi aman untuk akses personel dengan protokol identifikasi yang valid",
    "Kondisi lingkungan mendukung operasional tanpa hambatan keamanan",
    "Peralatan pengawasan berfungsi optimal, tidak ada anomali terdeteksi",
    "Akses kontrol berjalan sesuai prosedur, tidak ada pelanggaran akses",
    "Area steril dari ancaman fisik maupun non-fisik",
    "Patroli rutin menunjukkan konsistensi kondisi aman",
    "Tingkat keamanan sesuai dengan klasifikasi zona hijau (aman)"
  ],
  temuan_bahaya: [
    "Terdeteksi potensi bahaya keselamatan yang memerlukan tindakan korektif segera",
    "Kondisi tidak memenuhi standar K3 minimum, perlu isolasi area terbatas",
    "Ada indikasi pelanggaran prosedur keamanan yang berisiko tinggi",
    "Peralatan safety tidak berfungsi optimal, perlu kalibrasi atau penggantian",
    "Ditemukan kebocoran material berbahaya (B3) yang memerlukan penanganan khusus",
    "Jalur evakuasi terhalang oleh material atau peralatan yang tidak semestinya",
    "Risiko kebakaran tinggi karena penumpukan bahan mudah terbakar",
    "Struktur bangunan menunjukkan retak atau deformasi yang mengancam integritas",
    "Terdapat bahaya listrik terbuka atau sambungan kabel yang tidak standar",
    "Area kerja tidak memiliki penerangan yang memadai, meningkatkan risiko kecelakaan"
  ],
  kerusakan_fisik: [
    "Kerusakan minor pada infrastruktur (retak rambut, cat mengelupas) namun fungsionalitas terjaga",
    "Pintu atau jendela tidak dapat ditutup rapat, mengganggu isolasi atau keamanan",
    "Peralatan mengalami malfungsi ringan, perlu pemeliharaan prediktif (PPM)",
    "Pipa air menunjukkan rembesan atau korosi yang mengindikasikan kebocoran awal",
    "Lantai atau permukaan jalan rusak (berlubang/pecah), berpotensi menyebabkan tersandung",
    "Dinding atau pagar pembatas area mengalami keropos/kerusakan struktural",
    "Penerangan (lampu) padam atau redup, memerlukan penggantian segera",
    "Sistem ventilasi atau AC tidak berfungsi optimal, menyebabkan kondisi udara buruk",
    "Terjadi kerusakan pada sistem kontrol akses (gembok/kunci) yang perlu perbaikan",
    "Penanda atau rambu-rambu keamanan (safety signs) hilang atau rusak"
  ],
  aktivitas_mencurigakan: [
    "Terdapat orang tidak dikenal tanpa ID/APD yang sesuai di area terbatas (restricted area)",
    "Perubahan posisi atau kehilangan peralatan penting (alat komunikasi, CCTV)",
    "Ditemukan jejak akses paksa (congkelan, bekas potong) pada pintu/pagar",
    "Aktivitas atau perilaku personel di luar jam kerja yang tidak memiliki izin resmi",
    "Penumpukan material atau benda asing yang tidak relevan dengan aktivitas normal area",
    "Tercium bau asing (kimia/terbakar) tanpa sumber yang jelas di lokasi patroli",
    "Kendaraan parkir di lokasi terlarang tanpa pengawasan selama durasi yang lama",
    "Adanya upaya mematikan/menghalangi fungsi alat pengawasan (CCTV, sensor gerak)",
    "Komponen IT atau server menunjukkan indikasi tampering atau akses ilegal",
    "Ditemukan dokumen sensitif atau barang berharga tercecer di area publik"
  ]
};

const EXPERT_ROLES_DB = {
  k3: "HSE Officer — Ringkasan: Fokus pada bahaya keselamatan dan kesehatan kerja; tinjau kepatuhan APD.",
  kualitas: "Quality Control Engineer — Ringkasan: Periksa kesesuaian hasil kerja dengan standar kualitas dan spesifikasi.",
  struktural: "Konsultan Struktural — Ringkasan: Fokus pada integritas elemen struktur; catat temuan yang memerlukan penghitungan ulang.",
  kons_me: "Konsultan M&E — Ringkasan: Periksa instalasi mekanikal dan elektrikal, kebocoran, atau koneksi sementara.",
  qs: "Quantity Surveyor — Ringkasan: Catat potensi kerugian material dan estimasi biaya perbaikan awal.",
  tkbt: "TKBT — Ringkasan: Periksa penggunaan alat pelindung dan prosedur kerja pada bangunan tinggi.",
  tkpk: "TKPK — Ringkasan: Evaluasi prosedur kerja di ketinggian dan pengaman khusus.",
  k3_fire_A: "K3 Spesialis Kebakaran A — Ringkasan: Penilaian risiko kebakaran tingkat lanjut dan rekomendasi taktis."
};

// ----- Helpers to find description field & latest photo -----
function findDescriptionField(){
  const ids = ['note','description','desc','details','noteField','notes'];
  for(const id of ids){
    const el = document.getElementById(id);
    if(el && (el.tagName==='TEXTAREA' || el.tagName==='INPUT')) return el;
  }
  // fallback largest textarea
  const tx = Array.from(document.getElementsByTagName('textarea')).sort((a,b)=>b.offsetWidth*b.offsetHeight - a.offsetWidth*a.offsetHeight);
  return tx.length > 0 ? tx[0] : null;
}

function findLatestImageBlob(areaIdx, photoIdx){
  if(areaIdx!==undefined && photoIdx!==undefined){
    const area = state.areas[areaIdx];
    const photo = area.photos[photoIdx];
    if(photo && photo.url) return fetch(photo.url, {mode:'cors'}).then(r=>r.blob());
  }

  // Find latest photo across all areas
  let latestPhoto = null;
  state.areas.forEach(area => {
    area.photos.forEach(photo => {
      if(!latestPhoto || photo.ts > latestPhoto.ts){
        latestPhoto = photo;
      }
    });
  });

  if(latestPhoto && latestPhoto.url){
    return fetch(latestPhoto.url, {mode:'cors'}).then(r=>r.blob());
  }

  // Fallback to profile photo
  if(state.profilePhoto && state.profilePhoto.url){
    return fetch(state.profilePhoto.url, {mode:'cors'}).then(r=>r.blob());
  }
  
  return Promise.resolve(null);
}

// Global state, refs, and utility functions (shortened for brevity but assumed to be complete from the original file)
/* All Issues Resolved */ 
(function(){
  // ✅ FIREBASE READY CHECK
  function waitForFirebase() {
    return new Promise((resolve) => {
      const check = () => {
        if (window.firebase && firebase.database) {
          resolve();
        } else {
          setTimeout(check, 100);
        }
      };
      check();
    });
  }

  const $ = s => document.querySelector(s);
  const uid = (p='id')=> p+'-'+Math.random().toString(36).slice(2,9);
  const revoke = url => { try{ if(url) URL.revokeObjectURL(url);}catch(e){} };

  const state = {
    isAdmin:false,
    adminPassword: window.__patrol_admin_password ?? 'raja7373',
    areas:[],
    checkpoints:[],
    gpsPath:[],
    signature:null,
    profilePhoto: null,
    // ✅ NEW: Chat state
    chatOpen: false,
    unreadCount: 0,
    lastDelivered: 0,
    // ✅ NEW: GPS optimization
    maxGpsPoints: 100
  };

  const refs = {
    modeDisplay: $('#modeDisplay'),
    btnToggleMode: $('#btnToggleMode'),
    btnStartGPS: $('#btnStartGPS'),
    gpsStatus: $('#gpsStatus'),
    coords: $('#coords'),
    btnAddArea: $('#btnAddArea'),
    newAreaName: $('#newAreaName'),
    newAreaDetail: $('#newAreaDetail'),
    areasContainer: $('#areasContainer'),
    tabAreas: $('#tabAreas'),
    tabCheckpoint: $('#tabCheckpoint'),
    tabLokasi: $('#tabLokasi'),
    tabFotoProfil: $('#tabFotoProfil'),
    tabDeep: $('#tabDeep'),
    areaTab: $('#areaTab'),
    checkpointTab: $('#checkpointTab'),
    lokasiTab: $('#lokasiTab'),
    fotoProfilTab: $('#fotoProfilTab'),
    deepTab: $('#deepTab'),
    btnScanAreaQR: $('#btnScanAreaQR'),
    btnGenerateQRManual: $('#btnGenerateQRManual'),
    qrCanvasManual: $('#qrCanvasManual'),
    btnDownloadQRManual: $('#btnDownloadQRManual'),
    btnCopyQRDataManual: $('#btnCopyQRDataManual'),
    btnCopyQRContentManual: $('#btnCopyQRContentManual'),
    btnSaveCheckpoint: $('#btnSaveCheckpoint'),
    qrAreaName: $('#qrAreaName'),
    qrAreaDetail: $('#qrAreaDetail'),
    btnLogin: $('#btnLogin'),
    btnLogout: $('#btnLogout'),
    adminPass: $('#adminPass'),
    btnGeneratePDF: $('#btnGeneratePDF'),
    tabViewAreas: $('#tabViewAreas'),
    tabSignature: $('#tabSignature'),
    viewAreas: $('#viewAreas'),
    viewSignature: $('#viewSignature'),
    sigCanvas: $('#sigCanvas'),
    btnClearSig: $('#btnClearSig'),
    btnSaveSig: $('#btnSaveSig'),
    sigPreview: $('#sigPreview'),
    sigName: $('#sigName'),
    btnDeepClean: $('#btnDeepClean'),
    btnDeepCancel: $('#btnDeepCancel'),
    modalBackdrop: $('#modalBackdrop'),
    modalOk: $('#modalOk'),
    modalTitle: $('#modalTitle'),
    modalMessage: $('#modalMessage'),
    video: $('#video'),
    btnStartScan: $('#btnStartScan'),
    btnStopScan: $('#btnStopScan'),
    fileScanInput: $('#fileScanInput'),
    btnFileScan: $('#btnFileScan'),
    scanResult: $('#scanResult'),
    manualLokasi: $('#manualLokasi'),
    profilePhotoPreview: $('#profilePhotoPreview'),
    btnTakeProfilePhoto: $('#btnTakeProfilePhoto'),
    btnUploadProfilePhoto: $('#btnUploadProfilePhoto'),
    btnRemoveProfilePhoto: $('#btnRemoveProfilePhoto'),
    // NEW: Chat elements
    chatBubble: $('#chatBubble'),
    chatPanel: $('#chatPanel'),
    chatClose: $('#chatClose'),
    chatMessages: $('#chatMessages'),
    chatInput: $('#chatInput'),
    chatSend: $('#chatSend'),
    // NEW: Camera scan overlay
    cameraOverlay: $('#cameraOverlay'),
    cameraVideo: $('#cameraVideo'),
    cameraClose: $('#cameraClose'),
    cameraStatus: $('#cameraStatus'),
  };

  function showAlert(title, message, okCallback = null) {
    refs.modalTitle.textContent = title;
    refs.modalMessage.textContent = message;
    refs.modalBackdrop.style.display = 'flex';
    refs.modalOk.onclick = () => {
      refs.modalBackdrop.style.display = 'none';
      if (okCallback) okCallback();
    };
  }

  function getLocalUid() {
    let uid = localStorage.getItem('patrol_uid');
    if (!uid) {
      uid = 'user_' + Math.random().toString(36).slice(2, 9);
      localStorage.setItem('patrol_uid', uid);
    }
    return uid;
  }

  function saveState() {
    try {
      localStorage.setItem('patrol_state', JSON.stringify({
        areas: state.areas,
        checkpoints: state.checkpoints,
        gpsPath: state.gpsPath.slice(-state.maxGpsPoints), // Only save last X points
        signature: state.signature,
        profilePhoto: state.profilePhoto
      }));
      localStorage.setItem('patrol_admin_password', state.adminPassword);
    } catch (e) {
      console.error('Failed to save state:', e);
    }
  }

  function loadState() {
    try {
      const stored = localStorage.getItem('patrol_state');
      if (stored) {
        const loaded = JSON.parse(stored);
        Object.assign(state, loaded);
        // Ensure gpsPath is an array even if empty from load
        state.gpsPath = Array.isArray(state.gpsPath) ? state.gpsPath.slice(-state.maxGpsPoints) : [];
      }
      const savedPass = localStorage.getItem('patrol_admin_password');
      if(savedPass) state.adminPassword = savedPass;
    } catch (e) {
      console.error('Failed to load state:', e);
    }
  }

  // Load immediately
  loadState();

  // ----- UI RENDERERS -----

  function updateModeUI(){
    refs.modeDisplay.textContent = state.isAdmin ? 'Mode: Admin' : 'Mode: User';
    refs.btnToggleMode.textContent = state.isAdmin ? 'Logout Admin' : 'Masuk Admin';
    refs.btnLogout.style.display = state.isAdmin ? 'inline-block' : 'none';
    refs.btnLogin.style.display = state.isAdmin ? 'none' : 'inline-block';
    $('.login-box').style.display = state.isAdmin ? 'none' : 'block';
    
    // Admin only features
    refs.btnUploadProfilePhoto.style.display = state.isAdmin ? 'inline-block' : 'none';
    refs.tabCheckpoint.style.display = state.isAdmin ? 'inline-block' : 'none';
    refs.tabDeep.style.display = state.isAdmin ? 'inline-block' : 'none';
    
    // Hide tabs if not admin
    if (!state.isAdmin) {
      if (refs.checkpointTab.classList.contains('active')) {
        showTab('area');
      }
      if (refs.deepTab.classList.contains('active')) {
        showTab('area');
      }
    }
    
    // Toggle QR file scan button for admin
    refs.btnFileScan.style.display = state.isAdmin ? 'inline-block' : 'none';

    renderAreas();
    renderCheckpointList();
    renderProfilePhoto();
  }

  function showTab(name) {
    // Hide all tab contents
    [refs.areaTab, refs.checkpointTab, refs.lokasiTab, refs.fotoProfilTab, refs.deepTab].forEach(el => el.classList.add('hidden'));
    // Deactivate all tabs
    [refs.tabAreas, refs.tabCheckpoint, refs.tabLokasi, refs.tabFotoProfil, refs.tabDeep].forEach(el => el.classList.remove('active'));

    let targetTab, targetContent;
    switch (name) {
      case 'area':
        targetTab = refs.tabAreas;
        targetContent = refs.areaTab;
        break;
      case 'checkpoint':
        targetTab = refs.tabCheckpoint;
        targetContent = refs.checkpointTab;
        break;
      case 'lokasi':
        targetTab = refs.tabLokasi;
        targetContent = refs.lokasiTab;
        break;
      case 'fotoprofil':
        targetTab = refs.tabFotoProfil;
        targetContent = refs.fotoProfilTab;
        break;
      case 'deep':
        targetTab = refs.tabDeep;
        targetContent = refs.deepTab;
        break;
    }

    if (targetTab && targetContent) {
      targetTab.classList.add('active');
      targetContent.classList.remove('hidden');
    }
  }

  function showView(name){
    [refs.viewAreas, refs.viewSignature].forEach(el => el.classList.add('hidden'));
    [refs.tabViewAreas, refs.tabSignature].forEach(el => el.classList.remove('active'));

    if(name === 'areas'){
      refs.viewAreas.classList.remove('hidden');
      refs.tabViewAreas.classList.add('active');
      renderAreas();
    } else if(name === 'signature'){
      refs.viewSignature.classList.remove('hidden');
      refs.tabSignature.classList.add('active');
    }
  }
  
  function renderAreas(){
    refs.areasContainer.innerHTML = '';
    saveState();
    
    if(state.areas.length === 0) {
      refs.areasContainer.innerHTML = `<div style="text-align:center;color:var(--text-muted);padding:20px;border:1px dashed var(--border);border-radius:12px;">
        Belum ada area ditambahkan. Gunakan tombol 'Tambah Area' atau 'Scan QR' di sidebar.
      </div>`;
      return;
    }
    
    state.areas.forEach((area, areaIdx) => {
      const wrapper = document.createElement('div');
      wrapper.className = 'area';
      
      const header = document.createElement('div');
      header.className = 'area-header';
      
      const title = document.createElement('div');
      title.className = 'area-title';
      title.textContent = area.name;
      
      const actions = document.createElement('div');
      actions.style.display = 'flex';
      actions.style.gap = '8px';
      
      const detail = document.createElement('span');
      detail.className = 'muted';
      detail.style.fontSize = '12px';
      detail.textContent = area.detail ? `(${area.detail})` : '';

      const location = document.createElement('div');
      location.className = 'muted';
      location.innerHTML = `<i class="fas fa-map-marker-alt"></i> ${area.lat ? area.lat.toFixed(6) + ', ' + area.lon.toFixed(6) : 'Koordinat tidak tersedia'}`;
      
      const ts = document.createElement('div');
      ts.className = 'muted';
      ts.style.fontSize = '12px';
      ts.textContent = area.ts ? new Date(area.ts).toLocaleString() : 'Waktu tidak tersedia';
      
      const delBtn = document.createElement('button');
      delBtn.className = 'icon-btn danger';
      delBtn.innerHTML = '<i class="fas fa-trash"></i>';
      delBtn.onclick = () => {
        if (confirm(`Hapus Area: ${area.name}?`)) {
          state.areas.splice(areaIdx, 1);
          renderAreas();
        }
      };
      
      header.appendChild(title);
      header.appendChild(detail);
      header.appendChild(actions);
      
      actions.appendChild(ts);
      actions.appendChild(location);
      actions.appendChild(delBtn);

      const ta = document.createElement('textarea');
      ta.placeholder='Deskripsi area...';
      ta.value = area.description || '';
      ta.oninput = ()=> {
        area.description = ta.value;
        saveState();
      };
      
      const photoControls = document.createElement('div');
      photoControls.className = 'photo-controls';
      
      const cameraInput = document.createElement('input');
      cameraInput.type = 'file';
      cameraInput.accept = 'image/*,video/*';
      cameraInput.capture = 'environment';
      cameraInput.style.display = 'none';
      
      const galleryInput = document.createElement('input');
      galleryInput.type = 'file';
      galleryInput.accept = 'image/*,video/*';
      galleryInput.multiple = true;
      galleryInput.style.display = 'none';
      
      const btnCamera = document.createElement('button');
      btnCamera.className = 'btn';
      btnCamera.innerHTML = '<i class="fas fa-camera"></i> Ambil Foto';
      btnCamera.onclick = () => cameraInput.click();
      
      const btnGallery = document.createElement('button');
      btnGallery.className = 'btn ghost';
      btnGallery.innerHTML = '<i class="fas fa-images"></i> Galeri';
      btnGallery.style.display = state.isAdmin ? 'inline-block' : 'none'; // Admin only
      btnGallery.onclick = () => galleryInput.click();
      
      const photoCounter = document.createElement('span');
      photoCounter.className = 'muted';
      photoCounter.textContent = `(${area.photos.length} foto/video)`;
      
      photoControls.appendChild(btnCamera);
      photoControls.appendChild(btnGallery);
      photoControls.appendChild(photoCounter);

      const photosWrap = document.createElement('div');
      photosWrap.className = 'photos';
      
      area.photos.forEach((p, photoIdx) => {
        const col = document.createElement('div');
        col.style.display='flex';
        col.style.flexDirection='column';
        col.style.gap='4px';

        const photoItem = document.createElement('div');
        photoItem.className = 'photo-item';
        
        let mediaEl;
        if(p.type === 'video'){
          mediaEl = document.createElement('video');
          mediaEl.controls = true;
          mediaEl.src = p.url;
        } else {
          mediaEl = document.createElement('img');
          mediaEl.src = p.url;
          mediaEl.alt = 'Area Photo';
        }

        const actionWrap = document.createElement('div');
        actionWrap.style.cssText = 'position:absolute;top:5px;right:5px;display:flex;gap:4px;z-index:10;';

        const del = document.createElement('button');
        del.className='icon-btn danger';
        del.innerHTML='<i class="fas fa-times"></i>';
        del.style.padding='4px';
        del.onclick=()=>{
          if(confirm('Hapus media ini?')){
            revoke(p.url);
            area.photos.splice(photoIdx, 1);
            renderAreas();
          }
        };

        const edit = document.createElement('button');
        edit.className='icon-btn';
        edit.innerHTML='<i class="fas fa-pencil-alt"></i>';
        edit.style.padding='4px';
        edit.onclick=()=>{
          const newDesc = prompt('Masukkan deskripsi media:', p.desc || '');
          if(newDesc !== null){
            p.desc = newDesc.trim();
            renderAreas();
          }
        };
        
        const ai = document.createElement('button');
        ai.className = 'icon-btn';
        ai.innerHTML = '<i class="fas fa-brain"></i>';
        ai.style.padding='4px';
        ai.style.display = state.isAdmin ? 'inline-block' : 'none';
        ai.title = 'Expert Module';
        ai.onclick = () => { if(state.isAdmin) showExpertModal(areaIdx, photoIdx) };

        photoItem.appendChild(mediaEl);
        
        actionWrap.appendChild(del);
        actionWrap.appendChild(edit);
        actionWrap.appendChild(ai);
        photoItem.appendChild(actionWrap);

        const meta = document.createElement('div');
        meta.className='photo-meta';
        meta.innerHTML = `<div style="font-weight:700">${p.desc || '(klik pensil untuk deskripsi)'}</div>
                          <div style="font-size:11px;color:var(--text-muted)">
                            ${p.lat? p.lat.toFixed(6): '-'}, ${p.lon? p.lon.toFixed(6): '-'}<br>
                            ${p.ts? new Date(p.ts).toLocaleString(): ''}
                          </div>`;
        
        col.appendChild(photoItem);
        col.appendChild(meta);
        photosWrap.appendChild(col);
      });

      wrapper.appendChild(header);
      wrapper.appendChild(ta);
      wrapper.appendChild(photoControls);
      wrapper.appendChild(photosWrap);
      refs.areasContainer.appendChild(wrapper);
      
      // Photo/Video Upload Logic
      async function handleFileUpload(files) {
        if (files.length === 0) return;
        
        // Get latest GPS coordinate
        const lastGps = state.gpsPath.length ? state.gpsPath.slice(-1)[0] : null;
        
        for (const file of files) {
          const type = file.type.startsWith('video') ? 'video' : 'photo';
          
          if (!window.uploadToCloudinary) {
             showAlert('Error Upload', 'Fungsi upload (Cloudinary) tidak tersedia. Pastikan file script sudah lengkap dan koneksi internet stabil.');
             return;
          }

          try {
            // Show progress (optional: can be improved with a progress bar)
            btnCamera.disabled = true;
            btnCamera.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Uploading (${file.name})...`;
            
            // Upload with retry
            var uploadedUrl = await window.uploadToCloudinary(file);
            console.log('Upload successful:', uploadedUrl);

            var ts = lastGps ? lastGps.timestamp : (new Date()).getTime();
            var lat = lastGps ? lastGps.lat : null;
            var lon = lastGps ? lastGps.lon : null;

            // add to local area.photos for immediate UI feedback
            var mediaId = uid('media');
            var mediaObj = { 
              id: mediaId, 
              url: uploadedUrl, 
              type: type,
              desc: '', 
              lat: lat, 
              lon: lon, 
              ts: ts,
              name: file.name
            };
            area.photos.push(mediaObj);
            
            renderAreas(); // Re-render to show new media
            
          } catch (e) {
            console.error('Upload failed:', e);
            showAlert('Gagal Upload', `Gagal mengupload media ${file.name}. Error: ` + (e.message || e));
          } finally {
             btnCamera.disabled = false;
             btnCamera.innerHTML = '<i class="fas fa-camera"></i> Ambil Foto';
          }
        }
      }

      cameraInput.onchange = (e) => handleFileUpload(Array.from(e.target.files));
      galleryInput.onchange = (e) => handleFileUpload(Array.from(e.target.files));
    });
  }

  function renderCheckpointList() {
    refs.qrList.innerHTML = '';
    saveState();

    state.checkpoints.forEach(cp => {
      const row = document.createElement('div');
      row.className = 'qr-row';
      row.innerHTML = `
        <i class="fas fa-map-pin" style="color:var(--accent);font-size:16px;"></i>
        <div style="flex:1">
          <div style="font-weight:700">${cp.area}</div>
          <div class="small">${cp.detail}</div>
          <div class="small" style="font-style:italic;">ID: ${cp.id}</div>
        </div>
      `;

      const jsonContent = buildQRJson(cp.area, cp.detail);
      
      const gen = document.createElement('button');
      gen.className = 'btn ghost';
      gen.textContent = 'Generate QR';
      gen.onclick = () => {
        qrManual.set({ value: jsonContent, size: 300 });
        refs.qrAreaName.value = cp.area;
        refs.qrAreaDetail.value = cp.detail;
        alert('QR code generated on canvas!');
      };

      const copy = document.createElement('button');
      copy.className = 'btn ghost';
      copy.textContent = 'Copy JSON';
      copy.onclick = () => {
        navigator.clipboard.writeText(jsonContent).then(() => {
          alert('JSON content copied!');
        }).catch(err => {
          console.error('Copy failed', err);
          alert('Gagal copy: ' + err.message);
        });
      };
      
      const del = document.createElement('button');
      del.className = 'btn danger';
      del.textContent = 'Hapus';
      del.onclick=()=>{
        if(confirm('Hapus checkpoint?')){
          state.checkpoints = state.checkpoints.filter(x=>x.id!==cp.id);
          renderCheckpointList();
        }
      };

      row.appendChild(gen);
      row.appendChild(copy);
      row.appendChild(del);
      refs.qrList.appendChild(row);
    });
  }

  function renderProfilePhoto(){
    saveState();
    if(state.profilePhoto && state.profilePhoto.url){
      refs.profilePhotoPreview.style.backgroundImage = `url(${state.profilePhoto.url})`;
      refs.profilePhotoPreview.style.backgroundSize = 'contain';
      refs.profilePhotoPreview.style.backgroundRepeat = 'no-repeat';
      refs.profilePhotoPreview.style.backgroundPosition = 'center';
      refs.profilePhotoPreview.style.height = '200px';
      refs.profilePhotoPreview.style.display = 'block';
      refs.btnRemoveProfilePhoto.style.display = 'inline-block';
      // Enable Upload button in Admin mode
      refs.btnUploadProfilePhoto.style.display = state.isAdmin ? 'inline-block' : 'none';
    } else {
      refs.profilePhotoPreview.style.display = 'none';
      refs.btnRemoveProfilePhoto.style.display = 'none';
      // Enable Upload button in Admin mode
      refs.btnUploadProfilePhoto.style.display = state.isAdmin ? 'inline-block' : 'none';
    }
  }

  // ----- EVENT HANDLERS -----

  // Tab switching
  refs.tabAreas.addEventListener('click', () => showTab('area'));
  refs.tabCheckpoint.addEventListener('click', () => { if(state.isAdmin) showTab('checkpoint') });
  refs.tabLokasi.addEventListener('click', () => showTab('lokasi'));
  refs.tabFotoProfil.addEventListener('click', () => showTab('fotoprofil'));
  refs.tabDeep.addEventListener('click', () => { if(state.isAdmin) showTab('deep') });
  
  // View switching (main area)
  refs.tabViewAreas.addEventListener('click', () => showView('areas'));
  refs.tabSignature.addEventListener('click', () => showView('signature'));

  // Admin Login/Logout
  refs.btnToggleMode.addEventListener('click', ()=>{
    if(!state.isAdmin){
      const p = prompt('Password Admin:');
      if(p===null) return;
      if(p === state.adminPassword){
        state.isAdmin = true;
        updateModeUI();
        alert('Admin login berhasil');
      } else alert('Password salah');
    } else {
      state.isAdmin = false;
      refs.adminPass.value = '';
      updateModeUI();
      alert('Mode User aktif');
    }
  });
  
  refs.btnLogin.addEventListener('click', ()=>{
    const p = refs.adminPass.value||'';
    if(p === state.adminPassword){
      state.isAdmin = true;
      refs.adminPass.value='';
      updateModeUI();
      alert('Admin login berhasil');
    } else alert('Password salah');
  });

  refs.btnLogout.addEventListener('click', ()=>{
    state.isAdmin = false;
    refs.adminPass.value = '';
    updateModeUI();
    alert('Logout berhasil');
  });

  // GPS Tracking
  let watchId = null;
  refs.btnStartGPS.addEventListener('click', ()=>{
    if(!navigator.geolocation){
      alert('Geolocation tidak didukung browser ini');
      return;
    }

    if (watchId) {
        navigator.geolocation.clearWatch(watchId);
        watchId = null;
        refs.btnStartGPS.textContent = 'Mulai GPS';
        refs.gpsStatus.textContent = 'GPS: berhenti';
        alert('GPS Tracking dihentikan.');
        saveState();
        return;
    }
    
    refs.btnStartGPS.textContent = 'Stop GPS';
    refs.gpsStatus.textContent='GPS: aktif';

    watchId = navigator.geolocation.watchPosition(
      pos => {
        const lat = pos.coords.latitude, lon = pos.coords.longitude, ts = pos.timestamp;
        refs.coords.textContent = lat.toFixed(6) + ', ' + lon.toFixed(6) + ' @ ' + new Date(ts).toLocaleTimeString();
        // ✅ OPTIMIZED: Batasi jumlah titik GPS
        state.gpsPath.push({lat, lon, timestamp: ts});
        if (state.gpsPath.length > state.maxGpsPoints) {
            state.gpsPath = state.gpsPath.slice(-state.maxGpsPoints);
        }
        saveState();
      },
      err => {
        console.warn(err);
        refs.gpsStatus.textContent='GPS: error - ' + (err.message || 'unknown error');
        if (watchId) navigator.geolocation.clearWatch(watchId);
        watchId = null;
        refs.btnStartGPS.textContent = 'Mulai GPS';
      },
      {
        enableHighAccuracy: true,
        maximumAge: 10000,
        timeout: 15000
      }
    );
  });
  
  // ✅ AUTO START GPS ON PAGE LOAD
  window.addEventListener('load', function() {
    setTimeout(function() {
        if (refs.btnStartGPS && !watchId) {
            refs.btnStartGPS.click();
        }
    }, 1000);
  });

  // Add Area
  refs.btnAddArea.addEventListener('click', ()=>{
    const name = refs.newAreaName.value.trim();
    if(!name){
      alert('Nama area tidak boleh kosong');
      return;
    }
    const detail = refs.newAreaDetail.value.trim();
    const lastGps = state.gpsPath.length ? state.gpsPath.slice(-1)[0] : {};

    state.areas.unshift({
      id: uid('area'),
      name: name,
      detail: detail,
      lat: lastGps.lat || null,
      lon: lastGps.lon || null,
      ts: lastGps.timestamp || (new Date()).getTime(),
      description: '',
      photos: []
    });
    
    refs.newAreaName.value = '';
    refs.newAreaDetail.value = '';
    renderAreas();
    alert('Area baru ditambahkan!');
  });
  
  // QR Generation
  const qrManual = new QRious({
    element: refs.qrCanvasManual,
    size: 220,
    value: ''
  });

  function buildQRJson(area, detail){
    const a=(area||'').trim();
    const d=(detail||'').trim();
    return JSON.stringify({area:a,detail:d});
  }

  refs.btnGenerateQRManual.addEventListener('click', ()=>{
    if(!state.isAdmin) return alert('Hanya Admin yang bisa Generate QR Manual');
    const content = buildQRJson(refs.qrAreaName.value, refs.qrAreaDetail.value);
    if(!refs.qrAreaName.value.trim() && !refs.qrAreaDetail.value.trim()){
      alert('Isi area atau detail');
      return;
    }
    qrManual.set({ value: content, size: 300 });
    try{ navigator.clipboard.writeText(content); }catch(e){}
    alert('QR JSON dibuat & disalin (opsional)');
  });

  refs.btnDownloadQRManual.addEventListener('click', ()=>{
    if(!state.isAdmin) return;
    try{
      const dataUrl = qrManual.toDataURL('image/png');
      const a = document.createElement('a');
      a.href = dataUrl;
      const area = refs.qrAreaName.value.trim() || 'UNTITLED';
      a.download = `QR-Checkpoint-${area.replace(/\s/g, '_')}-${uid('qr')}.png`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    } catch(e) {
      alert('Gagal download QR. Pastikan QR sudah digenerate.');
    }
  });

  refs.btnCopyQRDataManual.addEventListener('click', ()=>{
    if(!state.isAdmin) return;
    try{
      const dataUrl = qrManual.toDataURL('image/png');
      navigator.clipboard.writeText(dataUrl).then(() => {
        alert('QR DataURL disalin ke clipboard!');
      }).catch(err => {
        alert('Gagal menyalin DataURL: ' + err.message);
      });
    } catch(e) {
      alert('Gagal copy. Pastikan QR sudah digenerate.');
    }
  });
  
  refs.btnCopyQRContentManual.addEventListener('click', ()=>{
    if(!state.isAdmin) return;
    const content = buildQRJson(refs.qrAreaName.value, refs.qrAreaDetail.value);
    if(!content || content === JSON.stringify({area:"",detail:""})){
        alert('Isi area atau detail untuk disalin');
        return;
    }
    navigator.clipboard.writeText(content).then(() => {
      alert('QR JSON content disalin!');
    }).catch(err => {
      alert('Gagal menyalin: ' + err.message);
    });
  });

  refs.btnSaveCheckpoint.addEventListener('click', ()=>{
    if(!state.isAdmin) return alert('Hanya Admin yang bisa menyimpan Checkpoint');
    const area = refs.qrAreaName.value.trim();
    const detail = refs.qrAreaDetail.value.trim();
    if(!area){
      alert('Nama area checkpoint tidak boleh kosong');
      return;
    }
    
    // Check for duplicates
    if(state.checkpoints.some(cp => cp.area === area && cp.detail === detail)){
        alert('Checkpoint dengan nama dan detail yang sama sudah ada.');
        return;
    }

    state.checkpoints.unshift({
      id: uid('cp'),
      area: area,
      detail: detail
    });
    
    refs.qrAreaName.value = '';
    refs.qrAreaDetail.value = '';
    renderCheckpointList();
    alert('Checkpoint berhasil disimpan!');
  });


  // ----- QR SCANNING LOGIC (Improved with Overlay) -----
  let scanning=false, streamRef=null;
  const canvasForScan = document.createElement('canvas'), ctxForScan = canvasForScan.getContext('2d');
  const video = refs.cameraVideo;

  async function startCameraScan(callback) {
    if(scanning) return;
    refs.cameraOverlay.classList.remove('hidden');
    refs.cameraStatus.textContent = 'Memuat kamera...';

    try {
        const constraints = { 
            video: { 
                facingMode: 'environment', 
                width: { ideal: 1280 }, 
                height: { ideal: 720 } 
            }, 
            audio: false 
        };
        const stream = await navigator.mediaDevices.getUserMedia(constraints);
        streamRef = stream;
        video.srcObject = stream;
        video.setAttribute('playsinline', true);
        video.play();

        scanning = true;
        refs.cameraStatus.textContent = 'Scanning...';
        
        let requestId;

        function tick() {
            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                canvasForScan.height = video.videoHeight;
                canvasForScan.width = video.videoWidth;
                ctxForScan.drawImage(video, 0, 0, canvasForScan.width, canvasForScan.height);
                
                // Get image data from a central 2/3rds area (where the QR frame is)
                const cropX = canvasForScan.width / 6;
                const cropY = canvasForScan.height / 6;
                const cropW = canvasForScan.width * 2 / 3;
                const cropH = canvasForScan.height * 2 / 3;

                const imageData = ctxForScan.getImageData(cropX, cropY, cropW, cropH);
                
                const code = window.jsQR(imageData.data, imageData.width, imageData.height, {
                    inversionAttempts: "dontInvert",
                });

                if (code) {
                    cancelAnimationFrame(requestId);
                    scanning = false;
                    stopCameraScan();
                    refs.cameraOverlay.classList.add('hidden');
                    callback(code.data);
                    return;
                }
            }
            requestId = requestAnimationFrame(tick);
        }
        
        video.onloadedmetadata = () => {
            requestId = requestAnimationFrame(tick);
        };

    } catch (err) {
        refs.cameraStatus.textContent = 'ERROR: ' + (err.message || 'Gagal akses kamera.');
        console.error(err);
        stopCameraScan();
        refs.cameraOverlay.classList.add('hidden');
        showAlert('Error Kamera', 'Gagal mengakses kamera: ' + (err.message || 'Periksa izin kamera Anda.'));
    }
  }

  function stopCameraScan() {
    if (streamRef) {
        streamRef.getTracks().forEach(track => track.stop());
        streamRef = null;
    }
    video.srcObject = null;
    scanning = false;
  }
  
  refs.cameraClose.onclick = () => {
    stopCameraScan();
    refs.cameraOverlay.classList.add('hidden');
  };

  refs.btnScanAreaQR.addEventListener('click', () => {
    startCameraScan(handleScanResult);
  });
  
  // Simple QR Scan on Checkpoint Tab (old method for simplicity)
  refs.btnStartScan.addEventListener('click', () => {
    if(scanning) return;
    refs.scanResult.textContent = 'Scanning...';
    startCameraScan(handleScanResultSimple);
    refs.btnStartScan.textContent = 'Stop Camera';
    refs.btnStartScan.onclick = stopScanSimple;
  });

  function stopScanSimple() {
    stopCameraScan();
    refs.scanResult.textContent = 'Hasil scan: —';
    refs.btnStartScan.textContent = 'Start Scan Camera';
    refs.btnStartScan.onclick = () => {
        if(scanning) return;
        refs.scanResult.textContent = 'Scanning...';
        startCameraScan(handleScanResultSimple);
        refs.btnStartScan.textContent = 'Stop Camera';
    };
  }
  refs.btnStopScan.addEventListener('click', stopScanSimple);

  function handleScanResult(data) {
    try {
      const json = JSON.parse(data);
      if (json.area) {
        // Automatically add area
        const lastGps = state.gpsPath.length ? state.gpsPath.slice(-1)[0] : {};
        state.areas.unshift({
          id: uid('area'),
          name: json.area.trim(),
          detail: json.detail ? json.detail.trim() : 'via QR Scan',
          lat: lastGps.lat || null,
          lon: lastGps.lon || null,
          ts: lastGps.timestamp || (new Date()).getTime(),
          description: `Checkpoint Scanned: ${json.area} - ${json.detail}`,
          photos: []
        });
        renderAreas();
        showAlert('QR Scan Berhasil', `Area: ${json.area} berhasil ditambahkan!`);
      } else {
        showAlert('QR Scan Gagal', 'Data QR bukan format Area yang valid.');
      }
    } catch (e) {
      showAlert('QR Scan Gagal', 'Data QR tidak dapat diparse sebagai JSON atau kosong.');
    }
  }

  function handleScanResultSimple(data) {
    refs.scanResult.textContent = `Hasil scan: ${data}`;
    stopScanSimple();
    try {
      const json = JSON.parse(data);
      if (json.area) {
        showAlert('QR Scan Checkpoint', `Area: ${json.area}\nDetail: ${json.detail || '-'}`);
      }
    } catch (e) {
        // ignore - not a checkpoint QR
    }
  }

  // Scan from File/Gallery
  refs.btnFileScan.addEventListener('click', () => {
    if(!state.isAdmin) return;
    refs.fileScanInput.click();
  });
  
  refs.fileScanInput.onchange = (e) => {
    if (e.target.files.length === 0) return;
    const file = e.target.files[0];
    const reader = new FileReader();
    
    reader.onload = (event) => {
      const img = new Image();
      img.onload = () => {
        canvasForScan.width = img.width;
        canvasForScan.height = img.height;
        ctxForScan.drawImage(img, 0, 0, img.width, img.height);
        
        const imageData = ctxForScan.getImageData(0, 0, img.width, img.height);
        const code = window.jsQR(imageData.data, imageData.width, imageData.height);
        
        if (code) {
          handleScanResultSimple(code.data);
        } else {
          showAlert('Scan File Gagal', 'Tidak ditemukan QR code dalam gambar ini.');
        }
      };
      img.src = event.target.result;
    };
    reader.readAsDataURL(file);
    e.target.value = null; // Clear input
  };
  
  // ----- SIGNATURE LOGIC -----
  let signaturePad = null;
  const canvas = refs.sigCanvas;
  
  function initSignaturePad() {
    if (window.SignaturePad && canvas) {
      signaturePad = new window.SignaturePad(canvas);
      if (state.signature) {
        signaturePad.fromDataURL(state.signature);
        updateSigPreview(state.signature);
      }
      signaturePad.onEnd = () => {
        // Auto-save on draw end
        state.signature = signaturePad.toDataURL('image/png');
        updateSigPreview(state.signature);
        saveState();
      };
    }
  }
  
  function updateSigPreview(dataUrl) {
    if (dataUrl) {
      refs.sigPreview.innerHTML = `<img src="${dataUrl}" style="width:100%;height:100%;object-fit:contain;"/>`;
    } else {
      refs.sigPreview.innerHTML = '<div style="text-align:center;color:var(--text-muted);font-size:12px;padding-top:10px;">TTD Kosong</div>';
    }
  }

  refs.btnClearSig.addEventListener('click', () => {
    if (signaturePad) {
      signaturePad.clear();
      state.signature = null;
      updateSigPreview(null);
      saveState();
    }
  });

  refs.btnSaveSig.addEventListener('click', () => {
    if (signaturePad.isEmpty()) {
      alert('Tanda tangan masih kosong.');
      return;
    }
    state.signature = signaturePad.toDataURL('image/png');
    updateSigPreview(state.signature);
    saveState();
    alert('Tanda tangan berhasil disimpan!');
  });
  
  // Auto-update sigName
  refs.sigName.value = localStorage.getItem('patrol_sig_name') || '';
  refs.sigName.oninput = () => {
      localStorage.setItem('patrol_sig_name', refs.sigName.value);
  }
  
  // Wait for page load to init signature pad
  window.addEventListener('load', initSignaturePad);
  
  // ----- PDF GENERATION LOGIC -----
  refs.btnGeneratePDF.addEventListener('click', async () => {
    if (state.areas.length === 0) {
      alert('Tidak ada area untuk dibuat PDF.');
      return;
    }
    
    if (!window.jspdf) {
        alert('Library jspdf tidak dimuat. Cek koneksi CDN.');
        return;
    }

    refs.btnGeneratePDF.disabled = true;
    refs.btnGeneratePDF.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating PDF...';

    // jspdf setup
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p', 'mm', 'a4');
    const pageHeight = doc.internal.pageSize.getHeight();
    const pageWidth = doc.internal.pageSize.getWidth();
    const margin = 10;
    const contentWidth = pageWidth - 2 * margin;

    // --- Cover Page ---
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(24);
    doc.setTextColor(2, 6, 23); // dark blue
    doc.text('LAPORAN PATROLI HARIAN', pageWidth / 2, 40, { align: 'center' });
    
    // Logo (placeholder - user would need to set this up)
    const logoText = 'LOGO AREA';
    doc.setFontSize(10);
    doc.setTextColor(150, 150, 150);
    doc.text(logoText, 15, 15);

    // Profile Photo on Cover
    if(state.profilePhoto && state.profilePhoto.url){
        try{
            const imgData = state.profilePhoto.url;
            const photoW = 50;
            const photoH = 60;
            doc.addImage(imgData, 'JPEG', pageWidth - margin - photoW, 20, photoW, photoH);
        } catch(e) {
            console.warn('Profile photo add failed', e);
        }
    }

    // Patrol Details
    const officerNameVal = refs.officerName.value || 'NAMA PETUGAS BELUM DIISI';
    const shiftVal = refs.shift.value || 'SHIFT BELUM DIISI';
    const dateVal = refs.date.value || new Date().toISOString().slice(0, 10);
    const waktu = new Date().toLocaleTimeString();
    const lokasiHeader = refs.manualLokasi.value || refs.coords.textContent.replace('Koordinat Terkini: ', '') || 'LOKASI GPS/MANUAL BELUM DIISI';

    const leftX = margin;
    const leftY = 60;
    const leftWidth = 100;
    
    const dataRows = [
        {label: 'Petugas', value: officerNameVal},
        {label: 'Tanggal', value: dateVal},
        {label: 'Shift', value: shiftVal},
        {label: 'Jam', value: waktu},
        {label: 'Lokasi', value: lokasiHeader}
    ];

    doc.setFontSize(11);
    let dataY = leftY + 15;
    const rowHeight = 8; 

    dataRows.forEach(row => {
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(0, 0, 0);
        doc.text(`${row.label}:`, leftX + 2, dataY);
        doc.setFont('helvetica', 'normal');
        doc.text(row.value, leftX + 25, dataY);
        doc.setDrawColor(200, 200, 200);
        doc.line(leftX, dataY + 1, leftX + leftWidth, dataY + 1);
        dataY += rowHeight;
    });

    // Main Content Title
    doc.setFontSize(16);
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(2, 6, 23);
    doc.text('DAFTAR AREA PATROLI', margin, dataY + 20);

    let cursorY = dataY + 30;

    // --- Area Pages ---
    for (const area of state.areas) {
      const areaTitle = `${area.name} ${area.detail ? `(${area.detail})` : ''}`;
      
      // Check for new page
      if (cursorY + 40 > pageHeight - margin) {
        doc.addPage();
        cursorY = margin;
      }
      
      // Area Header
      doc.setFontSize(14);
      doc.setFont('helvetica', 'bold');
      doc.setTextColor(10, 20, 100);
      doc.text(areaTitle, margin, cursorY + 5);
      
      doc.setFontSize(9);
      doc.setFont('helvetica', 'normal');
      doc.setTextColor(150, 150, 150);
      doc.text(`Koordinat: ${area.lat ? area.lat.toFixed(6) + ', ' + area.lon.toFixed(6) : '-'} | Waktu: ${area.ts ? new Date(area.ts).toLocaleString() : '-'}`, margin, cursorY + 10);
      
      cursorY += 15;

      // Area Description
      doc.setFontSize(10);
      doc.setTextColor(50, 50, 50);
      doc.setFont('helvetica', 'normal');
      const textLines = doc.splitTextToSize(area.description || '— Tidak ada deskripsi —', contentWidth);
      doc.text(textLines, margin, cursorY);
      cursorY += textLines.length * 4; // 4mm per line

      // Photos
      if (area.photos.length > 0) {
          doc.setFontSize(10);
          doc.setFont('helvetica', 'bold');
          doc.setTextColor(2, 6, 23);
          doc.text('Dokumentasi:', margin, cursorY + 5);
          cursorY += 10;
          
          let photoX = margin;
          const photoW = 40;
          const photoH = 30;
          const photoDescOffset = photoH + 2;

          for (const photo of area.photos) {
              try {
                  // Check if photo fits on current row/page
                  const descLines = doc.splitTextToSize(photo.desc || '-', photoW);
                  const descHeight = descLines.length * 4;
                  const itemHeight = photoH + 5 + descHeight;

                  if (cursorY + itemHeight > pageHeight - margin) {
                      doc.addPage();
                      cursorY = margin;
                      photoX = margin; // Reset X position for new page
                  }

                  if (photoX + photoW > pageWidth - margin) {
                      photoX = margin;
                      cursorY += itemHeight; 
                      
                      // Check new page again after moving down
                      if (cursorY + itemHeight > pageHeight - margin) {
                          doc.addPage();
                          cursorY = margin;
                      }
                  }

                  // Add Image
                  doc.addImage(photo.url, 'JPEG', photoX, cursorY, photoW, photoH);
                  
                  // Add Description & Metadata
                  doc.setFontSize(8);
                  doc.setTextColor(50, 50, 50);
                  doc.setFont('helvetica', 'bold');
                  doc.text(descLines, photoX, cursorY + photoDescOffset);
                  
                  doc.setFont('helvetica', 'normal');
                  doc.setFontSize(7);
                  const metaText = `${photo.lat ? photo.lat.toFixed(4) + ', ' + photo.lon.toFixed(4) : '-'} @ ${photo.ts ? new Date(photo.ts).toLocaleTimeString() : '-'}`;
                  doc.text(metaText, photoX, cursorY + photoDescOffset + descHeight + 1);

                  photoX += photoW + 5; // Move X for next photo
              } catch (e) {
                  console.warn('Gagal memproses foto:', photo.id, e);
                  // Optionally add a placeholder
                  doc.text('[Gagal Memuat Foto]', photoX, cursorY + 15);
                  photoX += photoW + 5;
              }
          }
          cursorY += photoH + 5 + doc.splitTextToSize(area.photos.slice(-1)[0].desc || '-', photoW).length * 4; // Move cursorY past the last photo row
      }
      
      // Separator Line
      if (cursorY < pageHeight - margin - 5) {
          doc.setDrawColor(200, 200, 200);
          doc.setLineWidth(0.3);
          doc.line(margin, cursorY + 5, margin + contentWidth, cursorY + 5);
          cursorY += 10;
      }
    }

    // --- Signature Page (Always add at the end) ---
    doc.addPage();
    doc.setFontSize(16);
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(2, 6, 23);
    doc.text('TANDA TANGAN PETUGAS', pageWidth / 2, 40, { align: 'center' });

    if(state.signature){
        try{
            const sigWidth = 80;
            const sigHeight = 40;
            const sigX = (pageWidth - sigWidth) / 2;
            doc.addImage(state.signature, 'PNG', sigX, 55, sigWidth, sigHeight);
        } catch(e) {
            console.warn('Signature add failed', e);
            doc.setFontSize(12);
            doc.setTextColor(150, 150, 150);
            doc.text('(Tanda Tangan Gagal Dimuat)', pageWidth / 2, 75, { align: 'center' });
        }
    } else {
        doc.setFontSize(12);
        doc.setTextColor(150, 150, 150);
        doc.text('(Tidak ada tanda tangan tersimpan)', pageWidth / 2, 75, { align: 'center' });
    }

    const lineY = 55 + 40 + 10;
    doc.setDrawColor(0, 0, 0);
    doc.setLineWidth(0.7);
    doc.line(pageWidth / 2 - 40, lineY, pageWidth / 2 + 40, lineY);
    
    doc.setFontSize(12);
    doc.setTextColor(0, 0, 0);
    const nameToPrint = refs.sigName.value || officerNameVal;
    doc.text(nameToPrint, pageWidth / 2, lineY + 5, { align: 'center' });
    doc.setFontSize(10);
    doc.setTextColor(50, 50, 50);
    doc.text('Petugas Lapangan', pageWidth / 2, lineY + 10, { align: 'center' });

    // Finalize and Save
    doc.save(`Laporan-Patroli-${officerNameVal.replace(/\s/g, '_')}-${dateVal}.pdf`);

    refs.btnGeneratePDF.disabled = false;
    refs.btnGeneratePDF.innerHTML = 'Generate PDF';
  });

  // ----- DEEP CLEAN-UP LOGIC -----
  function doDeepClean(){
    state.areas = [];
    state.checkpoints = [];
    state.gpsPath = [];
    state.signature = null;
    state.profilePhoto = null;
    state.isAdmin = false;
    
    try{
      localStorage.removeItem('patrol_state');
      localStorage.removeItem('patrol_admin_password');
      localStorage.removeItem('patrol_sig_name');
      localStorage.removeItem('patrol_uid');
      // Attempt to clear all relevant input fields (for a clean slate)
      const ids = [
        'areasContainer','qrCanvasManual','sigPreview','sigCanvas', 
        'qrAreaName','qrAreaDetail','manualLokasi','officerName', 
        'shift','date','newAreaName','newAreaDetail','adminPass','sigName',
        'coords'
      ];
      ids.forEach(id=>{
        const el = document.getElementById(id);
        if(!el) return;
        if(el.tagName === 'CANVAS'){
          if(window.signaturePad) signaturePad.clear();
          else el.getContext('2d').clearRect(0,0,el.width,el.height);
        } else if(el.tagName === 'DIV' || el.tagName === 'SPAN'){
          el.innerHTML = (id === 'coords') ? '—' : '';
        } else {
          try{ el.value = ''; } catch(e){}
        }
      });
      // Clear QR canvas explicitly
      if(window.qrManual) qrManual.set({ value: '' });

    } catch(e){
        console.error('Deep Clean partial failure:', e);
    }
    
    renderAreas();
    renderCheckpointList();
    renderProfilePhoto();
    updateModeUI();
    showAlert('Deep Clean Berhasil', 'Semua data lokal telah dihapus. Aplikasi kembali ke kondisi awal.');
  }

  refs.btnDeepClean.addEventListener('click', ()=>{
    if(state.isAdmin){
      if(confirm('PERINGATAN! Anda yakin ingin menghapus SEMUA DATA APLIKASI secara permanen? Tindakan ini tidak dapat dibatalkan.')){
        doDeepClean();
      }
    } else {
        alert('Hanya Admin yang dapat melakukan Deep Clean.');
    }
  });

  refs.btnDeepCancel.addEventListener('click', () => {
    // Simply close the tab
    showTab('area');
  });
  
  // ----- PHOTO PROFILE LOGIC -----
  
  // Helper to trigger file input (camera or gallery)
  function createFileInput({allowGallery, multiple}){
      return new Promise((resolve) => {
          const input = document.createElement('input');
          input.type = 'file';
          input.accept = 'image/*';
          input.multiple = multiple;
          
          if (!allowGallery) {
              input.capture = 'environment';
          }
          
          input.onchange = (e) => {
              resolve({ files: Array.from(e.target.files) });
              input.remove(); // Clean up
          };
          
          input.click();
      });
  }

  refs.btnTakeProfilePhoto.addEventListener('click', async () => {
    try {
      const result = await createFileInput({allowGallery: false, multiple: false});
      if (result.files.length > 0) {
        const file = result.files[0];
        // Upload immediately to Cloudinary
        refs.btnTakeProfilePhoto.disabled = true;
        refs.btnTakeProfilePhoto.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading...';
        
        if (!window.uploadToCloudinary) {
             showAlert('Error Upload', 'Fungsi upload (Cloudinary) tidak tersedia.');
             refs.btnTakeProfilePhoto.disabled = false;
             refs.btnTakeProfilePhoto.innerHTML = 'Ambil Foto (Kamera)';
             return;
        }

        const uploadedUrl = await window.uploadToCloudinary(file);
        
        // Revoke old URL if exists
        if(state.profilePhoto) revoke(state.profilePhoto.url);

        state.profilePhoto = { url: uploadedUrl, ts: Date.now() };
        renderProfilePhoto();
        showAlert('Foto Profil Berhasil', 'Foto profil berhasil diambil dan diupload!');
        
      }
    } catch (e) {
      showAlert('Gagal Foto Profil', 'Gagal mengambil/mengupload foto: ' + (e.message || e));
    } finally {
      refs.btnTakeProfilePhoto.disabled = false;
      refs.btnTakeProfilePhoto.innerHTML = 'Ambil Foto (Kamera)';
    }
  });

  refs.btnUploadProfilePhoto.addEventListener('click', async () => {
    if(!state.isAdmin) return;
    try {
      const result = await createFileInput({allowGallery: true, multiple: false});
      if (result.files.length > 0) {
        const file = result.files[0];
        
        refs.btnUploadProfilePhoto.disabled = true;
        refs.btnUploadProfilePhoto.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading...';
        
        if (!window.uploadToCloudinary) {
             showAlert('Error Upload', 'Fungsi upload (Cloudinary) tidak tersedia.');
             refs.btnUploadProfilePhoto.disabled = false;
             refs.btnUploadProfilePhoto.innerHTML = 'Pilih dari Galeri';
             return;
        }
        
        const uploadedUrl = await window.uploadToCloudinary(file);
        
        // Revoke old URL if exists
        if(state.profilePhoto) revoke(state.profilePhoto.url);

        state.profilePhoto = { url: uploadedUrl, ts: Date.now() };
        renderProfilePhoto();
        showAlert('Foto Profil Berhasil', 'Foto profil berhasil diupload!');
      }
    } catch (e) {
      showAlert('Gagal Foto Profil', 'Gagal upload foto: ' + (e.message || e));
    } finally {
      refs.btnUploadProfilePhoto.disabled = false;
      refs.btnUploadProfilePhoto.innerHTML = 'Pilih dari Galeri';
    }
  });

  refs.btnRemoveProfilePhoto.addEventListener('click', () => {
    if (state.profilePhoto) {
      revoke(state.profilePhoto.url);
      state.profilePhoto = null;
      renderProfilePhoto();
      showAlert('Foto Profil Dihapus', 'Foto profil telah dihapus!');
    }
  });


  // ----- CHAT / MESSAGING LOGIC (FIXED with Firebase ready check) -----
  async function initChat() {
    // Tunggu Firebase siap
    try {
        await waitForFirebase();
        console.log('🔥 Firebase ready, initializing chat...');
    } catch(e) {
        console.error('Chat init failed: Firebase not ready', e);
        return; // Stop if Firebase is not ready
    }

    const chatRef = firebase.database().ref('live_chat');
    const localUid = getLocalUid();
    const officerName = refs.officerName.value || 'Anonymous User';

    // Toggle chat panel
    refs.chatBubble.addEventListener('click', () => {
      state.chatOpen = !state.chatOpen;
      if (state.chatOpen) {
        refs.chatPanel.classList.remove('hidden');
        state.unreadCount = 0;
        updateChatBubble();
        // Scroll to bottom immediately on open
        setTimeout(() => {
          refs.chatMessages.scrollTop = refs.chatMessages.scrollHeight;
          markMessagesAsDelivered();
        }, 100);
      } else {
        refs.chatPanel.classList.add('hidden');
      }
    });

    // Close chat panel
    refs.chatClose.addEventListener('click', () => {
      state.chatOpen = false;
      refs.chatPanel.classList.add('hidden');
    });

    // Send message
    refs.chatSend.addEventListener('click', sendMessage);
    refs.chatInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') sendMessage();
    });

    function sendMessage() {
      const text = refs.chatInput.value.trim();
      if (!text) return;

      const message = {
        uid: localUid,
        name: refs.officerName.value || 'Petugas Patroli',
        text: text,
        timestamp: firebase.database.ServerValue.TIMESTAMP
      };

      chatRef.push(message)
        .then(() => {
          refs.chatInput.value = '';
          // Force scroll to bottom immediately after sending
          refs.chatMessages.scrollTop = refs.chatMessages.scrollHeight;
        })
        .catch(e => {
          console.error('Send message failed:', e);
          showAlert('Error Chat', 'Gagal mengirim pesan: ' + e.message);
        });
    }

    function updateChatBubble() {
      if (state.unreadCount > 0) {
        refs.chatBubble.classList.add('has-new');
        refs.chatBubble.title = `Chat Baru (${state.unreadCount})`;
      } else {
        refs.chatBubble.classList.remove('has-new');
        refs.chatBubble.title = 'Buka Chat/Laporan Cepat';
      }
    }

    function appendMessage(key, message) {
      // Prevent duplicate messages in UI
      if (document.getElementById(`msg-${key}`)) return;

      const messageDiv = document.createElement('div');
      messageDiv.id = `msg-${key}`;
      messageDiv.dataset.messageId = key;
      messageDiv.className = 'chat-message';
      messageDiv.classList.add(message.uid === localUid ? 'own' : 'other');

      const nameText = message.uid === localUid ? 'Anda' : message.name;
      const time = new Date(message.timestamp).toLocaleTimeString();
      
      messageDiv.innerHTML = `
        <div style="font-weight:700">${nameText}</div>
        <div>${message.text}</div>
        <div class="chat-meta">${time}</div>
      `;

      if (message.uid !== localUid && state.chatOpen) {
          messageDiv.classList.add('delivered');
      }

      refs.chatMessages.appendChild(messageDiv);
      
      // Keep scroll at bottom if already close to it, or if it's the user's own message
      const shouldScroll = refs.chatMessages.scrollTop + refs.chatMessages.clientHeight >= refs.chatMessages.scrollHeight - 50 || message.uid === localUid;
      if (shouldScroll) {
        refs.chatMessages.scrollTop = refs.chatMessages.scrollHeight;
      }
    }

    function markMessagesAsDelivered() {
      const messages = refs.chatMessages.querySelectorAll('.chat-message:not(.own):not(.delivered)');
      messages.forEach(messageDiv => {
        const messageId = messageDiv.dataset.messageId;
        if (messageId) {
          // Mark as delivered in Firebase
          firebase.database().ref(`chat_delivered/${messageId}/${localUid}`).set(Date.now());
          messageDiv.classList.add('delivered');
        }
      });
    }

    function showNotification(message) {
        // Only show notification for incoming messages when chat is not open or tab is not focused
        if (message.uid === localUid || state.chatOpen && document.hasFocus()) return; 

        // 1. Browser Notification (Requires user permission)
        if (document.hidden && 'Notification' in window && Notification.permission === 'granted') {
            new Notification(`Pesan dari ${message.name}`, { 
                body: message.text, 
                icon: '/favicon.ico' 
            });
        } else {
            // 2. Subtle In-Page Notification
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed; top: 20px; right: 20px; 
                background: var(--primary); color: white; 
                padding: 12px 16px; border-radius: 8px; 
                box-shadow: 0 4px 12px rgba(0,0,0,0.15); 
                z-index: 10001; max-width: 300px; word-wrap: break-word;
                transition: opacity 0.5s ease;
            `;
            notification.innerHTML = `
                <strong style="display:block;margin-bottom:4px;">${message.name}</strong>
                ${message.text}
            `;
            document.body.appendChild(notification);
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => notification.remove(), 500);
            }, 5000);
        }

        // 3. Vibration if supported
        if ('vibrate' in navigator) {
            navigator.vibrate([200, 100, 200]);
        }
    }


    function listenForChatMessages() {
      // Listen for initial data and subsequent children being added
      chatRef.limitToLast(50).on('child_added', (snapshot) => {
        const message = snapshot.val();
        const key = snapshot.key;
        
        appendMessage(key, message);

        if (message.uid !== localUid) {
          // New message from others
          if (!state.chatOpen) {
            state.unreadCount++;
            updateChatBubble();
            showNotification(message);
          }
        }
      }, (error) => {
        console.error("Firebase Chat Read Error:", error);
      });
    }
    
    // Start listening
    listenForChatMessages();

    console.log('✅ Chat system initialized');
  }

  // Cloudinary Upload Utility (using XMLHttpRequest for better compatibility/control)
  window.uploadToCloudinary = function(fileOrBlob) {
    const CLOUDINARY_URL = `https://api.cloudinary.com/v1_1/${window.CLOUDINARY.cloudName}/upload`;
    const CLOUDINARY_UPLOAD_PRESET = window.CLOUDINARY.uploadPreset;
    const retries = 3;

    return new Promise((resolve, reject) => {
      const fd = new FormData();
      fd.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
      fd.append('tags', 'browser_upload');
      fd.append('file', fileOrBlob);

      function attemptUpload(attempt) {
        const xhr = new XMLHttpRequest();
        xhr.timeout = 30000; // 30 second timeout
        xhr.open('POST', CLOUDINARY_URL, true);
        
        xhr.onreadystatechange = function() {
          if(xhr.readyState == 4) {
            if(xhr.status == 200) {
              try{
                var res = JSON.parse(xhr.responseText);
                resolve(res.secure_url);
              } catch(e) {
                if (attempt < retries) {
                  console.log(`Retry upload attempt ${attempt + 1}`);
                  setTimeout(() => attemptUpload(attempt + 1), 1000 * attempt);
                } else {
                  reject(e);
                }
              }
            } else {
              if (attempt < retries) {
                console.log(`Retry upload attempt ${attempt + 1}`);
                setTimeout(() => attemptUpload(attempt + 1), 1000 * attempt);
              } else {
                reject(xhr.responseText || xhr.status);
              }
            }
          }
        };

        xhr.ontimeout = function() {
          if (attempt < retries) {
            console.log(`Retry upload attempt ${attempt + 1} (timeout)`);
            setTimeout(() => attemptUpload(attempt + 1), 1000 * attempt);
          } else {
            reject('Upload timeout');
          }
        };
        
        xhr.send(fd);
      }

      attemptUpload(1);
    });
  };

  // ----- EXPERT MODULE LOGIC (Worker/Offline) -----

  // OCR and Object Detection for "Offline" Expert Module (requires external libraries/worker)
  // This section relies on external services/libs and is often the source of errors.

  async function callWorkerApi({imageUrl, areaIdx, photoIdx, opts={}}){
    if(!WORKER_URL) throw new Error('WORKER_URL belum dikonfigurasi. Ganti konstanta WORKER_URL di file HTML.');
    
    // fetch image blob and convert to base64
    const resp = await fetch(imageUrl, { mode: 'cors' });
    if(!resp.ok) throw new Error('Gagal ambil image blob: ' + resp.status);
    const blob = await resp.blob();

    const base64 = await new Promise((res, rej)=>{
      const fr = new FileReader();
      fr.onload = ()=> {
        const idx = fr.result.indexOf(',');
        res(fr.result.slice(idx+1));
      };
      fr.onerror = rej;
      fr.readAsDataURL(blob);
    });

    const payload = {
      imageBase64: base64,
      metadata: { areaIdx, photoIdx, opts, ts: Date.now() }
    };

    const controller = new AbortController();
    const id = setTimeout(()=> controller.abort(), TIMEOUT_MS);

    try{
      const r = await fetch(WORKER_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
        signal: controller.signal
      });
      clearTimeout(id);

      if(!r.ok){
        const t = await r.text().catch(()=>null);
        throw new Error('Worker responded ' + r.status + ' ' + (t||''));
      }

      const j = await r.json().catch(()=>{ throw new Error('Response worker bukan JSON'); });
      if(j.success === false) throw new Error(j.error || 'Worker mengembalikan success:false');

      const text = j.text || j.hasil || j.result || '';
      return { text };
      
    }catch(err){
      if(err.name === 'AbortError') throw new Error('Timeout: worker tidak merespon dalam ' + (TIMEOUT_MS/1000) + 's');
      throw err;
    }
  };

  // Expert Modal Implementation (simplified for final output)
  function showExpertModal(areaIdx, photoIdx) {
    if (!state.isAdmin) return;
    const area = state.areas[areaIdx];
    const photo = area.photos[photoIdx];

    if(!photo || !photo.url) {
        return showAlert('Error Expert', 'Foto belum diupload atau tidak ditemukan.');
    }

    // Modal structure
    const modal = document.createElement('div');
    modal.className = 'modal-backdrop';
    modal.style.display = 'flex';
    modal.style.alignItems = 'flex-start';
    modal.style.paddingTop = '5vh';
    
    const modalContent = document.createElement('div');
    modalContent.className = 'card';
    modalContent.style.maxWidth = '600px';
    modalContent.style.width = '94%';
    modalContent.style.boxShadow = '0 10px 30px rgba(0, 0, 0, 0.5)';

    modalContent.innerHTML = `
      <h3 style="margin-top:0;color:var(--accent);border-bottom:1px solid var(--border);padding-bottom:10px;">
        <i class="fas fa-brain"></i> Expert Module: ${area.name} (${area.detail || '-'})
      </h3>
      <div id="expertCard" style="max-height: 70vh; overflow-y: auto; padding: 0 10px;">
        
        <div style="display:flex;gap:15px;flex-wrap:wrap;align-items:flex-start">
            <img src="${photo.url}" style="width:200px; height:150px; object-fit:cover; border-radius:8px; border:2px solid var(--border);" alt="Photo Preview"/>
            <div style="flex:1">
              <p class="muted" style="margin-top:0;"><strong>Foto Terbaru:</strong> ${photo.desc || '—'}</p>
              <div id="expertRoles" style="padding:10px;border:1px solid var(--primary);border-radius:8px;margin-bottom:15px;">
                <label style="margin-bottom:5px;">Pilih Peran Ahli:</label>
                <div id="roleList" class="expert-list" style="display:grid;grid-template-columns: 1fr 1fr; gap:8px;">
                  </div>
              </div>
            </div>
        </div>

        <label style="margin-top:10px;">Pilih Kalimat Deskripsi Otomatis:</label>
        <div id="expertSentences" style="border:1px solid var(--border);border-radius:8px;padding:10px;margin-top:5px;background:#00000033;">
          </div>

        <div style="display:flex;gap:8px;justify-content:space-between;align-items:center;margin-top:15px;">
            <button id="checkAllBtn" class="btn ghost small" style="padding:5px 10px;">Pilih Semua</button>
            <button id="uncheckAllBtn" class="btn ghost small" style="padding:5px 10px;">Hapus Pilihan</button>
        </div>
        
        <div style="margin-top:15px;padding-top:15px;border-top:1px solid var(--border);">
            <div style="font-weight:700;margin-bottom:8px;color:var(--primary);">AI Analysis & Report Generation:</div>
            <p id="workerStatus" class="muted">Status: Siap untuk Generate Report</p>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <button id="btnGenWorker" class="btn" style="background:linear-gradient(135deg, var(--accent), #00cc66);color:black;">
                <i class="fas fa-cloud-upload-alt"></i> Upload & Generate (Worker API)
              </button>
              <button id="btnCopyPrompt" class="btn ghost" title="Salin Prompt untuk Gemini/ChatGPT">
                <i class="fas fa-copy"></i> Salin Prompt (Manual AI)
              </button>
            </div>
        </div>

      </div>
      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:20px;padding-top:10px;border-top:1px solid var(--border);">
        <button id="applyBtn" class="btn">Terapkan Deskripsi</button>
        <button id="cancelBtn" class="btn danger ghost">Tutup</button>
      </div>
    `;

    document.body.appendChild(modal);
    modal.appendChild(modalContent);
    
    const roleList = modalContent.querySelector('#roleList');
    Object.entries(EXPERT_ROLES_DB).forEach(([key, description]) => {
      const div = document.createElement('div');
      div.className = 'expert-item';
      div.innerHTML = `<input type="checkbox" id="role_${key}" checked> <label for="role_${key}" style="display:inline;font-weight:normal;cursor:pointer;">${description.split('—')[0].trim()}</label>`;
      roleList.appendChild(div);
    });

    const sentenceContainer = modalContent.querySelector('#expertSentences');
    Object.keys(EXPERT_SENTENCES_DB).forEach((category, catIndex) => {
      const categoryDiv = document.createElement('div');
      categoryDiv.innerHTML = `<h4 style="margin:8px 0;color:var(--secondary);text-transform:uppercase;">${category.replace('_', ' ')}</h4>`;
      EXPERT_SENTENCES_DB[category].forEach((sentence, idx) => {
        const div = document.createElement('div');
        div.className = 'expert-item';
        div.style.marginBottom = '5px';
        div.innerHTML = `<input type="checkbox" id="sent_${catIndex}_${idx}" checked> <label for="sent_${catIndex}_${idx}" style="display:inline;font-weight:normal;cursor:pointer;font-size:14px;">${sentence}</label>`;
        categoryDiv.appendChild(div);
      });
      sentenceContainer.appendChild(categoryDiv);
    });

    const workerStatus = modalContent.querySelector('#workerStatus');
    const checkAllBtn = modalContent.querySelector('#checkAllBtn');
    const uncheckAllBtn = modalContent.querySelector('#uncheckAllBtn');
    const applyBtn = modalContent.querySelector('#applyBtn');
    const cancelBtn = modalContent.querySelector('#cancelBtn');
    const btnGenWorker = modalContent.querySelector('#btnGenWorker');
    const btnCopyPrompt = modalContent.querySelector('#btnCopyPrompt');

    checkAllBtn.onclick = () => {
      modalContent.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = true);
    };

    uncheckAllBtn.onclick = () => {
      modalContent.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
    };

    cancelBtn.onclick = () => {
      document.body.removeChild(modal);
    };

    applyBtn.onclick = () => {
      const selectedSentences = [];
      const selectedRoles = [];

      // Collect selected roles
      Object.keys(EXPERT_ROLES_DB).forEach(key => {
        const checkbox = modalContent.querySelector(`#role_${key}`);
        if (checkbox && checkbox.checked) {
          selectedRoles.push(EXPERT_ROLES_DB[key].split('—')[0].trim());
        }
      });
      
      // Collect selected sentences
      Object.keys(EXPERT_SENTENCES_DB).forEach((category, catIndex) => {
        EXPERT_SENTENCES_DB[category].forEach((sentence, idx) => {
          const checkbox = modalContent.querySelector(`#sent_${catIndex}_${idx}`);
          if (checkbox && checkbox.checked) {
            selectedSentences.push(sentence);
          }
        });
      });

      if (selectedSentences.length === 0 && selectedRoles.length === 0) {
        alert('Pilih minimal satu kalimat atau satu peran ahli.');
        return;
      }
      
      let finalDesc = '';
      if(selectedRoles.length > 0) {
          finalDesc += 'Expert Roles: ' + selectedRoles.join(' • ') + '\n\n';
      }
      if(selectedSentences.length > 0) {
          finalDesc += selectedSentences.join('\n');
      }

      // Get current description
      let currentDesc = photo.desc || '';
      // Combine with existing if any
      if (currentDesc.trim()) {
        photo.desc = currentDesc + '\n\n' + finalDesc;
      } else {
        photo.desc = finalDesc;
      }

      // Update UI
      renderAreas();
      alert(`Deskripsi expert ditambahkan ke foto!`);
      document.body.removeChild(modal);
    };

    // Worker API Generator
    btnGenWorker.onclick = async () => {
      if (!WORKER_URL) return showAlert('Error', 'Worker API URL belum dikonfigurasi. Silakan gunakan opsi Salin Prompt.');
      if (photo.type !== 'photo') return showAlert('Error', 'Fitur Worker API hanya mendukung upload foto (JPG/PNG).');

      const selectedRoles = [];
      modalContent.querySelectorAll('#roleList input[type="checkbox"]:checked').forEach(cb => {
          selectedRoles.push(cb.id.replace('role_', ''));
      });
      if (selectedRoles.length === 0) return showAlert('Pilih Peran', 'Pilih minimal satu peran ahli sebelum generate report.');
      
      workerStatus.textContent = 'Status: Mengirim data ke Worker API...';
      btnGenWorker.disabled = true;

      try {
          const result = await callWorkerApi({
              imageUrl: photo.url,
              areaIdx,
              photoIdx,
              opts: { 
                  roles: selectedRoles,
                  description: area.description || photo.desc || 'No context',
                  location: `${area.name} (${area.detail})`
              }
          });
          
          workerStatus.textContent = 'Status: Analisis selesai. Menerapkan hasil.';

          // Apply result (assumes worker returns final text in result.text)
          if(result.text){
              let currentDesc = photo.desc || '';
              // Combine with existing if any
              if (currentDesc.trim()) {
                photo.desc = currentDesc + '\n\n[AUTO-GENERATED REPORT]\n' + result.text;
              } else {
                photo.desc = '[AUTO-GENERATED REPORT]\n' + result.text;
              }
              renderAreas();
              showAlert('Report Berhasil', 'Report Expert AI berhasil digenerate dan ditambahkan ke deskripsi foto!');
          } else {
              showAlert('Report Gagal', 'Worker API tidak mengembalikan teks report.');
          }

      } catch (e) {
          console.error('Worker API Error:', e);
          showAlert('Worker API Error', e.message || 'Gagal terhubung ke Worker API.');
      } finally {
          btnGenWorker.disabled = false;
          btnGenWorker.textContent = '<i class="fas fa-cloud-upload-alt"></i> Upload & Generate (Worker API)';
      }
    };
    
    // Copy Prompt Generator
    btnCopyPrompt.onclick = async function() {
        if (photo.type !== 'photo') return showAlert('Error', 'Fitur Salin Prompt hanya didukung untuk foto (JPG/PNG).');

        const selectedRoles = [];
        modalContent.querySelectorAll('#roleList input[type="checkbox"]:checked').forEach(cb => {
            selectedRoles.push(cb.id.replace('role_', ''));
        });
        if (selectedRoles.length === 0) return showAlert('Pilih Peran', 'Pilih minimal satu peran ahli sebelum generate prompt.');

        // Build the prompt text
        const coords = { lat: photo.lat, lon: photo.lon };
        const metadata = { 
            location: `${area.name} (${area.detail})`,
            description: area.description || photo.desc || 'No context'
        };
        
        // This function builds the text based on the selections and metadata
        const promptText = buildGeminiPrompt(selectedRoles, coords, metadata);

        // Copy and open Gemini/ChatGPT
        try {
            await copyTextToClipboard(promptText);
            const geminiUrl = 'https://gemini.google.com/app?q=' + encodeURIComponent(promptText.substring(0, 2000));
            window.open(geminiUrl, '_blank');
            showAlert('Prompt Berhasil Disalin', 'Prompt telah disalin ke clipboard. Buka Gemini, tempel (paste) prompt, lalu upload foto secara manual.');
        } catch (e) {
            showAlert('Gagal Salin', 'Gagal menyalin prompt. Silakan salin manual dari konsol atau coba lagi.');
            console.error(promptText);
        }
    };
    
    // Close on backdrop click
    modal.onclick = (e) => {
      if (e.target === modal) {
        document.body.removeChild(modal);
      }
    };
  }

  // Helper function to build the prompt for external AI
  function buildGeminiPrompt(roles, coords, metadata) {
      const header = "Anda adalah tim ahli multi-disiplin untuk analisis K3/Keamanan (HSE/Security). Saya akan memberikan FOTO TEMUAN di lapangan. Tugas Anda adalah MENGANALISIS foto tersebut berdasarkan PERAN AHLI yang dipilih di bawah. Berikan output dalam format markdown terstruktur (seperti list atau tabel) yang mencakup: Deskripsi Temuan, Potensi Bahaya (Risiko), Rekomendasi Tindakan Segera, dan Rujukan Hukum/Standar yang Relevan (Contoh: ISO 45001, UU K3).";
      
      const roleNames = roles.map(r => EXPERT_ROLES_DB[r] ? EXPERT_ROLES_DB[r].split('—')[0].trim() : r);
      const indikasi = `KONTEKS LOKASI:\n- Nama Area: ${metadata.location}\n- Deskripsi Patroli: ${metadata.description}\n- Koordinat: ${coords.lat ? coords.lat.toFixed(6)+', '+coords.lon.toFixed(6) : 'Tidak tersedia'}`;

      // Placeholder for causes/risks/recs since analysis is done by the external AI
      const defaultRefs = ['UU No.13 Tahun 2003 tentang Ketenagakerjaan', 'ISO 45001 - Occupational Health and Safety Management Systems', 'Peraturan Pemerintah terkait K3'];
      
      const parts = [
          header, 
          '', 
          'PILIHAN AHLI:', 
          ...roleNames.map(r => '- ' + r), 
          '', 
          'KONTEKS TAMBAHAN:', 
          indikasi, 
          '',
          'FORMAT OUTPUT (Gunakan bahasa Indonesia):',
          '## Analisis Temuan Ahli',
          '### 1. Deskripsi Temuan',
          '- [Temuan utama di foto]',
          '- [Kesesuaian/Ketidaksesuaian dengan standar]',
          '### 2. Potensi Bahaya & Risiko',
          '- [Bahaya/Risiko 1 (contoh: Bahaya tersandung)]',
          '- [Risiko 2 (contoh: Risiko kebakaran)]',
          '### 3. Rekomendasi Tindakan Segera',
          '- [Tindakan 1 (contoh: Isolasi area)]',
          '- [Tindakan 2 (contoh: Kontak teknisi)]',
          '### 4. Rujukan Hukum/Standar Relevan',
          ...defaultRefs.map(r=>'- '+r),
          '',
          '(Report ini harus disimpulkan berdasarkan visual FOTO yang diupload.)'
      ];
      
      return parts.join('\n');
  }

  // Helper function to copy text to clipboard
  async function copyTextToClipboard(text){
    try{
      await navigator.clipboard.writeText(text);
      return true;
    } catch(e) {
      return false;
    }
  }
  
  // Expose state and API for debugging/external use
  window.__patrol_state = state;
  window.__patrol_api = { 
    renderAreas, 
    renderCheckpointList, 
    doDeepClean 
  };

  // Initial render & Chat initialization
  renderAreas();
  renderCheckpointList();
  renderProfilePhoto();
  updateModeUI();
  
  // ✅ Initialize chat setelah semua ready
  setTimeout(() => {
    initChat().catch(e => console.error('Chat init failed:', e));
  }, 1000);

  // compatibility banner (optional - can be removed if not needed)
  (function(){
    const supports = {
      getUserMedia: !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia),
      jsqr: !!window.jsQR,
      fetch: typeof fetch === 'function',
      download: (function(){ const a=document.createElement('a'); return typeof a.download !== 'undefined'; })()
    };
    const banner = document.createElement('div');
    banner.style.position='fixed';
    banner.style.bottom='0';
    banner.style.left='0';
    banner.style.width='100%';
    banner.style.background='rgba(255, 100, 0, 0.9)';
    banner.style.color='white';
    banner.style.padding='5px';
    banner.style.textAlign='center';
    banner.style.fontSize='12px';
    banner.style.zIndex='10000';
    
    let missing = [];
    if (!supports.getUserMedia) missing.push('Camera/Geolocation');
    if (!supports.jsqr) missing.push('jsQR');
    
    if (missing.length > 0) {
        banner.innerHTML = `⚠️ Peringatan: Browser Anda tidak mendukung penuh fitur ini (Missing: ${missing.join(', ')}). Coba di Chrome Mobile/Desktop.`;
        document.body.appendChild(banner);
    }
  })();
})();
/* === PATCH END === */
</script>
</body>
</html>